import{e,M as t,_ as a,O as r,s,c as i}from"./components-D2xqmf-M.js";import{l as n}from"./realtime-vendor-wb7U7u9V.js";import{c as o}from"./react-vendor-DV0l1H4H.js";import{a as c}from"./utils-vendor-4-B_0nFS.js";const l=new class{constructor(){this.cache=new Map,this.metadata=new Map,this.stats={hits:0,misses:0,sets:0,deletes:0,size:0,memoryUsage:0},this.maxSize=1e3,this.maxMemory=52428800,this.cleanupInterval=3e5,this.lastCleanup=Date.now(),this.startCleanupInterval(),this.monitorMemoryUsage()}generateKey(e,t,a={}){return`${e}:${t}:${Object.keys(a).length>0?JSON.stringify(a):""}`}set(e,t,a={}){const{ttl:r=18e5,priority:s="normal",compress:i=!0,namespace:n="default",tags:o=[]}=a,c=this.generateKey(n,e,a.params),l=i&&this.shouldCompress(t)?this.compressData(t):t,u={value:l,compressed:i&&this.shouldCompress(t),timestamp:Date.now(),ttl:r,priority:s,namespace:n,tags:o,accessCount:0,lastAccessed:Date.now(),size:this.calculateSize(l)};return this.cache.size<this.maxSize||this.evictEntries(),this.stats.memoryUsage+u.size>this.maxMemory&&this.evictByMemory(),this.cache.set(c,u),this.metadata.set(c,{created:Date.now(),namespace:n,tags:o,priority:s}),this.stats.sets++,this.stats.size=this.cache.size,this.updateMemoryUsage(),!0}get(e,t={}){const{namespace:a="default",params:r={}}=t,s=this.generateKey(a,e,r),i=this.cache.get(s);return i?this.isExpired(i)?(this.delete(s),this.stats.misses++,null):(i.accessCount++,i.lastAccessed=Date.now(),this.stats.hits++,i.compressed?this.decompressData(i.value):i.value):(this.stats.misses++,null)}invalidate(e={}){const{namespace:t,tags:a=[],pattern:r,priority:s,olderThan:i}=e;let n=0;for(const[o,c]of this.cache.entries())t&&c.namespace!==t||a.length>0&&!a.some((e=>c.tags.includes(e)))||r&&!o.match(r)||s&&c.priority!==s||i&&Date.now()-c.timestamp<i||(this.delete(o),n++);return n}delete(e){const t=this.cache.get(e);t&&(this.stats.memoryUsage-=t.size,this.cache.delete(e),this.metadata.delete(e),this.stats.deletes++,this.stats.size=this.cache.size)}clear(){this.cache.clear(),this.metadata.clear(),this.stats={hits:0,misses:0,sets:0,deletes:0,size:0,memoryUsage:0}}getStats(){const e=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(2):0;return{...this.stats,hitRate:e+"%",efficiency:this.calculateEfficiency(),memoryUsageMB:(this.stats.memoryUsage/1048576).toFixed(2),averageEntrySize:this.stats.size>0?(this.stats.memoryUsage/this.stats.size).toFixed(2):0}}evictEntries(){const e=Array.from(this.cache.entries());e.sort(((e,t)=>{const a={critical:4,high:3,normal:2,low:1},r=a[e[1].priority]||1,s=a[t[1].priority]||1;return r!==s?s-r:e[1].lastAccessed-t[1].lastAccessed}));const t=Math.ceil(.2*e.length);for(let a=0;t>a;a++)this.delete(e[a][0])}evictByMemory(){const e=Array.from(this.cache.entries());e.sort(((e,t)=>e[1].size!==t[1].size?t[1].size-e[1].size:e[1].lastAccessed-t[1].lastAccessed));let t=0;const a=.3*this.maxMemory;for(const[r,s]of e){if(t>=a)break;this.delete(r),t+=s.size}}isExpired(e){return Date.now()-e.timestamp>e.ttl}calculateSize(e){try{return new Blob([JSON.stringify(e)]).size}catch{return 0}}shouldCompress(e){return this.calculateSize(e)>1024}compressData(e){try{return JSON.stringify(e)}catch{return e}}decompressData(e){try{return JSON.parse(e)}catch{return e}}calculateEfficiency(){const e=this.stats.hits+this.stats.misses;return 0===e?0:100*(this.stats.hits/e*.7+.3*(1-this.stats.memoryUsage/this.maxMemory))}monitorMemoryUsage(){"memory"in performance&&setInterval((()=>{const e=performance.memory;e&&e.usedJSHeapSize>this.maxMemory&&this.evictByMemory()}),3e4)}updateMemoryUsage(){this.stats.memoryUsage=Array.from(this.cache.values()).reduce(((e,t)=>e+t.size),0)}startCleanupInterval(){setInterval((()=>{this.cleanup()}),this.cleanupInterval)}cleanup(){const e=Date.now();for(const[t,a]of this.cache.entries())this.isExpired(a)&&this.delete(t);this.lastCleanup=e}getKeys(e=null){const t=Array.from(this.cache.keys());if(!e)return t;const a=RegExp(e);return t.filter((e=>a.test(e)))}getByNamespace(e){const t=[];for(const[a,r]of this.cache.entries())r.namespace===e&&t.push({key:a,...r});return t}preload(e,t={}){const{priority:a="low",namespace:r="preload"}=t;e.forEach((e=>{this.cache.has(e)||this.set(e,null,{priority:a,namespace:r,ttl:3e5})}))}export(){return{entries:Array.from(this.cache.entries()),metadata:Array.from(this.metadata.entries()),stats:this.getStats(),timestamp:Date.now()}}import(e){e.entries&&(this.cache=new Map(e.entries)),e.metadata&&(this.metadata=new Map(e.metadata)),this.updateMemoryUsage()}},u=new class{constructor(){this.metrics={pageLoads:0,apiCalls:0,imageLoads:0,cacheHits:0,cacheMisses:0,errors:0,averageLoadTime:0,totalLoadTime:0,slowRequests:0,networkErrors:0},this.thresholds={slowRequest:3e3,verySlowRequest:1e4,maxCacheSize:100,maxMemoryUsage:52428800},this.observers=new Map,this.isMonitoring=!1,this.memoryInterval=null}init(){"undefined"!=typeof window&&(this.setupPerformanceObserver(),this.setupNetworkMonitoring(),this.setupErrorMonitoring(),this.startMonitoring())}setupPerformanceObserver(){if("PerformanceObserver"in window)try{const e=new PerformanceObserver((e=>{const t=e.getEntries(),a=t[t.length-1];this.recordMetric("lcp",a.startTime)}));e.observe({entryTypes:["largest-contentful-paint"]});const t=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{this.recordMetric("fid",e.processingStart-e.startTime)}))}));t.observe({entryTypes:["first-input"]});const a=new PerformanceObserver((e=>{let t=0;e.getEntries().forEach((e=>{e.hadRecentInput||(t+=e.value)})),this.recordMetric("cls",t)}));a.observe({entryTypes:["layout-shift"]}),this.observers.set("lcp",e),this.observers.set("fid",t),this.observers.set("cls",a)}catch(e){}}setupNetworkMonitoring(){if("PerformanceObserver"in window)try{const e=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{"resource"===e.entryType&&this.recordResourceTiming(e)}))}));e.observe({entryTypes:["resource"]}),this.observers.set("network",e)}catch(e){}}setupErrorMonitoring(){window.addEventListener("error",(e=>{this.recordError("javascript",e.error)})),window.addEventListener("unhandledrejection",(e=>{this.recordError("promise",e.reason)}))}recordMetric(e,t){this.metrics[e]||(this.metrics[e]=[]),this.metrics[e].push({value:t,timestamp:Date.now()}),this.metrics[e].length>100&&(this.metrics[e]=this.metrics[e].slice(-100)),"memoryUsage"!==e&&"memoryLimit"!==e&&t>this.thresholds.slowRequest&&this.metrics.slowRequests++}recordResourceTiming(e){const t=e.duration;e.name,this.metrics.apiCalls++,this.metrics.totalLoadTime+=t,this.metrics.averageLoadTime=this.metrics.totalLoadTime/this.metrics.apiCalls,t>this.thresholds.slowRequest&&this.metrics.slowRequests++,0===e.transferSize&&0===e.decodedBodySize&&this.metrics.networkErrors++}recordError(e,t){this.metrics.errors++;const a={type:e,message:t?.message||"Unknown error",stack:t?.stack,timestamp:Date.now(),url:window.location.href};this.metrics.errorLog||(this.metrics.errorLog=[]),this.metrics.errorLog.push(a),this.metrics.errorLog.length>50&&(this.metrics.errorLog=this.metrics.errorLog.slice(-50))}recordCacheEvent(e){"hit"===e?this.metrics.cacheHits++:this.metrics.cacheMisses++}recordImageLoad(e){this.metrics.imageLoads++,this.recordMetric("imageLoadTime",e)}recordPageLoad(){if(this.metrics.pageLoads++,"performance"in window){const e=performance.getEntriesByType("navigation")[0];e&&(this.recordMetric("domContentLoaded",e.domContentLoadedEventEnd-e.domContentLoadedEventStart),this.recordMetric("loadComplete",e.loadEventEnd-e.loadEventStart))}}getReport(){const e={...this.metrics,cacheHitRate:this.metrics.cacheHits+this.metrics.cacheMisses>0?(this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100).toFixed(2)+"%":"0%",averageLoadTime:this.metrics.averageLoadTime.toFixed(2)+"ms",errorRate:this.metrics.apiCalls>0?(this.metrics.errors/this.metrics.apiCalls*100).toFixed(2)+"%":"0%"};if(this.metrics.lcp&&this.metrics.lcp.length>0){const t=this.metrics.lcp[this.metrics.lcp.length-1];e.lcp=t.value.toFixed(2)+"ms"}if(this.metrics.fid&&this.metrics.fid.length>0){const t=this.metrics.fid[this.metrics.fid.length-1];e.fid=t.value.toFixed(2)+"ms"}if(this.metrics.cls&&this.metrics.cls.length>0){const t=this.metrics.cls[this.metrics.cls.length-1];e.cls=t.value.toFixed(4)}return e}getPerformanceScore(){const e=this.getReport();let t=100;if(e.lcp){const a=parseFloat(e.lcp);a>4e3?t-=30:a>2500&&(t-=15)}if(e.fid){const a=parseFloat(e.fid);a>300?t-=20:a>100&&(t-=10)}if(e.cls){const a=parseFloat(e.cls);a>.25?t-=25:a>.1&&(t-=10)}return t-=Math.min(20,2*this.metrics.errors),t-=Math.min(15,this.metrics.slowRequests),Math.max(0,t)}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.recordPageLoad())}stopMonitoring(){this.isMonitoring=!1,this.memoryInterval&&(clearInterval(this.memoryInterval),this.memoryInterval=null),this.observers.forEach((e=>{e.disconnect()}))}getMemoryUsage(){if("memory"in performance){const e=performance.memory;return{used:(e.usedJSHeapSize/1024/1024).toFixed(2)+"MB",total:(e.totalJSHeapSize/1024/1024).toFixed(2)+"MB",limit:(e.jsHeapSizeLimit/1024/1024).toFixed(2)+"MB",percentage:(e.usedJSHeapSize/e.jsHeapSizeLimit*100).toFixed(2)+"%"}}return null}getNetworkInfo(){if("connection"in navigator){const e=navigator.connection;return{effectiveType:e.effectiveType,downlink:e.downlink+"Mbps",rtt:e.rtt+"ms",saveData:e.saveData}}return null}exportMetrics(){return{metrics:this.metrics,report:this.getReport(),score:this.getPerformanceScore(),memory:this.getMemoryUsage(),network:this.getNetworkInfo(),timestamp:Date.now()}}};u.cleanup=function(){this.stopMonitoring(),this.observers.clear(),this.metrics={pageLoads:0,apiCalls:0,imageLoads:0,cacheHits:0,cacheMisses:0,errors:0,averageLoadTime:0,totalLoadTime:0,slowRequests:0,networkErrors:0}};const h=new class{constructor(){this.config={maxMemory:104857600,maxEntries:2e3,compressionThreshold:1024,adaptiveTTL:!0,baseTTL:9e5,maxTTL:36e5,minTTL:3e5,prefetchEnabled:!0,prefetchThreshold:.7,maxPrefetchItems:10,mlEnabled:!0,learningRate:.1,predictionConfidence:.8,warmupEnabled:!0,warmupDelay:2e3,compressionEnabled:!0,compressionLevel:6,analyticsEnabled:!0,analyticsRetention:6048e5},this.state={isInitialized:!1,prefetchQueue:new Map,warmupQueue:new Map,analytics:{accessPatterns:new Map,hitRates:new Map,userBehavior:new Map,performanceMetrics:[]},mlModel:{accessPredictions:new Map,ttlPredictions:new Map,priorityPredictions:new Map}},this.initialize().catch((e=>{}))}async initialize(){try{await this.initializeIndexedDB(),await this.loadAnalytics(),this.state.isInitialized=!0,this.startBackgroundProcesses(),this.config.mlEnabled&&this.initializeMLModel()}catch(e){this.state.isInitialized=!0}}async initializeIndexedDB(){return new Promise(((e,t)=>{const a=indexedDB.open("EnhancedCacheDB",2);a.onerror=()=>t(a.error),a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("cache")){const e=t.createObjectStore("cache",{keyPath:"key"});e.createIndex("namespace","namespace",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("priority","priority",{unique:!1})}if(!t.objectStoreNames.contains("analytics")){const e=t.createObjectStore("analytics",{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}t.objectStoreNames.contains("mlModel")||t.createObjectStore("mlModel",{keyPath:"key"})}}))}async set(e,t,a={}){const{namespace:r="default",ttl:s=null,compress:i=this.config.compressionEnabled,tags:n=[],params:o={},metadata:c={}}=a,u=s||this.predictTTL(e,r,t),h=this.predictPriority(e,r,t),m=i?await this.compressData(t):t,d={key:e,value:m,compressed:i,timestamp:Date.now(),ttl:u,priority:h,namespace:r,tags:n,params:o,metadata:c,accessCount:0,lastAccessed:Date.now(),size:this.calculateSize(m),predictedAccess:this.predictAccess(e,r)},p=l.set(e,d,{ttl:u,priority:h,namespace:r,tags:n,compress:!1});return p&&(await this.storeInIndexedDB(d),this.updateAnalytics("set",{key:e,namespace:r,size:d.size}),this.config.prefetchEnabled&&this.schedulePrefetch(e,r,t)),p}async get(e,t={}){const{namespace:a="default",params:r={}}=t;let s=l.get(e,{namespace:a,params:r});if(s||(s=await this.getFromIndexedDB(e)),!s)return this.updateAnalytics("miss",{key:e,namespace:a}),null;if(this.isExpired(s))return await this.delete(e),this.updateAnalytics("expired",{key:e,namespace:a}),null;s.accessCount++,s.lastAccessed=Date.now();const i=s.compressed?await this.decompressData(s.value):s.value;return this.updateAnalytics("hit",{key:e,namespace:a,accessCount:s.accessCount}),this.updateMLModel(e,a,"access"),this.scheduleBackgroundRefresh(e,s),i}predictTTL(e,t,a){if(!this.config.adaptiveTTL)return this.config.baseTTL;const r=this.state.analytics.accessPatterns.get(`${t}:${e}`);if(!r)return this.config.baseTTL;const{frequency:s,recency:i,volatility:n}=r;let o=this.config.baseTTL;return s>10&&(o*=2),3e5>i&&(o*=1.5),.3>n&&(o*=1.3),Math.min(Math.max(o,this.config.minTTL),this.config.maxTTL)}predictPriority(e,t,a){const r=this.state.mlModel.priorityPredictions.get(`${t}:${e}`);return r&&r.confidence>this.config.predictionConfidence?r.priority:"movie"===t&&e.includes("details")||"api"===t&&e.includes("trending")?"high":"user"===t?"critical":"normal"}predictAccess(e,t){const a=this.state.mlModel.accessPredictions.get(`${t}:${e}`);return a?{probability:a.probability,nextAccess:a.nextAccess,confidence:a.confidence}:{probability:.5,nextAccess:null,confidence:.5}}async compressData(e){if(!this.config.compressionEnabled)return e;try{if("CompressionStream"in window){const t=JSON.stringify(e),a=new Blob([t]).stream().pipeThrough(new CompressionStream("gzip")),r=await new Response(a).blob();return await r.arrayBuffer()}return JSON.stringify(e)}catch(t){return e}}async decompressData(e){try{if(e instanceof ArrayBuffer&&"DecompressionStream"in window){const t=new Blob([e]).stream().pipeThrough(new DecompressionStream("gzip")),a=await new Response(t).blob(),r=await a.text();return JSON.parse(r)}return JSON.parse(e)}catch(t){return e}}schedulePrefetch(e,t,a){this.generatePrefetchPredictions(e,t,a).forEach((e=>{const t=`${e.type}_${e.id}`;this.state.prefetchQueue.has(t)||this.state.prefetchQueue.set(t,{...e,priority:e.priority||"low",scheduledAt:Date.now()})})),this.processPrefetchQueue()}generatePrefetchPredictions(e,t,a){const r=[];if("movie"===t&&a&&a.id&&(r.push({type:"similar",id:a.id,url:`/api/movie/${a.id}/similar`,priority:"medium"}),r.push({type:"recommendations",id:a.id,url:`/api/movie/${a.id}/recommendations`,priority:"medium"}),a.genres&&a.genres.length>0)){const e=a.genres[0];r.push({type:"genre",id:e.id,url:"/api/discover/movie?with_genres="+e.id,priority:"low"})}return r}async processPrefetchQueue(){if(!this.state||!this.state.prefetchQueue||0===this.state.prefetchQueue.size)return;const e=Array.from(this.state.prefetchQueue.entries());e.sort(((e,t)=>{const a={critical:4,high:3,medium:2,low:1};return a[t[1].priority]-a[e[1].priority]}));const t=e.slice(0,this.config.maxPrefetchItems);for(const[r,s]of t)try{const e=await fetch(s.url);if(e.ok){const t=await e.json();await this.set(r,t,{namespace:"prefetch",priority:s.priority,ttl:18e5})}}catch(a){}finally{this.state.prefetchQueue.delete(r)}}async warmupCache(){if(!this.config.warmupEnabled)return;if(!this.state||!this.state.warmupQueue)return;const e=this.generateWarmupData();for(const t of e)this.state.warmupQueue.set(t.key,{...t,scheduledAt:Date.now()});setTimeout((()=>{this.processWarmupQueue()}),this.config.warmupDelay)}generateWarmupData(){const e=[];e.push({key:"trending",url:"/api/tmdb/trending",priority:"high",namespace:"api"}),e.push({key:"popular",url:"/api/tmdb/popular",priority:"high",namespace:"api"});const t=this.getUserPreferences();return t.favoriteGenres&&t.favoriteGenres.forEach((t=>{e.push({key:"genre_"+t,url:"/api/tmdb/discover/movie?with_genres="+t,priority:"medium",namespace:"api"})})),e}async processWarmupQueue(){if(this.state&&this.state.warmupQueue&&0!==this.state.warmupQueue.size)for(const[t,a]of this.state.warmupQueue.entries())try{const e=await fetch(a.url);if(e.ok){const r=await e.json();await this.set(t,r,{namespace:a.namespace,priority:a.priority,ttl:36e5})}}catch(e){}finally{this.state.warmupQueue.delete(t)}}scheduleBackgroundRefresh(e,t){const a=t.timestamp+t.ttl-Date.now(),r=.2*t.ttl;r>a&&t.accessCount>5&&setTimeout((async()=>{await this.refreshEntry(e,t)}),a-r)}async refreshEntry(e,t){try{const a=await fetch(t.metadata.url||e);if(a.ok){const r=await a.json();await this.set(e,r,{namespace:t.namespace,priority:t.priority,ttl:t.ttl,tags:t.tags})}}catch(a){}}updateAnalytics(e,t){if(!this.config.analyticsEnabled)return;const a={type:e,data:t,timestamp:Date.now(),userAgent:navigator.userAgent,connection:navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt}:null};this.state.analytics.performanceMetrics.push(a),this.storeAnalytics(a),"hit"!==e&&"miss"!==e||this.updateAccessPatterns(t.key,t.namespace,e)}updateAccessPatterns(e,t,a){const r=`${t}:${e}`;let s=this.state.analytics.accessPatterns.get(r)||{hits:0,misses:0,accesses:[],lastAccess:0};"hit"===a&&s.hits++,"miss"===a&&s.misses++,s.accesses.push(Date.now()),s.lastAccess=Date.now(),s.accesses.length>100&&(s.accesses=s.accesses.slice(-100)),s.frequency=s.accesses.length,s.recency=Date.now()-s.lastAccess,s.volatility=this.calculateVolatility(s.accesses),this.state.analytics.accessPatterns.set(r,s)}calculateVolatility(e){if(2>e.length)return 0;const t=[];for(let s=1;s<e.length;s++)t.push(e[s]-e[s-1]);const a=t.reduce(((e,t)=>e+t),0)/t.length,r=t.reduce(((e,t)=>e+Math.pow(t-a,2)),0)/t.length;return Math.sqrt(r)/a}updateMLModel(e,t,a){if(!this.config.mlEnabled)return;const r=`${t}:${e}`,s=this.state.mlModel.accessPredictions.get(r)||{probability:.5,nextAccess:null,confidence:.5,updates:0};s.updates++,s.probability=Math.min(1,s.probability+this.config.learningRate),s.confidence=Math.min(1,s.confidence+.01),this.state.mlModel.accessPredictions.set(r,s)}initializeMLModel(){this.loadMLModel(),setInterval((()=>{this.trainMLModel()}),3e5)}async trainMLModel(){for(const[e,t]of this.state.analytics.accessPatterns.entries()){const a=this.state.mlModel.accessPredictions.get(e)||{probability:.5,nextAccess:null,confidence:.5,updates:0},r=Math.min(1,t.frequency/50);a.probability=.9*a.probability+.1*r,this.state.mlModel.accessPredictions.set(e,a)}await this.saveMLModel()}async storeInIndexedDB(e){if(!this.db)return;const t=this.db.transaction(["cache"],"readwrite").objectStore("cache");await t.put(e)}async getFromIndexedDB(e){if(!this.db)return null;const t=this.db.transaction(["cache"],"readonly").objectStore("cache");return await t.get(e)}async storeAnalytics(e){if(!this.db)return;const t=this.db.transaction(["analytics"],"readwrite").objectStore("analytics");await t.add(e)}async loadAnalytics(){if(this.db)try{const e=this.db.transaction(["analytics"],"readonly").objectStore("analytics"),t=Date.now()-this.config.analyticsRetention,a=e.index("timestamp"),r=await a.getAll(IDBKeyRange.lowerBound(t));Array.isArray(r)&&r.forEach((e=>{this.state.analytics.performanceMetrics.push(e)}))}catch(e){}}async loadMLModel(){if(this.db)try{const e=this.db.transaction(["mlModel"],"readonly").objectStore("mlModel"),t=await e.getAll();Array.isArray(t)&&t.forEach((e=>{e.key.startsWith("access_")?this.state.mlModel.accessPredictions.set(e.key.slice(7),e.data):e.key.startsWith("ttl_")?this.state.mlModel.ttlPredictions.set(e.key.slice(4),e.data):e.key.startsWith("priority_")&&this.state.mlModel.priorityPredictions.set(e.key.slice(9),e.data)}))}catch(e){}}async saveMLModel(){if(!this.db)return;const e=this.db.transaction(["mlModel"],"readwrite").objectStore("mlModel");for(const[t,a]of this.state.mlModel.accessPredictions.entries())await e.put({key:"access_"+t,data:a});for(const[t,a]of this.state.mlModel.ttlPredictions.entries())await e.put({key:"ttl_"+t,data:a});for(const[t,a]of this.state.mlModel.priorityPredictions.entries())await e.put({key:"priority_"+t,data:a})}startBackgroundProcesses(){this.state&&this.state.isInitialized&&(setInterval((async()=>{if(this.isReady())try{await this.cleanup()}catch(e){}}),3e5),setInterval((()=>{this.isReady()&&this.saveAnalytics()}),6e4),setInterval((()=>{this.isReady()&&this.processPrefetchQueue()}),1e4))}async cleanup(){try{const t=Date.now();let a=0;if(l&&"function"==typeof l.getKeys)try{const e=l.getKeys(),t=Array.isArray(e)?e:Array.from(e||[]);for(const r of t){const e=l.get(r);e&&this.isExpired(e)&&(l.delete(r),a++)}}catch(e){}if(this.db)try{const e=this.db.transaction(["cache"],"readwrite").objectStore("cache"),r=e.index("timestamp"),s=t-this.config.maxTTL,i=await r.getAllKeys(IDBKeyRange.upperBound(s)),n=Array.isArray(i)?i:Array.from(i||[]);for(const t of n)await e.delete(t),a++}catch(e){}}catch(e){}}async saveAnalytics(){this.state.analytics.performanceMetrics.length>1e3&&(this.state.analytics.performanceMetrics=this.state.analytics.performanceMetrics.slice(-500))}getUserPreferences(){try{const e=localStorage.getItem("streamr_user_preferences");return e?JSON.parse(e):{}}catch{return{}}}calculateSize(e){try{return e instanceof ArrayBuffer?e.byteLength:new Blob([JSON.stringify(e)]).size}catch{return 0}}isExpired(e){return Date.now()-e.timestamp>e.ttl}async delete(e){if(l.delete(e),this.db){const t=this.db.transaction(["cache"],"readwrite").objectStore("cache");await t.delete(e)}}isReady(){return this.state&&this.state.isInitialized&&l&&"function"==typeof l.getStats}async waitForReady(e=5e3){const t=Date.now();for(;!this.isReady()&&Date.now()-t<e;)await new Promise((e=>setTimeout(e,100)));return this.isReady()}getStats(){try{if(!this.isReady())return this.getFallbackStats();return{...l.getStats(),prefetchQueueSize:this.state&&this.state.prefetchQueue?this.state.prefetchQueue.size:0,warmupQueueSize:this.state&&this.state.warmupQueue?this.state.warmupQueue.size:0,mlPredictions:this.state&&this.state.mlModel&&this.state.mlModel.accessPredictions?this.state.mlModel.accessPredictions.size:0,analyticsEntries:this.state&&this.state.analytics&&this.state.analytics.performanceMetrics?this.state.analytics.performanceMetrics.length:0,accessPatterns:this.state&&this.state.analytics&&this.state.analytics.accessPatterns?this.state.analytics.accessPatterns.size:0}}catch(e){return this.getFallbackStats()}}getFallbackStats(){return{hits:0,misses:0,sets:0,deletes:0,size:0,memoryUsage:0,hitRate:"0%",efficiency:0,memoryUsageMB:"0.00",averageEntrySize:0,prefetchQueueSize:0,warmupQueueSize:0,mlPredictions:0,analyticsEntries:0,accessPatterns:0}}async clear(){if(l.clear(),this.db){const e=this.db.transaction(["cache"],"readwrite").objectStore("cache");await e.clear()}this.state&&this.state.prefetchQueue&&this.state.prefetchQueue.clear(),this.state&&this.state.warmupQueue&&this.state.warmupQueue.clear(),this.state&&this.state.analytics&&(this.state.analytics.performanceMetrics=[],this.state.analytics.accessPatterns&&this.state.analytics.accessPatterns.clear()),this.state&&this.state.mlModel&&(this.state.mlModel.accessPredictions&&this.state.mlModel.accessPredictions.clear(),this.state.mlModel.ttlPredictions&&this.state.mlModel.ttlPredictions.clear(),this.state.mlModel.priorityPredictions&&this.state.mlModel.priorityPredictions.clear())}},m={warmup:()=>h.warmupCache(),getStats:()=>h.getStats(),clear:()=>h.clear(),export:()=>h.export(),import:e=>h.import(e),generateKey:(e,t,a={})=>h.generateKey(e,t,a),invalidate:e=>h.invalidate(e),preload:(e,t)=>h.preload(e,t)},d=new class{constructor(){this.config={baseURL:"https://streamr-jjj9.onrender.com/api",timeout:1e4,retryAttempts:2,retryDelay:1e3,cacheEnabled:!0,defaultTTL:9e5,aggressiveCaching:!0,batchingEnabled:!0,batchTimeout:100,maxBatchSize:10,rateLimitEnabled:!0,maxRequestsPerSecond:1,rateLimitWindow:1e3,maxConcurrentRequests:2,performanceTracking:!0,detailedLogging:!1},this.state={batchQueue:new Map,pendingRequests:new Map,requestQueue:[],isRateLimited:!1,rateLimitResetTime:0,failedRequests:new Set,requestStats:{total:0,cached:0,network:0,errors:0,rateLimited:0,serviceUnavailable:0,averageResponseTime:0}},this.state.rateLimitTokens=this.config.maxRequestsPerSecond,this.state.lastRateLimitReset=Date.now(),setTimeout((()=>{this.initializeConfig(),this.initialize().catch((e=>{}))}),0)}initializeConfig(){try{const t=e();t&&(this.config.baseURL=t)}catch(t){}}async initialize(){try{this.startRateLimitReset(),this.startRequestTracking(),await this.warmupCriticalData()}catch(e){}}async request(e,t={}){const{method:a="GET",params:r={},data:s=null,headers:i={},useCache:n=this.config.cacheEnabled,cacheTTL:o=this.config.defaultTTL,priority:c="normal",namespace:l="api",retryAttempts:u=this.config.retryAttempts,batchKey:m=null}=t,d=this.generateRequestId(),p=this.generateCacheKey(e,a,r,s),g=`${a}:${e}:${JSON.stringify(r)}`;if(this.state.failedRequests.has(g))throw Error("Request previously failed: "+e);const y=performance.now();this.trackRequest("start",{requestId:d,endpoint:e,method:a});try{if(n&&"GET"===a){const t=await h.get(p,{namespace:l});if(t)return this.trackRequest("cache_hit",{requestId:d,endpoint:e}),this.state.requestStats.cached++,this.createResponse(t,!0)}if(this.config.batchingEnabled&&m&&"GET"===a)return this.handleBatchedRequest(m,e,t);if(this.state.pendingRequests.size>=this.config.maxConcurrentRequests)return new Promise(((a,r)=>{this.state.requestQueue.push({endpoint:e,options:t,resolve:a,reject:r,timestamp:Date.now()})}));if(this.config.rateLimitEnabled&&!this.checkRateLimit())throw Error("Rate limit exceeded");this.state.pendingRequests.set(d,{endpoint:e,startTime:Date.now()});const g=await this.executeRequest(e,a,r,s,i,u);return n&&g.ok&&"GET"===a&&await this.cacheResponse(p,g.data,{namespace:l,ttl:o,priority:c,metadata:{url:e,method:a,params:r}}),this.trackRequest("success",{requestId:d,endpoint:e,duration:performance.now()-y,size:g.data?JSON.stringify(g.data).length:0}),this.state.requestStats.network++,this.state.pendingRequests.delete(d),this.processRequestQueue(),g}catch(f){if(this.trackRequest("error",{requestId:d,endpoint:e,error:f.message,duration:performance.now()-y}),this.state.requestStats.errors++,(f.message?.includes("404")||f.message?.includes("403")||f.message?.includes("401")||f.message?.includes("400"))&&this.state.failedRequests.add(g),this.state.pendingRequests.delete(d),this.processRequestQueue(),n&&"GET"===a){const e=await h.get(p,{namespace:l});if(e)return this.createResponse(e,!0,!0)}throw f}}async executeRequest(e,t,a,r,s,i){if(this.state.isRateLimited){const e=this.state.rateLimitResetTime-Date.now();e>0?await this.sleep(e):(this.state.isRateLimited=!1,this.state.rateLimitResetTime=0)}const n=this.buildUrl(e,a),o=new AbortController,c=setTimeout((()=>o.abort()),this.config.timeout),l={method:t,headers:{"Content-Type":"application/json",...s},signal:o.signal};let u;r&&"GET"!==t&&(l.body=JSON.stringify(r));for(let m=1;i>=m;m++)try{const e=await fetch(n,l);if(429===e.status){this.state.requestStats.rateLimited++,this.state.isRateLimited=!0;const t=e.headers.get("retry-after"),a=t?1e3*parseInt(t):2e3*Math.pow(2,m);if(this.state.rateLimitResetTime=Date.now()+a,i>m){await this.sleep(a);continue}throw Error(`Rate limited after ${i} attempts`)}if(503===e.status){if(this.state.requestStats.serviceUnavailable++,i>m){const e=1e3*Math.pow(2,m)+1e3*Math.random();await this.sleep(e);continue}throw Error(`Service unavailable after ${i} attempts`)}if(!e.ok){if(404===e.status)throw Error(`HTTP ${e.status}: ${e.statusText}`);if(e.status>=400&&500>e.status&&429!==e.status&&503!==e.status)throw Error(`HTTP ${e.status}: ${e.statusText}`);throw Error(`HTTP ${e.status}: ${e.statusText}`)}const t=await e.json();return clearTimeout(c),{ok:!0,status:e.status,data:t,headers:Object.fromEntries(e.headers.entries())}}catch(h){clearTimeout(c),u=h;const e=h.message?.includes("404")||h.message?.includes("403")||h.message?.includes("401")||h.message?.includes("400");if(i>m&&!e){const e=this.config.retryDelay*Math.pow(2,m-1);await this.sleep(e)}else if(e)break}throw u}async handleBatchedRequest(e,t,a){if(this.state.batchQueue.has(e)){const r=this.state.batchQueue.get(e);return r.requests.push({endpoint:t,options:a}),new Promise(((e,t)=>{r.promises.push({resolve:e,reject:t})}))}const r={requests:[{endpoint:t,options:a}],promises:[],timeout:setTimeout((()=>{this.processBatch(e)}),this.config.batchTimeout)};return this.state.batchQueue.set(e,r),new Promise(((e,t)=>{r.promises.push({resolve:e,reject:t})}))}async processBatch(e){const t=this.state.batchQueue.get(e);if(t){this.state.batchQueue.delete(e);try{(await Promise.allSettled(t.requests.map((e=>this.executeRequest(e.endpoint,e.options.method||"GET",e.options.params||{},e.options.data||null,e.options.headers||{}))))).forEach(((e,a)=>{const{resolve:r,reject:s}=t.promises[a];"fulfilled"===e.status?r(e.value):s(e.reason)}))}catch(a){t.promises.forEach((({reject:e})=>e(a)))}}}async cacheResponse(e,t,a={}){try{await h.set(e,t,a),this.shouldPrefetch(t)&&this.schedulePrefetch(t)}catch(r){}}shouldPrefetch(e){return!(!e||!e.id||!e.title&&!e.name)||!!(e&&e.results&&Array.isArray(e.results)&&e.results.length>0)}schedulePrefetch(e){if(!e)return;const t=[];if(e.id&&(e.title||e.name)&&(t.push({type:"similar",url:`/api/movie/${e.id}/similar`,priority:"medium"}),t.push({type:"recommendations",url:`/api/movie/${e.id}/recommendations`,priority:"medium"})),e.page&&e.total_pages&&e.page<e.total_pages){const a=window.location.pathname;let r=null;if("/movies"===a||"/"===a?r="/api/tmdb/trending":"/popular"===a?r="/api/tmdb/popular":"/top-rated"===a?r="/api/tmdb/top-rated":"/upcoming"===a?r="/api/tmdb/upcoming":"/now-playing"===a&&(r="/api/tmdb/now-playing"),r){const a=e.page+1;t.push({type:"next_page",url:`${r}?page=${a}`,priority:"low"})}}t.forEach((e=>{setTimeout((async()=>{try{await this.request(e.url,{useCache:!0,priority:e.priority,namespace:"prefetch"})}catch(t){}}),1e3*Math.random())}))}async warmupCriticalData(){["/api/tmdb/trending","/api/tmdb/popular","/api/tmdb/top-rated"].forEach(((e,t)=>{setTimeout((async()=>{try{await this.request(e,{useCache:!0,priority:"high",namespace:"warmup"})}catch(t){}}),3e3*(t+1)+2e3*Math.random())}))}checkRateLimit(){const e=Date.now();return e-this.state.lastRateLimitReset<this.config.rateLimitWindow||(this.state.rateLimitTokens=this.config.maxRequestsPerSecond,this.state.lastRateLimitReset=e),this.state.rateLimitTokens>0&&(this.state.rateLimitTokens--,!0)}startRateLimitReset(){setInterval((()=>{this.state.rateLimitTokens=this.config.maxRequestsPerSecond,this.state.lastRateLimitReset=Date.now()}),this.config.rateLimitWindow)}trackRequest(e,t){this.config.performanceTracking&&(u&&"function"==typeof u.trackApiCall&&u.trackApiCall(t.endpoint,t.method||"GET",t.duration||0,t.status||200,t.size||0),"success"===e&&t.duration&&this.updateAverageResponseTime(t.duration))}updateAverageResponseTime(e){const{total:t,averageResponseTime:a}=this.state.requestStats;this.state.requestStats.averageResponseTime=(a*t+e)/(t+1)}startRequestTracking(){setInterval((()=>{this.config.detailedLogging}),6e4)}generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateCacheKey(e,t,a,r){const s={endpoint:e,method:t,params:a||{},data:r||null};try{return btoa(JSON.stringify(s)).replace(/[^a-zA-Z0-9]/g,"")}catch(i){const e=JSON.stringify(s);let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return"key_"+Math.abs(t).toString(36)}}buildUrl(e,t){const a=new URL(e,this.config.baseURL);return Object.entries(t).forEach((([e,t])=>{null!=t&&a.searchParams.set(e,t)})),a.toString()}createResponse(e,t=!1,a=!1){return{ok:!0,status:200,data:e,headers:{},fromCache:t,stale:a}}sleep(e){return new Promise((t=>setTimeout(t,e)))}getStats(){try{const e=h.getStats();return{...this.state.requestStats,cacheStats:e,rateLimitTokens:this.state.rateLimitTokens,pendingRequests:this.state.pendingRequests.size,batchQueueSize:this.state.batchQueue.size,requestQueueSize:this.state.requestQueue.size}}catch(e){return{totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,cacheHits:0,cacheMisses:0,cacheStats:{hits:0,misses:0,sets:0,deletes:0,size:0,memoryUsage:0,hitRate:"0%",efficiency:0,memoryUsageMB:"0.00",averageEntrySize:0},rateLimitTokens:0,pendingRequests:0,batchQueueSize:0,requestQueueSize:0}}}async clearCache(){await h.clear()}async preload(e,t={}){const{priority:a="low",namespace:r="preload"}=t,s=e.map((e=>this.request(e,{useCache:!0,priority:a,namespace:r}).catch((e=>null))));return Promise.allSettled(s)}async invalidateCache(e){return h.invalidate(e)}async getCached(e,t={}){const a=this.generateCacheKey(e,"GET",t);return await h.get(a,{namespace:"api"})}async isCached(e,t={}){const a=this.generateCacheKey(e,"GET",t);return null!==await h.get(a,{namespace:"api"})}clearFailedRequests(){this.state.failedRequests.clear()}getFailedRequestsCount(){return this.state.failedRequests.size}processRequestQueue(){if(0===this.state.requestQueue.length)return;const e=Date.now(),t=this.state.requestQueue;this.state.requestQueue=[];for(const a of t){const{endpoint:t,options:r,resolve:s,reject:i,timestamp:n}=a;if(e-n>1e4){i(Error("Request queue timeout"));continue}if(this.state.pendingRequests.size>=this.config.maxConcurrentRequests){this.state.requestQueue.push({endpoint:t,options:r,resolve:s,reject:i,timestamp:n});continue}if(this.config.rateLimitEnabled&&!this.checkRateLimit()){i(Error("Rate limit exceeded for queue item"));continue}const o=this.generateRequestId();this.state.pendingRequests.set(o,{endpoint:t,startTime:Date.now()}),this.request(t,r).then(s).catch(i)}}},p={getStats:()=>d.getStats(),clearCache:()=>d.clearCache(),preload:(e,t)=>d.preload(e,t),invalidateCache:e=>d.invalidateCache(e),getCached:(e,t)=>d.getCached(e,t),isCached:(e,t)=>d.isCached(e,t),generateCacheKey:(e,t,a,r)=>d.generateCacheKey(e,t,a,r),clearFailedRequests:()=>d.clearFailedRequests(),getFailedRequestsCount:()=>d.getFailedRequestsCount()},g=new class{constructor(){this.defaults={timeoutFast:8e3,timeoutSlow:15e3,timeoutVerySlow:25e3,retryFast:2,retrySlow:3,retryVerySlow:4,baseBackoffMs:800,maxBackoffMs:8e3,maxConcurrentFast:8,maxConcurrentSlow:4,maxConcurrentVerySlow:2};const e=this.getNetworkProfile();this.state={maxConcurrent:this.computeMaxConcurrent(e),activeCount:0,queue:[],inFlight:new Map}}getNetworkProfile(){const e=navigator,t=e&&e.connection?e.connection:{},a=t.effectiveType||"4g",r=!!t.saveData,s="number"==typeof t.downlink?t.downlink:null;return{effectiveType:a,saveData:r,downlink:s,rtt:"number"==typeof t.rtt?t.rtt:null,bucket:r||"2g"===a||"slow-2g"===a?"verySlow":"3g"===a||null!==s&&1>s?"slow":"fast"}}computeMaxConcurrent(e){switch(e.bucket){case"verySlow":return this.defaults.maxConcurrentVerySlow;case"slow":return this.defaults.maxConcurrentSlow;default:return this.defaults.maxConcurrentFast}}computeTimeout(e){switch(e.bucket){case"verySlow":return this.defaults.timeoutVerySlow;case"slow":return this.defaults.timeoutSlow;default:return this.defaults.timeoutFast}}computeRetries(e){switch(e.bucket){case"verySlow":return this.defaults.retryVerySlow;case"slow":return this.defaults.retrySlow;default:return this.defaults.retryFast}}async withConcurrency(e){if(this.state.activeCount<this.state.maxConcurrent){this.state.activeCount++;try{return await e()}finally{this.state.activeCount--,this.drainQueue()}}return new Promise(((t,a)=>{this.state.queue.push({fn:e,resolve:t,reject:a})}))}async drainQueue(){for(;this.state.activeCount<this.state.maxConcurrent&&this.state.queue.length>0;){const e=this.state.queue.shift();this.state.activeCount++,e.fn().then((t=>e.resolve(t))).catch((t=>e.reject(t))).finally((()=>{this.state.activeCount--,this.drainQueue()}))}}getInFlight(e){return this.state.inFlight.get(e)||null}setInFlight(e,t){this.state.inFlight.set(e,t),t.finally((()=>this.state.inFlight.delete(e)))}async performFetch(e,t,a){const r=this.computeTimeout(a),s=this.computeRetries(a);let i;for(let o=1;s+1>=o;o++){const a=new AbortController,c=setTimeout((()=>a.abort()),r);try{const r=await fetch(e,{...t,signal:a.signal});if(clearTimeout(c),!r.ok){if(r.status>=400&&500>r.status&&408!==r.status)throw Error(`HTTP ${r.status}: ${r.statusText}`);throw Error(`HTTP ${r.status}: ${r.statusText}`)}return r}catch(n){clearTimeout(c),i=n;const e=n&&("AbortError"===n.name||/timeout/i.test(n.message+"")),t=n&&/network|failed|fetch|connection/i.test(n.message+"");if(o>s||!e&&!t)break;const a=Math.min(this.defaults.baseBackoffMs*Math.pow(2,o-1),this.defaults.maxBackoffMs);await new Promise((e=>setTimeout(e,a)))}}throw i}async getJSON(e,{params:t={},headers:a={},cacheKey:r=null,namespace:s="api",ttl:i=6e5,swr:n=!0,forceNetwork:o=!1,priority:c="normal"}={}){const l=this.buildUrl(e,t),u=this.getNetworkProfile(),m=r||this.generateCacheKey("GET",l);if(!o){const r=await h.get(m,{namespace:s});if(r)return n&&this.prefetch(e,{params:t,headers:a,cacheKey:m,namespace:s,ttl:i,priority:c}),{ok:!0,fromCache:!0,stale:!1,data:r}}const d="GET:"+l,p=this.getInFlight(d);if(p)try{return{ok:!0,fromCache:!1,stale:!1,data:await p}}catch(y){}const g=this.withConcurrency((async()=>{const e=await this.performFetch(l,{headers:{"Content-Type":"application/json",...a}},u),t=await e.json();return await h.set(m,t,{namespace:s,ttl:i,priority:c,metadata:{url:l,method:"GET"}}),t}));this.setInFlight(d,g);try{return{ok:!0,fromCache:!1,stale:!1,data:await g}}catch(f){const e=await h.get(m,{namespace:s});if(e)return{ok:!1,fromCache:!0,stale:!0,data:e,error:f};throw f}}async prefetch(e,{params:t={},headers:a={},cacheKey:r=null,namespace:s="prefetch",ttl:i=18e5,priority:n="low"}={}){const o=this.buildUrl(e,t),c=r||this.generateCacheKey("GET",o),l="GET:"+o;this.state.inFlight.has(l)||this.setInFlight(l,this.withConcurrency((async()=>{try{const e=this.getNetworkProfile(),t=await this.performFetch(o,{headers:{"Content-Type":"application/json","X-Prefetch":"1",...a}},e),r=await t.json();await h.set(c,r,{namespace:s,ttl:i,priority:n,metadata:{url:o,method:"GET",prefetch:!0}})}catch(e){}})))}generateCacheKey(e,t){return btoa(`${e}:${t}`).replace(/[^a-zA-Z0-9]/g,"")}buildUrl(e,t){const a=new URL(e,window.location.origin);return Object.entries(t||{}).forEach((([e,t])=>{null!=t&&a.searchParams.set(e,t)})),a.toString()}},y=async(t=1)=>{try{const a=await(async(e,t=1)=>{try{const a=await C(e,t);return await a.json()}catch(a){throw a}})(`${e()}/tmdb/trending?media_type=tv&time_window=day&page=${t}`);if(!a?.results)throw Error("Invalid trending TV response");const r=new Map;a.results.forEach((e=>{if("tv"===e.media_type&&!r.has(e.id)){const t=z(e);t&&r.set(e.id,t)}}));const s=Array.from(r.values());return{movies:s,totalPages:a.total_pages||1,currentPage:t,totalResults:s.length}}catch(a){return{movies:[],totalPages:1,currentPage:t,totalResults:0,error:a.message}}},f="92b98feaab02d1088661e456c19edb89",w="https://api.themoviedb.org/3",v="https://image.tmdb.org/t/p";let _;"function"==typeof fetch?_=fetch:"undefined"!=typeof window&&"function"==typeof window.fetch?_=window.fetch.bind(window):"undefined"!=typeof global&&"function"==typeof global.fetch?_=global.fetch.bind(global):"undefined"!=typeof self&&"function"==typeof self.fetch?_=self.fetch.bind(self):("undefined"!=typeof window&&window.fetch,"undefined"!=typeof global&&global.fetch,"undefined"!=typeof self&&self.fetch,_=()=>{throw Error("[tmdbService] Fetch is not available. Please load a fetch polyfill.")});const b="CONNECTION_RESET",T="RATE_LIMIT",S="SERVER_ERROR",k=1e3,M=3e3,C=async(e,t=1,a=15e3)=>{try{const t=g.getNetworkProfile?g.getNetworkProfile():{bucket:"fast"};if("fast"!==t.bucket)return await g.performFetch(e,{headers:{Accept:"application/json","Content-Type":"application/json"}},t)}catch(r){}try{const t=new AbortController,r=setTimeout((()=>t.abort()),a),s=await _(e,{signal:t.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(r),!s.ok)throw Error(`HTTP ${s.status}: ${s.statusText}`);return s}catch(s){if((s.message.includes("connection reset")||s.message.includes("net::err_connection_reset")||"TypeError"===s.name&&s.message.includes("fetch"))&&2>t){const r=Math.min(k*Math.pow(1.5,t-1)*2,M);return await new Promise((e=>setTimeout(e,r))),C(e,t+1,a)}if(2>t){const r=Math.min(k*Math.pow(1.5,t-1),M);return await new Promise((e=>setTimeout(e,r))),C(e,t+1,a)}throw s}},P=new Map,E={LIST:6e5,DETAILS:18e5,IMAGES:216e5},R=[];let I=!1,A=0,D=0;const $=500,x=new Map,L=e=>{const t=e.message.toLowerCase(),a=e.name;return t.includes("connection reset")||t.includes("net::err_connection_reset")||t.includes("fetch failed")||t.includes("network error")?{type:b,retryable:!0,severity:"high",userMessage:"Connection was reset. Please check your internet connection."}:t.includes("timeout")||t.includes("aborted")||"AbortError"===a?{type:"TIMEOUT",retryable:!0,severity:"medium",userMessage:"Request timed out. Please try again."}:t.includes("dns")||t.includes("name not resolved")||t.includes("getaddrinfo")?{type:"DNS_FAILURE",retryable:!0,severity:"high",userMessage:"Unable to resolve server address. Please check your internet connection."}:t.includes("ssl")||t.includes("tls")||t.includes("certificate")?{type:"SSL_ERROR",retryable:!1,severity:"high",userMessage:"SSL certificate error. Please check your connection."}:t.includes("rate limit")||t.includes("429")||t.includes("too many requests")?{type:T,retryable:!0,severity:"medium",userMessage:"Rate limit exceeded. Please wait a moment and try again."}:t.includes("500")||t.includes("502")||t.includes("503")||t.includes("504")?{type:S,retryable:!0,severity:"medium",userMessage:"Server error. Please try again."}:{type:"UNKNOWN",retryable:!0,severity:"low",userMessage:"An unexpected error occurred. Please try again."}},j=(e,t="unknown")=>{let a=k*Math.pow(1.5,e-1);switch(a+=.1*a*(Math.random()-.5),a=Math.min(a,3e3),t){case T:a=Math.max(a,2e3);break;case S:a=Math.max(a,1e3);break;case b:a=Math.max(a,500)}return Math.max(a,100)},O=async()=>{try{if(!navigator.onLine)return!1;const r=new AbortController,s=setTimeout((()=>r.abort()),3e3);try{const e=`${w}/configuration${f?"?api_key="+f:""}`,t=await fetch(e,{method:"HEAD",signal:r.signal,cache:"no-cache"});return clearTimeout(s),!(!t.ok&&401!==t.status&&403!==t.status)}catch(e){clearTimeout(s);try{const e=new AbortController,t=setTimeout((()=>e.abort()),2e3),a=await _("https://image.tmdb.org/t/p/w92/1E5baAaEse26fej7uHcjOgEE2t5.jpg",{method:"HEAD",signal:e.signal,cache:"no-cache"});return clearTimeout(t),a.ok}catch(t){try{const e=new AbortController,t=setTimeout((()=>e.abort()),1500),a=await _("https://jsonplaceholder.typicode.com/posts/1",{method:"GET",signal:e.signal,cache:"no-cache"});return clearTimeout(t),a.ok}catch(a){return navigator.onLine}}}}catch(r){return navigator.onLine}},N=async()=>{if(!I&&1>A){for(I=!0;R.length>0&&1>A;){const e=R.shift();A++,e().finally((()=>{A--,R.length>0&&N()}))}I=!1}},H=(e,t)=>{const a=L(t);return j(e,a.type)};setInterval((()=>{const e=Date.now();let t=0;for(const[a,r]of P.entries())e-r.timestamp>E[r.type]&&(P.delete(a),t++);return t}),3e5);const F=async(e,t={},a="LIST")=>{const r=e=>new Promise((t=>setTimeout(t,e))),s=async(e,a=1)=>{performance.now();const i=`fetch_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{const i=new URL(e,w);i.searchParams.has("api_key")||i.searchParams.set("api_key",f);const n=i.toString(),o=((e,t)=>{const a=new URL(e,w),r=new URLSearchParams(a.search);return r.delete("api_key"),`${a.pathname}-${r.toString()}-${JSON.stringify(t)}`})(e,t),c=e.includes("/movie/")||e.includes("/tv/")||e.includes("/person/")?"DETAILS":"LIST",l=((e,t="LIST")=>{const a=P.get(e);return a&&Date.now()-a.timestamp<E[t]?(a.accessCount=(a.accessCount||0)+1,a.lastAccessed=Date.now(),a.data):(a&&P.delete(e),null)})(o,c);if(l)return l;const u=Date.now()-D,h=Math.max($,R.length>5?600:$);if(h>u){const e=h-u;await r(e)}const m=new AbortController,d=setTimeout((()=>m.abort()),15e3),p=await _(n,{...t,signal:m.signal,headers:{Accept:"application/json","Content-Type":"application/json","User-Agent":"MovieApp/1.0",...t.headers}});if(clearTimeout(d),!p.ok){const t=Error(`HTTP ${p.status}: ${p.statusText}`);t.status=p.status;const i=L(t);if(404===p.status)return null;if(i.retryable&&3>a){const t=j(a,i.type);return await r(t),s(e,a+1)}throw t}const g=p.headers.get("content-type");if(!g||!g.includes("application/json"))throw Error("Invalid response format: expected JSON");const y=await p.json();return!y||Array.isArray(y)&&0===y.length&&!e.includes("search")?null:(((e,t,a="LIST")=>{if(P.size>=200){const e=P.keys().next().value;e&&P.delete(e)}P.set(e,{data:t,timestamp:Date.now(),type:a,accessCount:0,lastAccessed:Date.now()})})(o,y,c),D=Date.now(),y)}catch(n){performance.now();const t=L(n);if(t.retryable&&3>a){const i=j(a,t.type);return await r(i),s(e,a+1)}const o=Error("Request failed: "+t.userMessage);throw o.originalError=n,o.networkError=t,o.requestId=i,o.attempts=a,o.url=e,o}};return s(e)},U=e=>{if(!e)return null;const t={28:"Action",12:"Adventure",16:"Animation",35:"Comedy",80:"Crime",99:"Documentary",18:"Drama",10751:"Family",14:"Fantasy",36:"History",27:"Horror",10402:"Music",9648:"Mystery",10749:"Romance",878:"Science Fiction",10770:"TV Movie",53:"Thriller",10752:"War",37:"Western",10759:"Action & Adventure",10762:"Kids",10763:"News",10764:"Reality",10765:"Sci-Fi & Fantasy",10766:"Soap",10767:"Talk",10768:"War & Politics"},a=e=>{if(!e||0>=e)return null;const t=Math.floor(e/60),a=e%60;return 0===t?a+"m":0===a?t+"h":`${t}h ${a}m`},r=e=>{if(null==e||isNaN(e))return"0.0";const t=parseFloat(e);return isNaN(t)?"0.0":t.toFixed(1)},s=(e,t="w500")=>{if(!e)return null;const a=e.startsWith("/")?e:"/"+e;return`${v}/${t}${a}`},i=e=>e.title||e.name||e.original_title||e.original_name||"Untitled";try{const c=(e=>{if(!e)return null;try{const t=new Date(e);return isNaN(t.getTime())?null:t}catch(t){return null}})(e.release_date),l=(o=e.genre_ids)&&Array.isArray(o)?o.map((e=>t[e]||`Unknown Genre (${e})`)).filter(Boolean):[];return{id:e.id||null,title:i(e),overview:(n=e.overview,n?n.length>500?n.substring(0,500)+"...":n:""),poster:s(e.poster_path,"w500"),backdrop:s(e.backdrop_path,"original"),rating:r(e.vote_average),year:c?c.getFullYear():null,duration:a(e.runtime),runtime:e.runtime||0,genres:l,genre_ids:e.genre_ids||[],type:e.media_type||"movie",trailer:null,releaseDate:e.release_date||null,status:e.status||"Released",voteCount:e.vote_count||0,popularity:e.popularity||0,originalLanguage:e.original_language||"en",originalTitle:e.original_title||e.original_name||i(e),director:null,cast:null,adult:e.adult||!1,video:e.video||!1,budget:e.budget||0,revenue:e.revenue||0,tagline:e.tagline||"",productionCompanies:e.production_companies?.map((e=>({id:e.id,name:e.name,logoPath:s(e.logo_path,"w185"),originCountry:e.origin_country})))||[],productionCountries:e.production_countries?.map((e=>({iso31661:e.iso_3166_1,name:e.name})))||[],spokenLanguages:e.spoken_languages?.map((e=>({iso6391:e.iso_639_1,name:e.name})))||[],isProcessed:!0,processedAt:(new Date).toISOString()}}catch(c){return{id:e.id||null,title:i(e),overview:"",poster:null,backdrop:null,rating:"0.0",year:null,duration:null,runtime:0,genres:[],genre_ids:[],type:"movie",error:c.message,isProcessed:!1}}var n,o},z=e=>{if(!e)return null;try{const t={10759:"Action & Adventure",16:"Animation",35:"Comedy",80:"Crime",99:"Documentary",18:"Drama",10751:"Family",10762:"Kids",9648:"Mystery",10763:"News",10764:"Reality",10765:"Sci-Fi & Fantasy",10766:"Soap",10767:"Talk",10768:"War & Politics",37:"Western",10770:"TV Movie",28:"Action",12:"Adventure",14:"Fantasy",27:"Horror",10402:"Music",10749:"Romance",878:"Science Fiction",53:"Thriller",10752:"War"},a=e=>e&&Array.isArray(e)?e.map((e=>t[e]||`Unknown Genre (${e})`)).filter(Boolean):[],r=e=>{if(!e)return null;try{const t=new Date(e);return isNaN(t.getTime())?null:t}catch(t){return null}},s=e=>{if(!e||0>=e)return null;const t=Math.floor(e/60),a=e%60;return t>0?`${t}h ${a}m`:a+"m"},i=(e,t="w500")=>{if(!e)return null;const a=e.startsWith("/")?e:"/"+e;return`${v}/${t}${a}`},n=e=>e.name||e.title||e.original_name||"Unknown Title",o=e=>e&&Array.isArray(e)?e.map((e=>({id:e.id,name:e.name,logoPath:i(e.logo_path,"w185"),originCountry:e.origin_country,headquarters:e.headquarters||null,homepage:e.homepage||null}))):[],c=e=>e&&Array.isArray(e)?e.map((e=>({id:e.id,name:e.name,overview:e.overview||"",airDate:r(e.air_date),episodeNumber:e.episode_number||0,seasonNumber:e.season_number||0,stillPath:i(e.still_path,"w300"),runtime:e.runtime||0,voteAverage:e.vote_average||0,voteCount:e.vote_count||0}))):[],l=e=>e&&Array.isArray(e)?e.map((e=>({id:e.id,name:e.name,overview:e.overview||"",airDate:r(e.air_date),seasonNumber:e.season_number||0,episodeCount:e.episode_count||0,posterPath:i(e.poster_path,"w500"),episodes:c(e.episodes||[])}))):[],u=e=>({"Returning Series":{status:"Returning Series",color:"green",description:"Currently airing new episodes"},Ended:{status:"Ended",color:"red",description:"Series has concluded"},Canceled:{status:"Canceled",color:"orange",description:"Series was canceled"},"In Production":{status:"In Production",color:"blue",description:"Currently in production"},Planned:{status:"Planned",color:"purple",description:"Planned for future release"},Pilot:{status:"Pilot",color:"gray",description:"Pilot episode only"}}[e]||{status:e||"Unknown",color:"gray",description:"Status unknown"}),h=r(e.first_air_date),m=u(e.status),d=a(e.genre_ids||e.genres?.map((e=>e.id))||[]);return{id:e.id,title:n(e),overview:e.overview||"",poster:i(e.poster_path,"w500"),backdrop:i(e.backdrop_path,"original"),rating:e.vote_average?e.vote_average.toFixed(1):"0.0",year:h?h.getFullYear():null,duration:s(e.episode_run_time?.[0]),runtime:e.episode_run_time?.[0]||0,genres:d,genre_ids:e.genre_ids||e.genres?.map((e=>e.id))||[],type:"tv",trailer:null,network:e.networks?.[0]?.name||null,networks:o(e.networks),seasons:e.number_of_seasons||0,episodes:e.number_of_episodes||0,status:m.status,statusColor:m.color,statusDescription:m.description,lastAirDate:r(e.last_air_date),nextEpisodeDate:r(e.next_episode_to_air?.air_date),voteCount:e.vote_count||0,popularity:e.popularity||0,originalLanguage:e.original_language||"en",originalTitle:e.original_name||n(e),director:null,cast:null,createdBy:e.created_by?.map((e=>({id:e.id,name:e.name,profilePath:i(e.profile_path,"w185"),gender:e.gender||null,creditId:e.credit_id})))||[],productionCompanies:e.production_companies?.map((e=>({id:e.id,name:e.name,logoPath:i(e.logo_path,"w185"),originCountry:e.origin_country})))||[],productionCountries:e.production_countries?.map((e=>({iso31661:e.iso_3166_1,name:e.name})))||[],spokenLanguages:e.spoken_languages?.map((e=>({iso6391:e.iso_639_1,name:e.name})))||[],episodeRunTime:e.episode_run_time||[],seasonsData:l(e.seasons||[]),isProcessed:!0,processedAt:(new Date).toISOString()}}catch(t){return{id:e.id||null,title:e.name||"Unknown Title",overview:"",poster:null,backdrop:null,rating:"0.0",year:null,duration:null,runtime:0,genres:[],genre_ids:[],type:"tv",error:t.message,isProcessed:!1}}},B=async(e,t="movie")=>{try{if(be.has(`${t}_${e}`))return null;const a="movie"===t?"movie":"tv",r=await F(`${w}/${a}/${e}?api_key=${f}&append_to_response=videos,credits,similar,images&include_image_language=en`);if(!r)return be.add(`${t}_${e}`),null;const s="movie"===t?U(r):z(r);if(!s)throw Error("Failed to transform data");const i=r.images?.logos?.find((e=>"en"===e.iso_639_1))||r.images?.logos?.[0],n=i?`${v}/w300${i.file_path.startsWith("/")?i.file_path:"/"+i.file_path}`:null,o=r.backdrop_path?`${v}/w1280${r.backdrop_path.startsWith("/")?r.backdrop_path:"/"+r.backdrop_path}`:null,c=r.videos?.results?.find((e=>"Trailer"===e.type&&"YouTube"===e.site))?.key,l=r.credits?.cast?.slice(0,6).map((e=>({id:e.id,name:e.name,character:e.character,image:e.profile_path?`${v}/w185${e.profile_path.startsWith("/")?e.profile_path:"/"+e.profile_path}`:null})))||[],u=r.credits?.crew?.find((e=>"Director"===e.job))?.name,h=r.similar?.results?.slice(0,6).map((e=>"movie"===t?U(e):z(e))).filter(Boolean)||[],m=r.production_companies?.map((e=>({id:e.id,name:e.name,logo_path:e.logo_path?`${v}/w185${e.logo_path.startsWith("/")?e.logo_path:"/"+e.logo_path}`:null,origin_country:e.origin_country})))||[],d=r.spoken_languages?.map((e=>({iso_639_1:e.iso_639_1,name:e.name,english_name:e.english_name})))||[],p=r.genres?.map((e=>({id:e.id,name:e.name})))||[];return{...s,logo:n,backdrop:o,trailer:c,cast:l,director:u,similar:h,production_companies:m,spoken_languages:d,genres:p,budget:r.budget,revenue:r.revenue,runtime:r.runtime,status:r.status,homepage:r.homepage,release_date:r.release_date||r.first_air_date,last_air_date:r.last_air_date,number_of_seasons:r.number_of_seasons,number_of_episodes:r.number_of_episodes,networks:r.networks?.map((e=>({id:e.id,name:e.name,logo_path:e.logo_path?`${v}/w185${e.logo_path.startsWith("/")?e.logo_path:"/"+e.logo_path}`:null,origin_country:e.origin_country})))||[],created_by:r.created_by,episode_run_time:r.episode_run_time,next_episode_to_air:r.next_episode_to_air,seasons:r.seasons}}catch(a){throw a}},q=async(e,t="movie")=>{try{const a="movie"===t?"movie":"tv";return await F(`${w}/${a}/${e}/credits?api_key=${f}&language=en-US`)||null}catch(a){throw a}},W=async(e,t="movie")=>{if(!e)return null;const a=`${w}/${t}/${e}/videos`;return await F(a,{},"DETAILS")||null},V=async(e,t="movie",a=1,r={})=>{if(!e)return null;if(be.has(`${t}_${e}`))return null;try{const r=`${w}/${t}/${e}/recommendations?page=${a}`;let i=null;try{i=await F(r,{},"LIST")}catch(s){if(404===s.status||s.message.includes("404"))return be.add(`${t}_${e}`),null}const n=`${w}/${t}/${e}/similar?page=${a}`;let o=null;try{o=await F(n,{},"LIST")}catch(s){if((404===s.status||s.message.includes("404"))&&!i)return be.add(`${t}_${e}`),null}if(!i&&!o)return be.add(`${t}_${e}`),null;const c=[],l=new Set;return i&&i.results&&i.results.forEach((e=>{e&&e.id&&!l.has(e.id)&&(l.add(e.id),c.push(e))})),o&&o.results&&o.results.forEach((e=>{e&&e.id&&!l.has(e.id)&&(l.add(e.id),c.push(e))})),c.length>0?{page:a,results:c,total_pages:Math.max(i?.total_pages||1,o?.total_pages||1),total_results:c.length}:i||o||null}catch(s){if(404===s.status||s.message.includes("404"))return be.add(`${t}_${e}`),null;try{const r=`${w}/${t}/${e}/recommendations?page=${a}`;return await F(r,{},"LIST")||(be.add(`${t}_${e}`),null)}catch(i){if(404===i.status||i.message.includes("404"))return be.add(`${t}_${e}`),null;throw i}}},Q=async(t=1)=>{const a=e=>new Promise((t=>setTimeout(t,e))),r=async(e,t=1)=>{try{const a=await C(e,t);return await a.json()}catch(a){throw a}};try{const i=await r(`${e()}/tmdb/trending?media_type=all&time_window=day&page=${t}`);if(!i?.results)throw Error("Invalid trending movies response");const n=new Map;i.results.forEach((e=>{if(!n.has(e.id)){const t="movie"===e.media_type?U(e):z(e);t&&n.set(e.id,t)}}));const o=Array.from(n.values()),c=o.slice(0,6),l=o.slice(6),u=[];for(const e of c)try{const t=await B(e.id,e.type);u.push({...e,director:t.director,cast:t.cast?.slice(0,3),genres:t.genres||e.genres,duration:"movie"===e.type?t.runtime?`${Math.floor(t.runtime/60)}h ${t.runtime%60}m`:null:t.episode_run_time?.[0]?`${Math.floor(t.episode_run_time[0]/60)}h ${t.episode_run_time[0]%60}m`:null,network:t.networks?.[0]?.name||null,seasons:t.number_of_seasons||null,episodes:t.number_of_episodes||null,status:t.status||null,nextEpisodeDate:t.next_episode_to_air?.air_date||null,logo:t.logo||e.logo}),await a(100)}catch(s){u.push(e)}const h=[...u,...l];return[{network:"Netflix",id:213},{network:"HBO",id:49},{network:"Prime",id:1024},{network:"Disney+",id:2739},{network:"Apple TV+",id:2552},{network:"Hulu",id:453}].forEach((({network:e,id:i},o)=>{(async(e,t=!1,a={},r={})=>{const i=Math.random().toString(36).substr(2,9),n=Date.now(),o=r.batchKey;if(o&&x.has(o)){const r=x.get(o);return r.requests.push({request:e,priority:t,metadata:a,requestId:i,timestamp:n}),new Promise(((e,t)=>{r.promises.push({resolve:e,reject:t})}))}if(o){const r={requests:[{request:e,priority:t,metadata:a,requestId:i,timestamp:n}],promises:[],timeout:setTimeout((()=>{(async e=>{const t=x.get(e);t&&(x.delete(e),clearTimeout(t.timeout),t.requests.sort(((e,t)=>(t.priority?1:0)-(e.priority?1:0))),(await Promise.allSettled(t.requests.map((e=>e.request())))).forEach(((e,a)=>{const{resolve:r,reject:s}=t.promises[a];"fulfilled"===e.status?r(e.value):s(e.reason)})))})(o)}),50)};return x.set(o,r),new Promise(((e,t)=>{r.promises.push({resolve:e,reject:t})}))}const c=async(t=1)=>{try{const a=Date.now()-D;$>a&&await new Promise((e=>setTimeout(e,$-a))),D=Date.now();const r=Date.now()-(window.lastNetworkCheck||0);if(1===t&&r>3e4){const e=await O();if(window.lastNetworkCheck=Date.now(),!e)throw Error("No network connectivity")}const i=new AbortController,n=setTimeout((()=>i.abort()),15e3);try{const t=await e();return clearTimeout(n),t}catch(s){throw clearTimeout(n),s}}catch(s){const a=L(s);if(2>t&&a.retryable){const e=j(t,a.type);return await new Promise((t=>setTimeout(t,e))),c(t+1)}throw Error(a.userMessage)}};t?R.unshift(c):R.push(c),N(),c()})((async()=>{try{await a(200*(o+1));const e=await r(`${w}/discover/tv?with_networks=${i}&sort_by=popularity.desc&page=${t}&api_key=${f}`);if(e?.results){const t=e.results.map((e=>{if(!n.has(e.id)){const t=z(e);if(t)return n.set(e.id,t),t}return null})).filter(Boolean);h.push(...t)}}catch(s){}}),!1)})),{movies:h,totalPages:i.total_pages||1,currentPage:t,totalResults:h.length}}catch(s){return{movies:[],totalPages:1,currentPage:t,totalResults:0,error:s.message}}},G=async(t=1)=>{const a=e=>new Promise((t=>setTimeout(t,e))),r=async(e,t=1)=>{try{const s=await fetch(e);if(!s.ok){if(429===s.status){const e=parseInt(s.headers.get("Retry-After"))||60;await a(1e3*e)}else if(s.status>=500&&3>=t){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){if(3>=t&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw s}};try{const a=await r(`${e()}/tmdb/popular?media_type=movie&page=${t}&include_adult=false&language=en-US&region=US`);if(!a||!a.results)throw Error("Invalid API response structure");const s=a.results.filter((e=>e&&e.id&&e.title)).map(U).filter(Boolean);return{movies:s,totalPages:a.total_pages||1,currentPage:a.page||t,totalResults:a.total_results||s.length,hasMore:(a.page||t)<(a.total_pages||1)}}catch(s){return{movies:[],totalPages:1,currentPage:t,totalResults:0,hasMore:!1,error:s.message}}},J=async(t=1)=>{const a=async(e,t=1)=>{try{const t=await fetch(e);if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(s){if(3>=t&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await(r=s,new Promise((e=>setTimeout(e,r)))),a(e,t+1)}throw s}var r};try{const r=await a(`${e()}/tmdb/top-rated?media_type=movie&page=${t}&include_adult=false&language=en-US&region=US`);if(!r||!r.results)throw Error("Invalid API response structure");const s=r.results.filter((e=>e&&e.id&&e.title)).map(U).filter(Boolean);return{movies:s,totalPages:r.total_pages||1,currentPage:r.page||t,totalResults:r.total_results||s.length,hasMore:(r.page||t)<(r.total_pages||1)}}catch(r){return{movies:[],totalPages:1,currentPage:t,totalResults:0,hasMore:!1,error:r.message}}},Y=new Map,K=async(e=1)=>{const t="upcoming_"+e,a=Y.get(t);if(a&&3e5>Date.now()-a.timestamp)return a.data;const r=async(e,t=1)=>{try{const t=await fetch(e);if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(s){if(3>=t&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await(a=s,new Promise((e=>setTimeout(e,a)))),r(e,t+1)}throw s}var a};try{const a=Array.from({length:5},((t,a)=>r(`${w}/movie/upcoming?api_key=${f}&language=en-US&page=${e+a}&region=US&include_adult=false`).catch((e=>({results:[]}))))),s=await Promise.all(a),i=s.flatMap((e=>e?.results||[])),n=new Date;n.setHours(0,0,0,0);const o=i.filter((e=>{if(!e?.release_date||!e?.id||!e?.title)return!1;try{const t=new Date(e.release_date);return!isNaN(t.getTime())&&(t.setHours(0,0,0,0),t>n)}catch(t){return!1}}));o.sort(((e,t)=>{try{const a=new Date(e.release_date),r=new Date(t.release_date);if(isNaN(a.getTime())||isNaN(r.getTime()))return(t.popularity||0)-(e.popularity||0);const s=a-r;return 0!==s?s:(t.popularity||0)-(e.popularity||0)}catch(a){return 0}}));const c=o.reduce(((e,t)=>(e.some((e=>e.id===t.id))||e.push(t),e)),[]).map((e=>{try{return U(e)}catch(t){return null}})).filter(Boolean),l=20,u=(e-1)*l,h=u+l,m=c.slice(u,h),d=Math.max(e+1,Math.ceil(c.length/l)),p=c.length>h,g={movies:m,totalPages:d,currentPage:e,totalResults:c.length,hasMore:p,fetchedPages:5,uniqueMoviesCount:c.length,transformedMoviesCount:m.length,errors:s.filter((e=>e.error)).length};return Y.set(t,{data:g,timestamp:Date.now()}),g}catch(s){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,error:s.message,errorType:s.name,timestamp:(new Date).toISOString(),fetchedPages:0,uniqueMoviesCount:0,transformedMoviesCount:0}}},Z=async(e="en-US",t=!0)=>{const a=`genres_${e}_${t}`;try{const i=localStorage.getItem(a);if(i){const{data:e,timestamp:t}=JSON.parse(i);if(864e5>Date.now()-t)return e}let n=(await F(`${w}/genre/movie/list?api_key=${f}&language=${e}`)).genres||[];if(t)try{const t=(await F(`${w}/genre/tv/list?api_key=${f}&language=${e}`)).genres||[],a=new Map;n.forEach((e=>{a.set(e.id,{...e,type:"movie"})})),t.forEach((e=>{if(a.has(e.id)){const t=a.get(e.id);a.set(e.id,{...t,type:"both"})}else a.set(e.id,{...e,type:"tv"})})),n=Array.from(a.values())}catch(r){}const o=n.map((e=>({...e,slug:e.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),displayName:e.name,count:0,popularity:0,lastUpdated:(new Date).toISOString()}))),c={genres:o,total:o.length,language:e,includeTV:t,fetchedAt:(new Date).toISOString(),metadata:{movieGenres:n.filter((e=>"movie"===e.type||"both"===e.type)).length,tvGenres:n.filter((e=>"tv"===e.type||"both"===e.type)).length,sharedGenres:n.filter((e=>"both"===e.type)).length}};try{localStorage.setItem(a,JSON.stringify({data:c,timestamp:Date.now()}))}catch(s){}return c}catch(i){const a=[{id:28,name:"Action",type:"movie",slug:"action"},{id:35,name:"Comedy",type:"movie",slug:"comedy"},{id:18,name:"Drama",type:"movie",slug:"drama"},{id:27,name:"Horror",type:"movie",slug:"horror"},{id:10749,name:"Romance",type:"movie",slug:"romance"},{id:878,name:"Science Fiction",type:"movie",slug:"science-fiction"}];return{genres:a,total:a.length,language:e,includeTV:t,error:i.message,errorType:i.name,timestamp:(new Date).toISOString(),isFallback:!0,metadata:{movieGenres:a.length,tvGenres:0,sharedGenres:0}}}},X=async(e,t=1)=>{const a=e=>new Promise((t=>setTimeout(t,e))),r=async(e,t=1)=>{try{const s=await fetch(e);if(!s.ok){if(429===s.status){const e=parseInt(s.headers.get("Retry-After"))||60;await a(1e3*e)}else if(s.status>=500&&3>=t){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){if(3>=t&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw s}};try{const s=await r(`${w}/discover/movie?api_key=${f}&with_genres=${e}&page=${t}&sort_by=popularity.desc&include_adult=false&language=en-US&region=US&vote_count.gte=10`);if(!s||!s.results)throw Error("Invalid API response structure");const i=s.results.filter((e=>e&&e.id&&e.title)).map(U).filter(Boolean),n=async(e,t,r)=>{const s=e.slice(t,t+r),i=[];for(let o=0;o<s.length;o++){const e=s[o];try{o>0&&await a(100);const t=await B(e.id,"movie"),r={...e,runtime:t?.runtime||0,duration:t?.runtime?`${Math.floor(t.runtime/60)}h ${t.runtime%60}m`:null,budget:t?.budget||0,revenue:t?.revenue||0,status:t?.status||"Unknown",homepage:t?.homepage||null,production_companies:t?.production_companies||[],spoken_languages:t?.spoken_languages||[],cast:t?.cast||[],director:t?.director||null,trailer:t?.trailer||null,logo:t?.logo||null,backdrop:t?.backdrop||e.backdrop};i.push(r)}catch(n){i.push({...e,runtime:0,duration:null,error:n.message})}}return i},o=await n(i,0,8),c=i.slice(8),l=[...o,...c];return{movies:l,totalPages:s.total_pages||1,currentPage:s.page||t,totalResults:s.total_results||l.length,hasMore:(s.page||t)<(s.total_pages||1),genreId:e,metadata:{processedWithDetails:o.length,totalProcessed:l.length,averageRuntime:o.length>0?Math.round(o.reduce(((e,t)=>e+(t.runtime||0)),0)/o.length):0,processedAt:(new Date).toISOString()}}}catch(s){return{movies:[],totalPages:1,currentPage:t,totalResults:0,hasMore:!1,genreId:e,error:s.message,errorType:s.name,timestamp:(new Date).toISOString(),metadata:{processedWithDetails:0,totalProcessed:0,averageRuntime:0,isError:!0}}}},ee=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),15e3),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","User-Agent":"Streamr-App/1.0"}});if(clearTimeout(i),!n.ok){if(429===n.status){const e=parseInt(n.headers.get("Retry-After"))||60;await t(1e3*e)}else if(n.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if("AbortError"===s.name)throw Error("Request timeout - please check your connection");if(s.message.includes("ERR_CONNECTION_RESET")||s.message.includes("Failed to fetch")||s.message.includes("NetworkError")||s.message.includes("ERR_NETWORK")){if(3>=r){const s=Math.min(1e3*Math.pow(2,r-1),4e3);return await t(s),a(e,r+1)}throw Error("Network connection failed - please check your internet connection")}if(3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/discover/movie?api_key=${f}&with_genres=28&page=${e}&language=en-US&sort_by=popularity.desc&include_adult=false&vote_count.gte=50&vote_average.gte=5.0`);if(!t||!t.results)throw Error("Invalid API response structure for action movies");const r=t.results.filter((e=>{if(!e||!e.id||!e.title)return!1;const t=e.genre_ids&&e.genre_ids.includes(28),a=e.vote_average>=5,r=e.vote_count>=50;return t&&a&&r})).map(U).filter(Boolean);return{movies:r,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||r.length,hasMore:(t.page||e)<(t.total_pages||1),genreId:28,genreName:"Action",metadata:{averageRating:r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/r.length*10)/10:0,averageVoteCount:r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,releaseYearRange:r.length>0?{min:Math.min(...r.map((e=>e.year||0)).filter((e=>e>0))),max:Math.max(...r.map((e=>e.year||0)).filter((e=>e>0)))}:null,processedAt:(new Date).toISOString(),filterCriteria:{minRating:5,minVoteCount:50,sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,genreId:28,genreName:"Action",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{minRating:5,minVoteCount:50,sortBy:"popularity.desc"}}}}},te=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=await fetch(e);if(!s.ok){if(429===s.status){const e=parseInt(s.headers.get("Retry-After"))||60;await t(1e3*e)}else if(s.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){if(3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/discover/movie?api_key=${f}&with_genres=35&page=${e}&sort_by=popularity.desc&include_adult=false&language=en-US&region=US&vote_count.gte=10&vote_average.gte=5.0`);if(!t||!t.results)throw Error("Invalid API response structure");const r=t.results.filter((e=>e&&e.id&&e.title&&e.genre_ids?.includes(35))).map(U).filter(Boolean),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>e.year||0)).filter((e=>e>0))),max:Math.max(...r.map((e=>e.year||0)).filter((e=>e>0)))}:null;return{movies:r,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||r.length,hasMore:(t.page||e)<(t.total_pages||1),genreId:35,genreName:"Comedy",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{minRating:5,minVoteCount:10,sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,genreId:35,genreName:"Comedy",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{minRating:5,minVoteCount:10,sortBy:"popularity.desc"}}}}},ae=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=await fetch(e);if(!s.ok){if(429===s.status){const e=parseInt(s.headers.get("Retry-After"))||60;await t(1e3*e)}else if(s.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){if(3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/discover/movie?api_key=${f}&with_genres=18&page=${e}&language=en-US&sort_by=popularity.desc&include_adult=false&vote_count.gte=10&vote_average.gte=5.0`);if(!t||!t.results)throw Error("Invalid API response structure for drama movies");const r=t.results.filter((e=>{if(!e||!e.id||!e.title)return!1;const t=e.genre_ids&&e.genre_ids.includes(18),a=e.vote_average>=5,r=e.vote_count>=10;return t&&a&&r})).map(U).filter(Boolean),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>e.year||0)).filter((e=>e>0))),max:Math.max(...r.map((e=>e.year||0)).filter((e=>e>0)))}:null;return{movies:r,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||r.length,hasMore:(t.page||e)<(t.total_pages||1),genreId:18,genreName:"Drama",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{minRating:5,minVoteCount:10,sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,genreId:18,genreName:"Drama",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{minRating:5,minVoteCount:10,sortBy:"popularity.desc"}}}}},re=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=await fetch(e);if(!s.ok){if(429===s.status){const e=parseInt(s.headers.get("Retry-After"))||60;await t(1e3*e)}else if(s.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){if(3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/discover/movie?api_key=${f}&with_genres=27&page=${e}&language=en-US&sort_by=popularity.desc&include_adult=false&vote_count.gte=30&vote_average.gte=4.5`);if(!t||!t.results)throw Error("Invalid API response structure for horror movies");const r=t.results.filter((e=>{if(!e||!e.id||!e.title)return!1;const t=e.genre_ids&&e.genre_ids.includes(27),a=e.vote_average>=4.5,r=e.vote_count>=30;return t&&a&&r})).map(U).filter(Boolean),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>new Date(e.release_date).getFullYear()))),max:Math.max(...r.map((e=>new Date(e.release_date).getFullYear())))}:null;return{movies:r,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||r.length,hasMore:(t.page||e)<(t.total_pages||1),genreId:27,genreName:"Horror",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{minRating:4.5,minVoteCount:30,sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,genreId:27,genreName:"Horror",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{minRating:4.5,minVoteCount:30,sortBy:"popularity.desc"}}}}},se=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=await fetch(e);if(!s.ok){if(429===s.status){const e=parseInt(s.headers.get("Retry-After"))||60;await t(1e3*e)}else if(s.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){if(3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/discover/movie?api_key=${f}&with_genres=878&page=${e}&language=en-US&sort_by=popularity.desc&include_adult=false&vote_count.gte=20&vote_average.gte=4.5`);if(!t||!t.results)throw Error("Invalid API response structure for Sci-Fi movies");const r=t.results.filter((e=>{if(!e||!e.id||!e.title)return!1;const t=e.genre_ids&&e.genre_ids.includes(878),a=e.vote_average>=4.5,r=e.vote_count>=20;return t&&a&&r})).map(U).filter(Boolean),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>e.year||0)).filter((e=>e>0))),max:Math.max(...r.map((e=>e.year||0)).filter((e=>e>0)))}:null;return{movies:r,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||r.length,hasMore:(t.page||e)<(t.total_pages||1),genreId:878,genreName:"Science Fiction",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{minRating:4.5,minVoteCount:20,sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,genreId:878,genreName:"Science Fiction",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{minRating:4.5,minVoteCount:20,sortBy:"popularity.desc"}}}}},ie=async(e=1)=>X(99,e),ne=async(e=1)=>X(10751,e),oe=async(e=1)=>X(16,e),ce=async(e=1)=>{try{const t=await F(`${w}/discover/movie?api_key=${f}&page=${e}&language=en-US&sort_by=vote_average.desc&vote_count.gte=1000&include_adult=true`);if(!t||!t.results)throw Error("Invalid API response for award winning movies");const a=t.results.map(U).filter(Boolean);return{movies:a,totalPages:t.total_pages||1,currentPage:t.page||1,totalResults:t.total_results||a.length}}catch(t){return{movies:[],totalPages:1,currentPage:e,totalResults:0,error:t.message}}},le=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=await fetch(e);if(!s.ok){if(429===s.status){const e=parseInt(s.headers.get("Retry-After"))||60;await t(1e3*e)}else if(s.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){if(3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/movie/now_playing?api_key=${f}&page=${e}&language=en-US&region=US&include_adult=false`);if(!t||!t.results)throw Error("Invalid API response structure for latest movies");const r=t.results.filter((e=>e&&e.id&&e.title)).map(U).filter(Boolean),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>e.year||0)).filter((e=>e>0))),max:Math.max(...r.map((e=>e.year||0)).filter((e=>e>0)))}:null;return{movies:r,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||r.length,hasMore:(t.page||e)<(t.total_pages||1),genreId:null,genreName:"Latest Releases",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{region:"US",includeAdult:!1,sortBy:"release_date.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,genreId:null,genreName:"Latest Releases",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{region:"US",includeAdult:!1,sortBy:"release_date.desc"}}}}},ue=async(e,t=1)=>{const a=["popular","top_rated","upcoming","now_playing","collections","netflix","prime","hbo","hulu","disney","apple"],r=e=>new Promise((t=>setTimeout(t,e))),s=async(e,t=1)=>{try{const a=new AbortController,i=setTimeout((()=>a.abort()),8e3),n=await fetch(e,{signal:a.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const a=parseInt(n.headers.get("Retry-After"))||60;return await r(1e3*a),s(e,t+1)}if(n.status>=500&&3>=t){const a=Math.min(1e3*Math.pow(2,t-1),5e3);return await r(a),s(e,t+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(a){if(3>=t&&"TypeError"!==a.name&&"AbortError"!==a.name){const a=Math.min(1e3*Math.pow(2,t-1),5e3);return await r(a),s(e,t+1)}throw a}};try{const r=e.toLowerCase().replace(/[^a-z_]/g,"");if(!a.includes(r))throw Error(`Invalid category: ${e}. Valid categories are: ${a.join(", ")}`);if("upcoming"===r){const e=await s(`${w}/movie/${r}?api_key=${f}&language=en-US&page=${t}&region=US&include_adult=false`);if(!e||!e.results)throw Error("Invalid API response structure for category: "+r);const a=new Date;a.setHours(0,0,0,0);const i=e.results.filter((e=>{if(!e?.release_date||!e?.id||!e?.title)return!1;try{const t=new Date(e.release_date);return!isNaN(t.getTime())&&(t.setHours(0,0,0,0),t>a)}catch(t){return!1}})),n=e.total_pages||1,o=n>t;return{movies:i,totalPages:n,currentPage:t,totalResults:e.total_results||i.length,hasMore:o}}if(["netflix","prime","hbo","hulu","disney","apple"].includes(r)){const e={netflix:8,prime:119,hbo:384,hulu:15,disney:220,apple:350}[r];try{const a=await fe(e,t);return{movies:a.results||[],totalPages:a.totalPages||1,currentPage:a.page||t,totalResults:a.totalResults||0,hasMore:a.hasMore||!1}}catch(i){return{movies:[],totalPages:1,currentPage:t,totalResults:0,hasMore:!1,error:i.message}}}if("collections"===r)try{const e=await Pe(t);return{collections:e.collections||[],totalPages:e.totalPages||1,currentPage:e.currentPage||t,totalResults:e.totalResults||0,hasMore:e.hasMore||!1}}catch(i){return{collections:[],totalPages:1,currentPage:t,totalResults:0,hasMore:!1,error:i.message}}const n=await s(`${w}/movie/${r}?api_key=${f}&language=en-US&page=${t}&region=US&include_adult=false`);if(!n||!n.results)throw Error("Invalid API response structure for category: "+r);const o=n.results.filter((e=>e&&e.id&&e.title&&e.poster_path&&e.release_date&&e.vote_average>=0)),c=o.length>0?Math.round(o.reduce(((e,t)=>e+parseFloat(t.vote_average||0)),0)/o.length*10)/10:0,l=o.length>0?Math.round(o.reduce(((e,t)=>e+(t.vote_count||0)),0)/o.length):0,u=o.length>0?{min:Math.min(...o.map((e=>new Date(e.release_date).getFullYear())).filter((e=>e>1900))),max:Math.max(...o.map((e=>new Date(e.release_date).getFullYear())).filter((e=>e>1900)))}:null;return{movies:o,totalPages:n.total_pages||1,currentPage:n.page||t,totalResults:n.total_results||o.length,hasMore:(n.page||t)<(n.total_pages||1),category:r,categoryDisplayName:r.split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "),metadata:{averageRating:c,averageVoteCount:l,releaseYearRange:u,processedAt:(new Date).toISOString(),filterCriteria:{region:"US",includeAdult:!1,language:"en-US"}}}}catch(i){return{movies:[],totalPages:1,currentPage:t,totalResults:0,hasMore:!1,category:e?.toLowerCase().replace(/[^a-z_]/g,"")||"unknown",categoryDisplayName:e||"Unknown Category",error:i.message,errorType:i.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{region:"US",includeAdult:!1,language:"en-US"}}}}},he=async({with_genres:e,primary_release_year:t,primary_release_date_gte:a,primary_release_date_lte:r,sort_by:s="popularity.desc",page:i=1,vote_count_gte:n=10,vote_average_gte:o=0,include_adult:c=!1,with_keywords:l,without_keywords:u,with_cast:h,with_crew:m,with_companies:d,with_runtime_gte:p,with_runtime_lte:g,with_release_type:y,with_original_language:v,with_watch_providers:_,watch_region:b="US"})=>{const T=e=>new Promise((t=>setTimeout(t,e))),S=async(e,t=1)=>{try{const a=new AbortController,r=setTimeout((()=>a.abort()),15e3),s=await fetch(e,{signal:a.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(r),!s.ok){if(429===s.status){const a=parseInt(s.headers.get("Retry-After"))||60;return await T(1e3*a),S(e,t+1)}if(s.status>=500&&3>=t){const a=Math.min(1e3*Math.pow(2,t-1),5e3);return await T(a),S(e,t+1)}throw Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(a){if(a.name,3>=t&&"TypeError"!==a.name){const a=Math.min(1e3*Math.pow(2,t-1),5e3);return await T(a),S(e,t+1)}throw a}};try{const T=new URLSearchParams({api_key:f,language:"en-US",sort_by:s,page:i.toString(),include_adult:c.toString(),vote_count_gte:n.toString(),vote_average_gte:o.toString(),watch_region:b});e&&T.append("with_genres",e),t&&T.append("primary_release_year",t.toString()),a&&T.append("primary_release_date_gte",a.toString()),r&&T.append("primary_release_date_lte",r.toString()),l&&T.append("with_keywords",l),u&&T.append("without_keywords",u),h&&T.append("with_cast",h),m&&T.append("with_crew",m),d&&T.append("with_companies",d),p&&T.append("with_runtime_gte",p.toString()),g&&T.append("with_runtime_lte",g.toString()),y&&T.append("with_release_type",y),v&&T.append("with_original_language",v),_&&T.append("with_watch_providers",_);const k=`${w}/discover/movie?${T.toString()}`,M=await S(k);if(!M||!M.results)throw Error("Invalid API response structure for movie discovery");const C=M.results.map(U).filter(Boolean),P=C.length>0?Math.round(C.reduce(((e,t)=>e+(t.vote_average||0)),0)/C.length*10)/10:0,E=C.length>0?Math.round(C.reduce(((e,t)=>e+(t.vote_count||0)),0)/C.length):0,R=C.length>0?{min:Math.min(...C.map((e=>new Date(e.release_date).getFullYear()))),max:Math.max(...C.map((e=>new Date(e.release_date).getFullYear())))}:null;return{movies:C,totalPages:M.total_pages||1,currentPage:M.page||i,totalResults:M.total_results||C.length,hasMore:(M.page||i)<(M.total_pages||1),metadata:{averageRating:P,averageVoteCount:E,releaseYearRange:R,processedAt:(new Date).toISOString(),filterCriteria:{with_genres:e,primary_release_year:t,primary_release_date_gte:a,primary_release_date_lte:r,sort_by:s,vote_count_gte:n,vote_average_gte:o,include_adult:c,watch_region:b}}}}catch(k){return{movies:[],totalPages:1,currentPage:i,totalResults:0,hasMore:!1,error:k.message,errorType:k.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{with_genres:e,primary_release_year:t,primary_release_date_gte:a,primary_release_date_lte:r,sort_by:s,vote_count_gte:n,vote_average_gte:o,include_adult:c,watch_region:b}}}}},me=async(e,t=1,a={})=>{const r=Math.max(1,Math.min(500,parseInt(t)||1)),{includeAdult:s=!0,language:i="en-US",region:n="US",maxRetries:o=5,initialRetryDelay:c=2e3,maxRetryDelay:l=1e4,timeout:u=12e3,enableCaching:h=!0,cacheExpiry:m=3e5,enableMetrics:d=!0,enableCompression:p=!0,searchType:g="multi",maxResults:y=1e3}=a,_=`search_${btoa(e)}_${r}_${btoa(JSON.stringify(a))}`,b={startTime:Date.now(),cacheHits:0,retryCount:0,requestCount:0,errors:[],searchStrategies:[],performance:{}},T=(e,t=1)=>{const a=e+.1*Math.random()*e;return new Promise((e=>setTimeout(e,a)))},S=async(e,t=1,a=u)=>{const r=Date.now();b.requestCount++;try{const s=new AbortController,i=setTimeout((()=>{s.abort()}),a),n={Accept:"application/json","Content-Type":"application/json","User-Agent":"MovieApp/2.0","Accept-Encoding":p?"gzip, deflate, br":"identity"},u=await fetch(e,{signal:s.signal,headers:n,compress:p});clearTimeout(i);const h=Date.now()-r;if(!u.ok){const r=await u.text().catch((()=>"No error details")),s={status:u.status,statusText:u.statusText,url:e,attempt:t,duration:h,details:r};if(404===u.status)return null;if(429===u.status){const r=parseInt(u.headers.get("Retry-After"))||60;if(o>t)return b.retryCount++,await T(1e3*r,t),S(e,t+1,a)}if((503===u.status||502===u.status||504===u.status)&&o>t){const r=Math.min(c*Math.pow(2,t-1),l);return b.retryCount++,await T(r,t),S(e,t+1,a)}throw b.errors.push(s),Error(`HTTP ${u.status}: ${u.statusText}. Details: ${r}`)}const m=await u.json();if(!m||"object"!=typeof m)throw Error("Invalid response: not an object");if(!Array.isArray(m.results))throw Error("Invalid response: missing or invalid results array");return m}catch(s){const i=Date.now()-r;if(s.name,o>t&&"TypeError"!==s.name){const r=Math.min(c*Math.pow(2,t-1),l);return b.retryCount++,await T(r,t),S(e,t+1,a)}throw b.errors.push({error:s.message,url:e,attempt:t,duration:i}),s}},k=e=>{try{if(!e||!e.media_type)return null;const t="movie"===e.media_type?U(e):z(e);if(!t)return null;const a=e.release_date||e.first_air_date?new Date(e.release_date||e.first_air_date).getFullYear():null;return{...t,type:e.media_type,image:e.poster_path?`${v}/w500${e.poster_path.startsWith("/")?e.poster_path:"/"+e.poster_path}`:null,backdrop:e.backdrop_path?`${v}/original${e.backdrop_path.startsWith("/")?e.backdrop_path:"/"+e.backdrop_path}`:null,year:a,rating:e.vote_average||0,title:e.title||e.name||"Unknown Title",popularity:e.popularity||0,originalLanguage:e.original_language||"en",voteCount:e.vote_count||0,overview:e.overview||"",genreIds:e.genre_ids||[],mediaType:e.media_type,releaseDate:e.release_date||e.first_air_date,originalTitle:e.original_title||e.original_name}}catch(t){return null}},M={multi:async()=>{const t=`${w}/search/multi?api_key=${f}&language=${i}&query=${encodeURIComponent(e)}&page=${r}&include_adult=${s}&region=${n}`;return await S(t)},movie:async()=>{const t=`${w}/search/movie?api_key=${f}&language=${i}&query=${encodeURIComponent(e)}&page=${r}&include_adult=${s}&region=${n}`;return await S(t)},tv:async()=>{const t=`${w}/search/tv?api_key=${f}&language=${i}&query=${encodeURIComponent(e)}&page=${r}&include_adult=${s}&region=${n}`;return await S(t)},person:async()=>{const t=`${w}/search/person?api_key=${f}&language=${i}&query=${encodeURIComponent(e)}&page=${r}&include_adult=${s}&region=${n}`;return await S(t)}};try{if(!e||"string"!=typeof e||0===e.trim().length)return{results:[],page:1,total_pages:0,total_results:0,query:e||"",timestamp:(new Date).toISOString(),metadata:{searchType:"invalid_query",processingTime:0,metrics:d?b:null}};const t=e.trim(),a=Date.now();if(h){const e=(e=>{try{const t=sessionStorage.getItem(e);if(t){const a=JSON.parse(t);if(Date.now()-a.timestamp<m)return b.cacheHits++,a.data;sessionStorage.removeItem(e)}return null}catch(t){return null}})(_);if(e)return{...e,metadata:{...e.metadata,cacheHit:!0,processingTime:Date.now()-a}}}let s=null,i=g;try{M[g]&&(s=await M[g](),b.searchStrategies.push({strategy:g,success:!0}))}catch(C){if(b.searchStrategies.push({strategy:g,success:!1,error:C.message}),"multi"!==g)try{s=await M.multi(),i="multi",b.searchStrategies.push({strategy:"multi",success:!0,fallback:!0})}catch(P){b.searchStrategies.push({strategy:"multi",success:!1,error:P.message})}}if(!s)try{const[e,t]=await Promise.allSettled([M.movie(),M.tv()]),a="fulfilled"===e.status?e.value:{results:[],total_results:0},r="fulfilled"===t.status?t.value:{results:[],total_results:0};s={results:[...(a.results||[]).map((e=>({...e,media_type:"movie"}))),...(r.results||[]).map((e=>({...e,media_type:"tv"})))],total_results:(a.total_results||0)+(r.total_results||0),total_pages:Math.max(a.total_pages||1,r.total_pages||1)},i="parallel",b.searchStrategies.push({strategy:"parallel",success:!0,fallback:!0})}catch(E){b.searchStrategies.push({strategy:"parallel",success:!1,error:E.message})}if(s&&Array.isArray(s.results)){const e=s.results.filter((e=>e&&("movie"===e.media_type||"tv"===e.media_type))).map(k).filter(Boolean).sort(((e,t)=>(t.relevanceScore||0)-(e.relevanceScore||0))).slice(0,y),n={results:e,page:r,total_pages:s.total_pages||1,total_results:s.total_results||e.length,has_more:r<(s.total_pages||1),query:t,timestamp:(new Date).toISOString(),metadata:{searchType:i,processingTime:Date.now()-a,cacheHit:!1,metrics:d?{...b,performance:{totalTime:Date.now()-a,requestCount:b.requestCount,retryCount:b.retryCount,cacheHits:b.cacheHits,searchStrategies:b.searchStrategies}}:null}};return h&&((e,t)=>{try{const a={data:t,timestamp:Date.now(),version:"2.0"};sessionStorage.setItem(e,JSON.stringify(a))}catch(C){}})(_,n),n}return{results:[],page:r,total_pages:0,total_results:0,has_more:!1,query:t,timestamp:(new Date).toISOString(),metadata:{searchType:i,processingTime:Date.now()-a,cacheHit:!1,metrics:d?{...b,performance:{totalTime:Date.now()-a,requestCount:b.requestCount,retryCount:b.retryCount,cacheHits:b.cacheHits,searchStrategies:b.searchStrategies}}:null}}}catch(C){return{results:[],page:r,total_pages:0,total_results:0,has_more:!1,query:e||"",timestamp:(new Date).toISOString(),error:C.message,metadata:{searchType:"error",processingTime:Date.now()-b.startTime,cacheHit:!1,metrics:d?{...b,performance:{totalTime:Date.now()-b.startTime,requestCount:b.requestCount,retryCount:b.retryCount,cacheHits:b.cacheHits,searchStrategies:b.searchStrategies}}:null}}}},de=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),1e4),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await t(1e3*s),a(e,r+1)}if(n.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if(s.name,3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/tv/airing_today?api_key=${f}&language=en-US&page=${e}&timezone=America/New_York`);if(!t||!t.results)throw Error("Invalid API response structure for airing today TV shows");const r=t.results.filter((e=>e&&e.id&&e.name&&e.poster_path&&e.first_air_date&&e.vote_average>=0)),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.vote_average||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900))),max:Math.max(...r.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900)))}:null,o=r.map(z).filter(Boolean);return{movies:o,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||o.length,hasMore:(t.page||e)<(t.total_pages||1),category:"airing_today",categoryDisplayName:"Airing Today",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{timezone:"America/New_York",sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,category:"airing_today",categoryDisplayName:"Airing Today",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{timezone:"America/New_York",sortBy:"popularity.desc"}}}}},pe=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),1e4),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await t(1e3*s),a(e,r+1)}if(n.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if(s.name,3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/movie/now_playing?api_key=${f}&language=en-US&page=${e}&region=US&include_adult=false`);if(!t||!t.results)throw Error("Invalid API response structure for now playing movies");const r=t.results.filter((e=>e&&e.id&&e.title&&e.poster_path&&e.release_date&&e.vote_average>=0)),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.vote_average||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>new Date(e.release_date).getFullYear())).filter((e=>e>1900))),max:Math.max(...r.map((e=>new Date(e.release_date).getFullYear())).filter((e=>e>1900)))}:null,o=r.map(U).filter(Boolean);return{movies:o,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||o.length,hasMore:(t.page||e)<(t.total_pages||1),category:"now_playing",categoryDisplayName:"Now Playing",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{region:"US",includeAdult:!1,sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,category:"now_playing",categoryDisplayName:"Now Playing",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{region:"US",includeAdult:!1,sortBy:"popularity.desc"}}}}},ge=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),12e3),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await t(1e3*s),a(e,r+1)}if(n.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if(s.name,3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/tv/popular?api_key=${f}&language=en-US&page=${e}&include_adult=false&region=US`);if(!t||!t.results)throw Error("Invalid API response structure for popular TV shows");const r=t.results.filter((e=>e&&e.id&&e.name&&e.poster_path&&e.first_air_date&&e.vote_average>=0)).map(z).filter(Boolean),s=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.vote_average||0)),0)/r.length*10)/10:0,i=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,n=r.length>0?{min:Math.min(...r.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900))),max:Math.max(...r.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900)))}:null;return{movies:r,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||r.length,hasMore:(t.page||e)<(t.total_pages||1),category:"popular_tv",categoryDisplayName:"Popular TV Shows",metadata:{averageRating:s,averageVoteCount:i,releaseYearRange:n,processedAt:(new Date).toISOString(),filterCriteria:{region:"US",includeAdult:!1,sortBy:"popularity.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,category:"popular_tv",categoryDisplayName:"Popular TV Shows",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{region:"US",includeAdult:!1,sortBy:"popularity.desc"}}}}},ye=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),1e4),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await t(1e3*s),a(e,r+1)}if(n.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if(s.name,3>=r&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=await a(`${w}/tv/top_rated?api_key=${f}&language=en-US&page=${e}&region=US&include_adult=false`);if(!t||!t.results)throw Error("Invalid API response structure for top rated TV shows");const r=t.results.filter((e=>e&&e.id&&e.name&&e.poster_path&&e.first_air_date&&e.vote_average>=0)),s=r.map(z).filter(Boolean),i=r.length>0?Math.round(r.reduce(((e,t)=>e+parseFloat(t.vote_average||0)),0)/r.length*10)/10:0,n=r.length>0?Math.round(r.reduce(((e,t)=>e+(t.vote_count||0)),0)/r.length):0,o=r.length>0?{min:Math.min(...r.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900))),max:Math.max(...r.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900)))}:null;return{movies:s,totalPages:t.total_pages||1,currentPage:t.page||e,totalResults:t.total_results||s.length,hasMore:(t.page||e)<(t.total_pages||1),category:"top_rated_tv",categoryDisplayName:"Top Rated TV Shows",metadata:{averageRating:i,averageVoteCount:n,releaseYearRange:o,processedAt:(new Date).toISOString(),filterCriteria:{region:"US",includeAdult:!1,sortBy:"vote_average.desc"}}}}catch(r){return{movies:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,category:"top_rated_tv",categoryDisplayName:"Top Rated TV Shows",error:r.message,errorType:r.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{region:"US",includeAdult:!1,sortBy:"vote_average.desc"}}}}},fe=async(e,t=1)=>{const a=e=>new Promise((t=>setTimeout(t,e))),r=async(e,t=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),12e3),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await a(1e3*s),r(e,t+1)}if(n.status>=500&&3>=t){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if(s.name,3>=t&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw s}};try{const a=`${w}/discover/movie?api_key=${f}&with_watch_providers=${e}&watch_region=US&language=en-US&page=${t}&sort_by=popularity.desc&include_adult=false&vote_count_gte=10`,s=await r(a);if(!s||!s.results)throw Error("Invalid API response structure for movies by network");const i=s.results.filter((e=>e&&e.id&&e.title)).map((e=>({...e,type:"movie",title:e.title,year:e.release_date?e.release_date.split("-")[0]:"N/A",rating:e.vote_average,duration:(e.runtime||0)+" min",backdrop:e.backdrop_path,image:e.poster_path,overview:e.overview,genres:e.genre_ids,networks:e.networks}))),n=i.length>0?Math.round(i.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/i.length*10)/10:0,o=i.length>0?Math.round(i.reduce(((e,t)=>e+(t.vote_count||0)),0)/i.length):0,c=i.length>0?{min:Math.min(...i.map((e=>new Date(e.release_date).getFullYear())).filter((e=>e>1900))),max:Math.max(...i.map((e=>new Date(e.release_date).getFullYear())).filter((e=>e>1900)))}:null;return{results:i,totalPages:s.total_pages||1,page:s.page||t,totalResults:s.total_results||i.length,hasMore:(s.page||t)<(s.total_pages||1),category:"network",categoryDisplayName:"Network Movies",metadata:{averageRating:n,averageVoteCount:o,releaseYearRange:c,processedAt:(new Date).toISOString(),filterCriteria:{networkId:e,watchRegion:"US",includeAdult:!1,language:"en-US"}}}}catch(s){return{results:[],totalPages:1,page:t,totalResults:0,hasMore:!1,category:"network",categoryDisplayName:"Network Movies",error:s.message}}},we=async(e,t=1)=>{const a=e=>new Promise((t=>setTimeout(t,e))),r=async(e,t=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),12e3),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await a(1e3*s),r(e,t+1)}if(n.status>=500&&3>=t){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if(s.name,3>=t&&"TypeError"!==s.name){const s=Math.min(1e3*Math.pow(2,t-1),5e3);return await a(s),r(e,t+1)}throw s}};try{const a=await r(`${w}/discover/tv?api_key=${f}&with_networks=${e}&language=en-US&page=${t}&sort_by=popularity.desc&include_adult=false&region=US`);if(!a||!a.results)throw Error("Invalid API response structure for TV series by network");const s=a.results.filter((e=>e&&e.id&&e.name)).map((e=>({...e,type:"tv",title:e.name,year:e.first_air_date?e.first_air_date.split("-")[0]:"N/A",rating:e.vote_average,duration:`${e.number_of_seasons||0} Season${1!==(e.number_of_seasons||0)?"s":""}`,backdrop:e.backdrop_path,image:e.poster_path,overview:e.overview,genres:e.genre_ids,networks:e.networks}))),i=s.length>0?Math.round(s.reduce(((e,t)=>e+parseFloat(t.rating||0)),0)/s.length*10)/10:0,n=s.length>0?Math.round(s.reduce(((e,t)=>e+(t.vote_count||0)),0)/s.length):0,o=s.length>0?{min:Math.min(...s.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900))),max:Math.max(...s.map((e=>new Date(e.first_air_date).getFullYear())).filter((e=>e>1900)))}:null;return{results:s,totalPages:a.total_pages||1,page:a.page||t,totalResults:a.total_results||s.length,hasMore:(a.page||t)<(a.total_pages||1),category:"network_"+e,categoryDisplayName:"TV Series - Network "+e,metadata:{averageRating:i,averageVoteCount:n,releaseYearRange:o,processedAt:(new Date).toISOString(),filterCriteria:{networkId:parseInt(e),sortBy:"popularity.desc",includeAdult:!1,region:"US"}}}}catch(s){return{results:[],totalPages:1,page:t,totalResults:0,hasMore:!1,category:"network_"+e,categoryDisplayName:"TV Series - Network "+e,error:s.message,errorType:s.name,timestamp:(new Date).toISOString(),metadata:{averageRating:0,averageVoteCount:0,releaseYearRange:null,isError:!0,filterCriteria:{networkId:parseInt(e),sortBy:"popularity.desc",includeAdult:!1,region:"US"}}}}},ve=async(e,t)=>{const a=async(e,t=1)=>{try{const t=await fetch(e);if(!t.ok)throw Error("HTTP error! status: "+t.status);return await t.json()}catch(s){if(3>t)return await(r=1e3*t,new Promise((e=>setTimeout(e,r)))),a(e,t+1);throw s}var r};try{const r=`${w}/tv/${e}/season/${t}?api_key=${f}&language=en-US&append_to_response=credits,videos,images`,s=await a(r);if(!s)throw Error("Invalid response from TMDB API");return!s.episodes||s.episodes,{id:s.id,name:s.name,overview:s.overview||"",season_number:s.season_number,air_date:s.air_date,poster_path:s.poster_path?`${v}/w500${s.poster_path.startsWith("/")?s.poster_path:"/"+s.poster_path}`:null,episodes:s.episodes?s.episodes.map((e=>({id:e.id,name:e.name,overview:e.overview||"",still_path:e.still_path?`${v}/w300${e.still_path.startsWith("/")?e.still_path:"/"+e.still_path}`:null,air_date:e.air_date,episode_number:e.episode_number,season_number:e.season_number,runtime:e.runtime||0,vote_average:e.vote_average||0,vote_count:e.vote_count||0,crew:e.crew||[],guest_stars:e.guest_stars||[]}))):[]}}catch(r){throw r}},_e=async e=>{const t=async(e,a=1)=>{try{const t=await fetch(e);if(!t.ok)throw Error("HTTP error! status: "+t.status);return await t.json()}catch(s){if(3>a)return await(r=1e3*a,new Promise((e=>setTimeout(e,r)))),t(e,a+1);throw s}var r};try{const a=`${w}/tv/${e}?api_key=${f}&language=en-US&append_to_response=seasons`,r=await t(a);if(!r||!r.seasons)throw Error("Invalid response from TMDB API");return r.seasons.map((e=>({id:e.id,name:e.name,overview:e.overview||"",season_number:e.season_number,air_date:e.air_date,poster_path:e.poster_path?`${v}/w500${e.poster_path.startsWith("/")?e.poster_path:"/"+e.poster_path}`:null,episode_count:e.episode_count||0})))}catch(a){throw a}},be=new Set,Te=["movie_109974","movie_206992","movie_503838"];Te.forEach((e=>{be.add(e)})),setInterval((()=>{be.size>1e3&&(be.clear(),Te.forEach((e=>{be.add(e)})))}),864e5);const Se=async e=>{try{if(!e)throw Error("Person ID is required");const t=`${w}/person/${e}?api_key=${f}&language=en-US&append_to_response=combined_credits,images,external_ids`,a=await C(t);if(!a)throw Error("Failed to fetch person details");const r=await a.json();return{id:r.id,name:r.name,biography:r.biography||"",birthday:r.birthday,deathday:r.deathday,place_of_birth:r.place_of_birth,profile_path:r.profile_path?`${v}/w500${r.profile_path}`:null,known_for_department:r.known_for_department,gender:r.gender,popularity:r.popularity,adult:r.adult,imdb_id:r.external_ids?.imdb_id,facebook_id:r.external_ids?.facebook_id,instagram_id:r.external_ids?.instagram_id,twitter_id:r.external_ids?.twitter_id,homepage:r.homepage,combined_credits:r.combined_credits?{cast:r.combined_credits.cast?.map((e=>({id:e.id,title:e.title||e.name,original_title:e.original_title||e.original_name,character:e.character,media_type:e.media_type,poster_path:e.poster_path?`${v}/w185${e.poster_path}`:null,backdrop_path:e.backdrop_path?`${v}/w500${e.backdrop_path}`:null,release_date:e.release_date||e.first_air_date,vote_average:e.vote_average,vote_count:e.vote_count,popularity:e.popularity,overview:e.overview,genre_ids:e.genre_ids,episode_count:e.episode_count,department:e.department,job:e.job,credit_id:e.credit_id})))||[],crew:r.combined_credits.crew?.map((e=>({id:e.id,title:e.title||e.name,original_title:e.original_title||e.original_name,department:e.department,job:e.job,media_type:e.media_type,poster_path:e.poster_path?`${v}/w185${e.poster_path}`:null,backdrop_path:e.backdrop_path?`${v}/w500${e.backdrop_path}`:null,release_date:e.release_date||e.first_air_date,vote_average:e.vote_average,vote_count:e.vote_count,popularity:e.popularity,overview:e.overview,genre_ids:e.genre_ids,episode_count:e.episode_count,credit_id:e.credit_id})))||[]}:{cast:[],crew:[]},images:r.images?{profiles:r.images.profiles?.map((e=>({file_path:`${v}/w500${e.file_path}`,width:e.width,height:e.height,aspect_ratio:e.aspect_ratio,vote_average:e.vote_average,vote_count:e.vote_count})))||[]}:{profiles:[]}}}catch(t){throw t}},ke=async(e,t=1,a=!1,r="US")=>{try{if(!e||0===e.trim().length)throw Error("Search query is required");const s=`${w}/search/person?api_key=${f}&language=en-US&query=${encodeURIComponent(e.trim())}&page=${t}&include_adult=${a}&region=${r}`,i=await C(s);if(!i)throw Error("Failed to search people");const n=await i.json();return{page:n.page,results:n.results?.map((e=>({id:e.id,name:e.name,profile_path:e.profile_path?`${v}/w185${e.profile_path}`:null,adult:e.adult,popularity:e.popularity,known_for:e.known_for?.map((e=>({id:e.id,title:e.title||e.name,original_title:e.original_title||e.original_name,media_type:e.media_type,poster_path:e.poster_path?`${v}/w185${e.poster_path}`:null,backdrop_path:e.backdrop_path?`${v}/w500${e.backdrop_path}`:null,release_date:e.release_date||e.first_air_date,vote_average:e.vote_average,vote_count:e.vote_count,popularity:e.popularity,overview:e.overview,genre_ids:e.genre_ids})))||[],gender:e.gender,known_for_department:e.known_for_department})))||[],total_pages:n.total_pages,total_results:n.total_results}}catch(s){throw s}},Me=async(e,t=1,a={})=>{const r=Math.max(1,Math.min(500,parseInt(t)||1)),{includeAdult:s=!0,language:i="en-US",region:n="US",maxRetries:o=5,initialRetryDelay:c=2e3,maxRetryDelay:l=1e4,timeout:u=12e3,enableCaching:h=!0,cacheExpiry:m=3e5,enableMetrics:d=!0,enableCompression:p=!0,maxResults:g=1e3}=a,y=`search_person_${btoa(e)}_${r}_${btoa(JSON.stringify(a))}`,_={startTime:Date.now(),cacheHits:0,retryCount:0,requestCount:0,errors:[],performance:{}},b=(e,t=1)=>{const a=e+.1*Math.random()*e;return new Promise((e=>setTimeout(e,a)))},T=async(e,t=1,a=u)=>{const r=Date.now();_.requestCount++;try{const s=new AbortController,i=setTimeout((()=>{s.abort()}),a),n={Accept:"application/json","Content-Type":"application/json","User-Agent":"MovieApp/2.0","Accept-Encoding":p?"gzip, deflate, br":"identity"},u=await fetch(e,{signal:s.signal,headers:n,compress:p});clearTimeout(i);const h=Date.now()-r;if(!u.ok){const r=await u.text().catch((()=>"No error details")),s={status:u.status,statusText:u.statusText,url:e,attempt:t,duration:h,details:r};if(404===u.status)return null;if(429===u.status){const r=parseInt(u.headers.get("Retry-After"))||60;if(o>t)return _.retryCount++,await b(1e3*r,t),T(e,t+1,a)}if((503===u.status||502===u.status||504===u.status)&&o>t){const r=Math.min(c*Math.pow(2,t-1),l);return _.retryCount++,await b(r,t),T(e,t+1,a)}throw _.errors.push(s),Error(`HTTP ${u.status}: ${u.statusText}. Details: ${r}`)}const m=await u.json();if(!m||"object"!=typeof m)throw Error("Invalid response: not an object");if(!Array.isArray(m.results))throw Error("Invalid response: missing or invalid results array");return m}catch(s){const i=Date.now()-r;if(s.name,o>t&&"TypeError"!==s.name){const r=Math.min(c*Math.pow(2,t-1),l);return _.retryCount++,await b(r,t),T(e,t+1,a)}throw _.errors.push({error:s.message,url:e,attempt:t,duration:i}),s}},S=t=>{try{if(!t||!t.id)return null;const a=(t.known_for||[]).filter((e=>"movie"===e.media_type||"tv"===e.media_type)).slice(0,3).map((e=>({id:e.id,title:e.title||e.name,type:e.media_type,year:e.release_date||e.first_air_date?new Date(e.release_date||e.first_air_date).getFullYear():null,poster:e.poster_path||e.profile_path})));return{id:t.id,name:t.name||"Unknown Name",type:"person",image:t.profile_path?`${v}/w500${t.profile_path.startsWith("/")?t.profile_path:"/"+t.profile_path}`:null,popularity:t.popularity||0,knownFor:a,knownForDepartment:t.known_for_department||"Acting",adult:t.adult||!1,gender:t.gender||0,originalName:t.original_name||t.name,mediaType:"person",relevanceScore:k(t,e)}}catch(a){return null}},k=(e,t)=>{const a=t.toLowerCase(),r=(e.name||"").toLowerCase(),s=(e.known_for_department||"").toLowerCase();let i=0;return r===a?i+=100:r.startsWith(a)?i+=80:r.includes(a)&&(i+=60),"acting"===s&&(i+=20),50>e.popularity||(i+=15),100>e.popularity||(i+=10),e.known_for&&e.known_for.length>0&&(i+=10),i};try{if(!e||"string"!=typeof e||0===e.trim().length)return{results:[],page:1,total_pages:0,total_results:0,query:e||"",timestamp:(new Date).toISOString(),metadata:{searchType:"person",processingTime:0,metrics:d?_:null}};const t=e.trim(),a=Date.now();if(h){const e=(e=>{try{const t=sessionStorage.getItem(e);if(t){const a=JSON.parse(t);if(Date.now()-a.timestamp<m)return _.cacheHits++,a.data;sessionStorage.removeItem(e)}return null}catch(t){return null}})(y);if(e)return{...e,metadata:{...e.metadata,cacheHit:!0,processingTime:Date.now()-a}}}const o=`${w}/search/person?api_key=${f}&language=${i}&query=${encodeURIComponent(t)}&page=${r}&include_adult=${s}&region=${n}`;let c=null;try{c=await T(o)}catch(M){throw M}if(c&&Array.isArray(c.results)){const e=c.results.map(S).filter(Boolean).sort(((e,t)=>(t.relevanceScore||0)-(e.relevanceScore||0))).slice(0,g),s={results:e,page:r,total_pages:c.total_pages||1,total_results:c.total_results||e.length,has_more:r<(c.total_pages||1),query:t,timestamp:(new Date).toISOString(),metadata:{searchType:"person",processingTime:Date.now()-a,cacheHit:!1,metrics:d?{..._,performance:{totalTime:Date.now()-a,requestCount:_.requestCount,retryCount:_.retryCount,cacheHits:_.cacheHits}}:null}};return h&&((e,t)=>{try{const a={data:t,timestamp:Date.now(),version:"2.0"};sessionStorage.setItem(e,JSON.stringify(a))}catch(M){}})(y,s),s}return{results:[],page:r,total_pages:0,total_results:0,has_more:!1,query:t,timestamp:(new Date).toISOString(),metadata:{searchType:"person",processingTime:Date.now()-a,cacheHit:!1,metrics:d?{..._,performance:{totalTime:Date.now()-a,requestCount:_.requestCount,retryCount:_.retryCount,cacheHits:_.cacheHits}}:null}}}catch(M){return{results:[],page:r,total_pages:0,total_results:0,has_more:!1,query:e||"",timestamp:(new Date).toISOString(),error:M.message,metadata:{searchType:"person",processingTime:Date.now()-_.startTime,cacheHit:!1,metrics:d?{..._,performance:{totalTime:Date.now()-_.startTime,requestCount:_.requestCount,retryCount:_.retryCount,cacheHits:_.cacheHits}}:null}}}},Ce=async(e,t=1,a={})=>{const{enableCaching:r=!0,cacheExpiry:s=3e5,maxResults:i=50,enableMetrics:n=!0}=a,o=`search_combined_${btoa(e)}_${t}_${btoa(JSON.stringify(a))}`,c={startTime:Date.now(),cacheHits:0,requestCount:0,performance:{}};try{if(!e||"string"!=typeof e||0===e.trim().length)return{results:[],page:1,total_pages:0,total_results:0,query:e||"",timestamp:(new Date).toISOString(),metadata:{searchType:"combined",processingTime:0,metrics:n?c:null}};const l=e.trim(),u=Date.now();if(r){const e=(e=>{try{const t=sessionStorage.getItem(e);if(t){const a=JSON.parse(t);if(Date.now()-a.timestamp<s)return c.cacheHits++,a.data;sessionStorage.removeItem(e)}return null}catch(t){return null}})(o);if(e)return{...e,metadata:{...e.metadata,cacheHit:!0,processingTime:Date.now()-u}}}const[h,m]=await Promise.allSettled([me(l,t,{searchType:"multi",maxResults:Math.ceil(.7*i),...a}),Me(l,t,{maxResults:Math.ceil(.3*i),...a})]),d="fulfilled"===h.status?h.value:{results:[]},p="fulfilled"===m.status?m.value:{results:[]},g={results:[...(d.results||[]).map((e=>({...e,searchCategory:"content"}))),...(p.results||[]).map((e=>({...e,searchCategory:"person"})))].map((e=>{let t=e._relevanceScore||e.relevanceScore||0;return"content"===e.searchCategory&&(t+=5),"person"===e.searchCategory&&e.popularity>50&&(t+=10),{...e,combinedRelevanceScore:t}})).sort(((e,t)=>(t.combinedRelevanceScore||0)-(e.combinedRelevanceScore||0))).slice(0,i),page:t,total_pages:Math.max(d.total_pages||1,p.total_pages||1),total_results:(d.total_results||0)+(p.total_results||0),has_more:t<Math.max(d.total_pages||1,p.total_pages||1),query:l,timestamp:(new Date).toISOString(),metadata:{searchType:"combined",processingTime:Date.now()-u,cacheHit:!1,contentResults:d.results?.length||0,personResults:p.results?.length||0,metrics:n?{...c,performance:{totalTime:Date.now()-u,requestCount:c.requestCount}}:null}};return r&&((e,t)=>{try{const a={data:t,timestamp:Date.now(),version:"2.0"};sessionStorage.setItem(e,JSON.stringify(a))}catch(a){}})(o,g),g}catch(l){return{results:[],page:t,total_pages:0,total_results:0,has_more:!1,query:e||"",timestamp:(new Date).toISOString(),error:l.message,metadata:{searchType:"combined",processingTime:Date.now()-c.startTime,cacheHit:!1,metrics:n?{...c,performance:{totalTime:Date.now()-c.startTime,requestCount:c.requestCount}}:null}}}},Pe=async(e=1)=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),12e3),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await t(1e3*s),a(e,r+1)}if(n.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if("AbortError"===s.name)throw Error("Request timeout");if(3>=r&&s.message.includes("500")){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=["Marvel","DC","James Bond","Star Wars","Harry Potter","Lord of the Rings","Fast and Furious","Mission Impossible","Transformers","X-Men","Spider-Man","Batman","Superman","Avengers","Pirates of the Caribbean","Toy Story","Shrek","Despicable Me","Jurassic Park","Alien","Predator","Terminator","Rocky","Rambo","Die Hard","Lethal Weapon","Indiana Jones","Back to the Future"],s=t.slice(2*(e-1),2*e);let i=[];for(const e of s)try{const t=`${w}/search/collection?api_key=${f}&language=en-US&query=${encodeURIComponent(e)}&page=1`,r=await a(t);r&&r.results&&(i=i.concat(r.results))}catch(r){}const n=i.filter(((e,t,a)=>t===a.findIndex((t=>t.id===e.id)))).map((e=>({id:e.id,name:e.name,overview:e.overview,poster_path:e.poster_path,backdrop_path:e.backdrop_path,parts:e.parts||[],parts_count:e.parts?.length||0})));return{collections:n,totalPages:Math.ceil(t.length/2),currentPage:e,totalResults:n.length,hasMore:e<Math.ceil(t.length/2)}}catch(r){return{collections:[],totalPages:1,currentPage:e,totalResults:0,hasMore:!1,error:r.message}}},Ee=async e=>{const t=e=>new Promise((t=>setTimeout(t,e))),a=async(e,r=1)=>{try{const s=new AbortController,i=setTimeout((()=>s.abort()),12e3),n=await fetch(e,{signal:s.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(i),!n.ok){if(429===n.status){const s=parseInt(n.headers.get("Retry-After"))||60;return await t(1e3*s),a(e,r+1)}if(n.status>=500&&3>=r){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw Error(`HTTP ${n.status}: ${n.statusText}`)}return await n.json()}catch(s){if("AbortError"===s.name)throw Error("Request timeout");if(3>=r&&s.message.includes("500")){const s=Math.min(1e3*Math.pow(2,r-1),5e3);return await t(s),a(e,r+1)}throw s}};try{const t=`${w}/collection/${e}?api_key=${f}&language=en-US`,r=await a(t);if(!r)throw Error("Invalid API response structure for collection details");return{id:r.id,name:r.name,overview:r.overview,poster_path:r.poster_path,backdrop_path:r.backdrop_path,parts:(r.parts||[]).map(U).filter(Boolean),parts_count:r.parts?.length||0}}catch(r){throw r}},Re=Object.freeze(Object.defineProperty({__proto__:null,TMDB_API_KEY:f,TMDB_BASE_URL:w,TMDB_IMAGE_BASE_URL:v,calculateRetryDelay:H,calculateRetryDelayEnhanced:j,checkNetworkConnectivity:O,classifyNetworkError:L,discoverMovies:he,fetchWithCache:F,getActionMovies:ee,getAiringTodayTVShows:de,getAnimationMovies:oe,getAwardWinningMovies:ce,getCollectionDetails:Ee,getComedyMovies:te,getDocumentaryMovies:ie,getDramaMovies:ae,getFamilyMovies:ne,getGenres:Z,getHorrorMovies:re,getLatestMovies:le,getMovieCredits:q,getMovieDetails:B,getMovieVideos:W,getMoviesByCategory:ue,getMoviesByGenre:X,getMoviesByNetwork:fe,getNowPlayingMovies:pe,getPersonDetails:Se,getPopularCollections:Pe,getPopularMovies:G,getPopularTVShows:ge,getSciFiMovies:se,getSimilarMovies:V,getTVSeason:ve,getTVSeasons:_e,getTVSeriesByNetwork:we,getTopRatedMovies:J,getTopRatedTVShows:ye,getTrendingMovies:Q,getTrendingTVShows:y,getUpcomingMovies:K,searchCombined:Ce,searchMovies:me,searchPeople:ke,searchPerson:Me,transformMovieData:U,transformTVData:z},Symbol.toStringTag,{value:"Module"})),Ie=[];let Ae=!1;const De=e=>new Promise(((t,a)=>{Ie.push({requestFn:e,resolve:t,reject:a}),(async()=>{if(!Ae&&0!==Ie.length){for(Ae=!0;Ie.length>0;){const{requestFn:t,resolve:a,reject:r}=Ie.shift();try{a(await t())}catch(e){r(e)}Ie.length>0&&await new Promise((e=>setTimeout(e,200)))}Ae=!1}})()})),$e=new class{constructor(){this.requestQueue=[],this.isProcessing=!1,this.lastRequestTime=0,this.minInterval=100}async throttle(e){return new Promise(((t,a)=>{this.requestQueue.push({requestFn:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(!this.isProcessing&&0!==this.requestQueue.length){for(this.isProcessing=!0;this.requestQueue.length>0;){const t=Date.now()-this.lastRequestTime;if(t<this.minInterval){const e=this.minInterval-t;await new Promise((t=>setTimeout(t,e)))}const{requestFn:a,resolve:r,reject:s}=this.requestQueue.shift();this.lastRequestTime=Date.now();try{r(await a())}catch(e){s(e)}}this.isProcessing=!1}}},xe=()=>{const e=navigator.onLine;return{timeout:e?3e4:6e4,isOnline:e,retryConfig:{maxRetries:e?3:1,baseDelay:1e3,maxDelay:1e4}}},Le=async(e,t={})=>{const{timeout:a,retryConfig:r}=xe(),s={...r,maxDelay:3e4,...t},i=()=>$e.throttle(e);let n;for(let c=1;c<=s.maxRetries;c++)try{const e=new Promise(((e,t)=>{setTimeout((()=>t(Error("Request timeout"))),a)}));return await Promise.race([De(i),e])}catch(o){if(n=o,429===o.response?.status){let e=s.baseDelay*Math.pow(3,c-1);if(o.response?.headers?.["retry-after"]){const t=parseInt(o.response.headers["retry-after"]);isNaN(t)||(e=1e3*t)}else if(o.response?.data?.retryAfter){const t=parseInt(o.response.data.retryAfter);isNaN(t)||(e=1e3*t)}if(e=Math.min(Math.max(e,1e3),s.maxDelay),await new Promise((t=>setTimeout(t,e))),c===s.maxRetries){const e=o.response?.data?.error||"Rate limit exceeded. Please try again later.",t=o.response?.data?.retryAfter||"15 minutes";throw Error(`${e} Retry after: ${t}`)}continue}if(c===s.maxRetries)break;const e=Math.min(s.baseDelay*Math.pow(2,c-1),s.maxDelay);await new Promise((t=>setTimeout(t,e)))}throw n},je={updateProfile:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify(t)});if(!a.ok){const e=await a.text();let t="HTTP error! status: "+a.status;try{t=JSON.parse(e).message||t}catch(s){}throw Error(t)}return await a.json()}),{timeout:a})},uploadProfilePicture:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=new FormData;a.append("avatar",t);const s=await fetch(e()+"/user/profile/picture",{method:"POST",headers:{Authorization:"Bearer "+r},body:a});if(!s.ok)throw Error("HTTP error! status: "+s.status);return s.json()}),{timeout:a})},getProfile:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/profile",{method:"GET",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},updateLocation:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({location:t})});if(!a.ok){const e=await a.text();let t="HTTP error! status: "+a.status;try{t=JSON.parse(e).message||t}catch(s){}throw Error(t)}return a.json()}),{timeout:a})},updatePreferences:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/preferences",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify(t)});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},changePassword:async(t,a)=>{const{timeout:r}=xe(),s=localStorage.getItem("accessToken");if(!s)throw Error("No authentication token found");return Le((async()=>{const r=await fetch(e()+"/user/password",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({currentPassword:t,newPassword:a})});if(!r.ok){const e=await r.json();throw Error(e.message||"HTTP error! status: "+r.status)}return r.json()}),{timeout:r})},toggle2FA:async(t=!0)=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/2fa",{method:t?"POST":"DELETE",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r}});if(!a.ok){const e=await a.json();throw Error(e.message||"HTTP error! status: "+a.status)}return a.json()}),{timeout:a})},setup2FA:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/2fa/setup",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+a}});if(!t.ok){const e=await t.json();throw Error(e.message||"HTTP error! status: "+t.status)}return t.json()}),{timeout:t})},verify2FA:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/2fa/verify",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({code:t})});if(!a.ok){const e=await a.json();throw Error(e.message||"HTTP error! status: "+a.status)}return a.json()}),{timeout:a})},disable2FA:async(t,a)=>{const{timeout:r}=xe(),s=localStorage.getItem("accessToken");if(!s)throw Error("No authentication token found");return Le((async()=>{const r=await fetch(e()+"/user/2fa/disable",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({code:t,password:a})});if(!r.ok){const e=await r.json();throw Error(e.message||"HTTP error! status: "+r.status)}return r.json()}),{timeout:r})},getBackupCodes:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/2fa/backup-codes",{method:"GET",headers:{Authorization:"Bearer "+a}});if(!t.ok){const e=await t.json();throw Error(e.message||"HTTP error! status: "+t.status)}return t.json()}),{timeout:t})},regenerateBackupCodes:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/2fa/backup-codes/regenerate",{method:"POST",headers:{Authorization:"Bearer "+a}});if(!t.ok){const e=await t.json();throw Error(e.message||"HTTP error! status: "+t.status)}return t.json()}),{timeout:t})},connectOAuth:async t=>{if(!localStorage.getItem("accessToken"))throw Error("No authentication token found");window.location.href=`${e()}/auth/${t}/connect`},disconnectOAuth:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(`${e()}/user/oauth/${t}`,{method:"DELETE",headers:{Authorization:"Bearer "+r}});if(!a.ok){const e=await a.json();throw Error(e.message||"HTTP error! status: "+a.status)}return a.json()}),{timeout:a})},deleteAccount:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/account",{method:"DELETE",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},getWatchlist:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/watchlist",{method:"GET",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},syncWatchlist:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/watchlist/sync",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({watchlist:t})});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},syncWatchlistEnhanced:async(t,a=null)=>{const{timeout:r}=xe(),s=localStorage.getItem("accessToken");if(!s)throw Error("No authentication token found");return Le((async()=>{const r=await fetch(e()+"/user/watchlist/sync/enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({watchlist:t,lastSync:a,clientVersion:(new Date).toISOString()})});if(!r.ok)throw Error("HTTP error! status: "+r.status);return r.json()}),{timeout:r})},addToWatchlist:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/watchlist",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({movieData:t})});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},removeFromWatchlist:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(`${e()}/user/watchlist/${t}`,{method:"DELETE",headers:{Authorization:"Bearer "+r}});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},clearWatchlist:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/watchlist",{method:"DELETE",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},getViewingProgress:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/viewing-progress",{method:"GET",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},syncViewingProgress:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/viewing-progress/sync",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({viewingProgress:t})});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},updateViewingProgress:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/viewing-progress",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({progressData:t})});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},clearViewingProgress:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/viewing-progress",{method:"DELETE",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},getWatchHistory:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/watch-history",{method:"GET",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},syncWatchHistory:async(t,a=null)=>{const{timeout:r}=xe(),s=localStorage.getItem("accessToken");if(!s)throw Error("No authentication token found");return Le((async()=>{const r=await fetch(e()+"/user/watch-history/sync",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({watchHistory:t,lastSyncTimestamp:a})});if(!r.ok)throw Error("HTTP error! status: "+r.status);return r.json()}),{timeout:r})},processBatchWatchHistory:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(e()+"/user/watch-history/batch",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+r},body:JSON.stringify({operations:t})});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},syncWatchHistoryEnhanced:async(t,a=null)=>{const{timeout:r}=xe(),s=localStorage.getItem("accessToken");if(!s)throw Error("No authentication token found");return Le((async()=>{const r=await fetch(e()+"/user/watch-history/sync/enhanced",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({watchHistory:t,lastSync:a,clientVersion:(new Date).toISOString()})});if(!r.ok)throw Error("HTTP error! status: "+r.status);return r.json()}),{timeout:r})},getSyncStatus:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/sync-status",{method:"GET",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},updateWatchHistory:async(t,a)=>{const{timeout:r}=xe(),s=localStorage.getItem("accessToken");if(!s)throw Error("No authentication token found");return Le((async()=>{const r=await fetch(e()+"/user/watch-history",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({contentId:t,progress:a})});if(!r.ok)throw Error("HTTP error! status: "+r.status);return r.json()}),{timeout:r})},clearWatchHistory:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/watch-history",{method:"DELETE",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},getWishlist:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/wishlist",{method:"GET",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})},syncWishlist:async e=>{const t=Array.isArray(e)?e.map((e=>({id:e.id,title:e.title||e.name||e.original_title||e.original_name||"Unknown",poster_path:e.poster_path||e.poster,backdrop_path:e.backdrop_path||e.backdrop,overview:e.overview||"",type:e.media_type||e.type||"movie",year:e.year||(e.release_date?new Date(e.release_date).getFullYear()+"":e.first_air_date?new Date(e.first_air_date).getFullYear()+"":""),rating:void 0!==e.vote_average?+e.vote_average:void 0!==e.rating?+e.rating:void 0,genres:Array.isArray(e.genres)?e.genres.map((e=>"string"==typeof e?e:e?.name)).filter(Boolean):Array.isArray(e.genre_ids)?e.genre_ids.map((e=>e+"")).filter(Boolean):[],release_date:e.release_date||e.first_air_date||"",duration:e.duration||"",director:e.director||"",cast:Array.isArray(e.cast)?e.cast.map((e=>"string"==typeof e?e:e?.name||"")).filter(Boolean):[],addedAt:e.addedAt||(new Date).toISOString()}))):[];if(!localStorage.getItem("accessToken"))throw Error("No authentication token found");const a=await je.getWishlist(),r=Array.isArray(a?.data?.wishlist)?a.data.wishlist:[],s=new Set(r.map((e=>e.id))),i=new Set(t.map((e=>e.id)));for(const o of t)if(!s.has(o.id))try{await je.addToWishlist(o)}catch(n){}for(const o of r)if(!i.has(o.id))try{await je.removeFromWishlist(o.id)}catch(n){}return{success:!0,data:{wishlist:t}}},addToWishlist:async t=>{const a={id:t.id,title:t.title||t.name||t.original_title||t.original_name||"Unknown",poster_path:t.poster_path||t.poster,backdrop_path:t.backdrop_path||t.backdrop,overview:t.overview||"",type:t.media_type||t.type||"movie",year:t.year||(t.release_date?new Date(t.release_date).getFullYear()+"":t.first_air_date?new Date(t.first_air_date).getFullYear()+"":""),rating:void 0!==t.vote_average?+t.vote_average:void 0!==t.rating?+t.rating:void 0,genres:Array.isArray(t.genres)?t.genres.map((e=>"string"==typeof e?e:e?.name)).filter(Boolean):Array.isArray(t.genre_ids)?t.genre_ids.map((e=>e+"")).filter(Boolean):[],release_date:t.release_date||t.first_air_date||"",duration:t.duration||"",director:t.director||"",cast:Array.isArray(t.cast)?t.cast.map((e=>"string"==typeof e?e:e?.name||"")).filter(Boolean):[],addedAt:t.addedAt||(new Date).toISOString()},{timeout:r}=xe(),s=localStorage.getItem("accessToken");if(!s)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/wishlist",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({movie:a})});if(!t.ok){let e="HTTP error! status: "+t.status;try{e=await t.text()||e}catch{}throw Error(e)}return t.json()}),{timeout:r})},removeFromWishlist:async t=>{const{timeout:a}=xe(),r=localStorage.getItem("accessToken");if(!r)throw Error("No authentication token found");return Le((async()=>{const a=await fetch(`${e()}/user/wishlist/${t}`,{method:"DELETE",headers:{Authorization:"Bearer "+r}});if(!a.ok)throw Error("HTTP error! status: "+a.status);return a.json()}),{timeout:a})},clearWishlist:async()=>{const{timeout:t}=xe(),a=localStorage.getItem("accessToken");if(!a)throw Error("No authentication token found");return Le((async()=>{const t=await fetch(e()+"/user/wishlist",{method:"DELETE",headers:{Authorization:"Bearer "+a}});if(!t.ok)throw Error("HTTP error! status: "+t.status);return t.json()}),{timeout:t})}};let Oe=null;const Ne=(Oe||(Oe=new class{constructor(e={}){this.socket=null,this.listeners=new Map,this.isConnecting=!1,this.retryCount=0,this.maxRetries=Number.isFinite(e.maxRetries)?e.maxRetries:8,this.baseRetryDelay=Number.isFinite(e.baseRetryDelay)?e.baseRetryDelay:2e3,this.connectionTimeout=null,this.namespace=e.namespace||"/community",this.manualDisconnect=!1,this.debug=!!e.debug,this.emitQueue=[],this.maxEmitQueueSize=Number.isFinite(e.maxEmitQueueSize)?e.maxEmitQueueSize:100,this.eventBuffers=new Map,this.flushTimeout=null,this.flushDelay=Number.isFinite(e.flushDelay)?e.flushDelay:100,this.heartbeatInterval=Number.isFinite(e.heartbeatInterval)?e.heartbeatInterval:3e4,this.heartbeatTimer=null,this.latency=null,this.onceListeners=new Map}log(...e){this.debug}connect(e=this.namespace){if(this.isConnecting)return this.log("Already connecting..."),this.socket;if(!this.socket||!this.socket.connected||this.namespace!==e){this.isConnecting=!0,this.namespace=e,this.manualDisconnect=!1,this.connectionTimeout&&clearTimeout(this.connectionTimeout);const a="/"===e?t().replace("/community",""):t();this.socket&&this.socket.connected&&(this.log("Switching namespace, disconnecting previous socket"),this.socket.removeAllListeners(),this.socket.disconnect()),this.socket=n(a+e,{withCredentials:!0,transports:["websocket"],reconnection:!0,reconnectionAttempts:this.maxRetries,reconnectionDelay:this.baseRetryDelay,reconnectionDelayMax:1e4,randomizationFactor:.5,timeout:1e4,forceNew:!0,autoConnect:!0}),this.connectionTimeout=setTimeout((()=>{this.isConnecting&&(this.isConnecting=!1,this.log("Connection timeout"),this.handleConnectionError(Error("Connection timeout")))}),1e4),this.socket.on("connect",(()=>{this.isConnecting=!1,this.retryCount=0,this.connectionTimeout&&clearTimeout(this.connectionTimeout),this.log("Connected to socket:",e),this._startHeartbeat(),setTimeout((()=>this._flushEmitQueue()),0),this.notifyListeners("connect")})),this.socket.on("connect_error",(e=>{this.log("Connect error:",e),this.handleConnectionError(e),this.notifyListeners("connect_error",e)})),this.socket.on("disconnect",(e=>{this.isConnecting=!1,this.log("Disconnected:",e),this.notifyListeners("disconnect",e),this._stopHeartbeat(),this.manualDisconnect&&this.log("Manual disconnect requested; not reconnecting")})),this.socket.on("reconnect_attempt",(e=>{this.log("Reconnect attempt:",e),this.notifyListeners("reconnect_attempt",e)})),this.socket.on("reconnect_failed",(()=>{this.log("Reconnect failed"),this.notifyListeners("reconnect_failed")})),this.setupDefaultListeners()}return this.socket}handleConnectionError(e){if(this.isConnecting=!1,this.connectionTimeout&&clearTimeout(this.connectionTimeout),this.socket)this.notifyListeners("connect_error",e);else if(this.retryCount<this.maxRetries){this.retryCount++;const e=Math.min(this.baseRetryDelay*2**(this.retryCount-1),1e4),t=e+Math.floor(Math.random()*e*.5);this.log(`Manual retry (${this.retryCount}/${this.maxRetries}) in ${t}ms`),setTimeout((()=>this.connect(this.namespace)),t)}else this.log("Max retries reached. Giving up."),this.notifyListeners("connection_failed",e)}disconnect(){this.socket&&(this.log("Disconnecting socket and cleaning up..."),this.manualDisconnect=!0,this.socket.removeAllListeners(),this.socket.disconnect(),this.socket=null,this.isConnecting=!1,this.retryCount=0,this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.emitQueue=[])}setupDefaultListeners(){if(!this.socket)return;const e=["discussion:new","discussion:liked","discussion:updated","reply:new","reply:liked","user:joined"];e.forEach((e=>this.socket.off(e))),this.socket.on("discussion:new",(e=>{this.log("Received discussion:new",e),this.bufferEvent("discussion:new",e)})),this.socket.on("discussion:liked",(e=>{this.log("Received discussion:liked",e),this.bufferEvent("discussion:liked",e)})),this.socket.on("discussion:updated",(e=>{this.log("Received discussion:updated",e),this.bufferEvent("discussion:updated",e)})),this.socket.on("reply:new",(e=>{this.log("Received reply:new",e),this.bufferEvent("reply:new",e)})),this.socket.on("reply:liked",(e=>{this.log("Received reply:liked",e),this.bufferEvent("reply:liked",e)})),this.socket.on("user:joined",(e=>{this.log("Received user:joined",e),this.bufferEvent("user:joined",e)})),this.socket.onAny(((t,...a)=>{e.includes(t)||(1===a.length?this.notifyListeners(t,a[0]):this.notifyListeners(t,a))}))}bufferEvent(e,t){this.eventBuffers.has(e)||this.eventBuffers.set(e,[]);const a=this.eventBuffers.get(e);a.push(t),a.length>500&&a.splice(0,a.length-500),this.flushTimeout||("undefined"!=typeof window&&"requestIdleCallback"in window?this.flushTimeout=window.requestIdleCallback((()=>{this.flushTimeout=null,this.flushEventBuffers()}),{timeout:200}):this.flushTimeout=setTimeout((()=>{this.flushTimeout=null,this.flushEventBuffers()}),this.flushDelay))}flushEventBuffers(){this.eventBuffers.forEach(((e,t)=>{if(e&&0!==e.length)for(;e.length>0;){const a=e.splice(0,50);setTimeout((()=>{a.forEach((e=>this.notifyListeners(t,e)))}),0)}}))}addListener(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),this.log("Listener added for event: "+e)}on(e,t){return this.addListener(e,t)}off(e,t){return this.removeListener(e,t)}once(e,t){const a=r=>{try{t(r)}finally{this.removeListener(e,a)}};return this.addListener(e,a),a}removeListener(e,t){this.listeners.has(e)&&(this.listeners.get(e).delete(t),this.log("Listener removed for event: "+e),0===this.listeners.get(e).size&&this.listeners.delete(e))}notifyListeners(e,t){this.listeners.has(e)&&Array.from(this.listeners.get(e)).forEach((a=>{try{a(t)}catch(r){this.log(`Error in listener for event "${e}":`,r)}}))}emitDiscussionCreate(e){this._queueEmit("discussion:create",e)}emitReplyCreate(e){this._queueEmit("reply:create",e)}emitDiscussionLike(e){this._queueEmit("discussion:like",e)}emitReplyLike(e){this._queueEmit("reply:like",e)}emitUserJoined(e){this._queueEmit("user:joined",e)}_queueEmit(e,t){if(this.socket?.connected)try{this.socket.emit(e,t),this.log("Emitted",e,t)}catch(a){this.log("Emit error, queueing",e,a),this._pushToEmitQueue({event:e,payload:t})}else this.log("Socket not connected, queueing emit for",e),this._pushToEmitQueue({event:e,payload:t}),this.isConnecting||this.manualDisconnect||this.connect(this.namespace)}_pushToEmitQueue(e){this.emitQueue.length<this.maxEmitQueueSize||this.emitQueue.shift(),this.emitQueue.push(e)}emitWithAck(e,t,a=5e3){return this.socket?.connected?new Promise(((r,s)=>{let i=null;try{this.socket.emit(e,t,(e=>{i&&clearTimeout(i),r(e)})),i=setTimeout((()=>{s(Error("Emit ack timeout"))}),a)}catch(n){i&&clearTimeout(i),s(n)}})):new Promise(((r,s)=>{const i=a;this._pushToEmitQueue({event:e,payload:t,resolve:r,reject:s,ackTimeout:i}),this.isConnecting||this.manualDisconnect||this.connect(this.namespace)}))}_flushEmitQueue(){if(this.socket?.connected&&0!==this.emitQueue.length)for(;this.emitQueue.length>0;){const t=this.emitQueue.splice(0,20);try{t.forEach((e=>{if(e&&"function"==typeof e.resolve){let a=null;try{this.socket.emit(e.event,e.payload,(t=>{a&&clearTimeout(a),e.resolve(t)})),e.ackTimeout&&(a=setTimeout((()=>{e.reject&&e.reject(Error("Emit ack timeout"))}),e.ackTimeout))}catch(t){e.reject&&e.reject(t)}}else this.socket.emit(e.event,e.payload)}))}catch(e){this.emitQueue=t.concat(this.emitQueue),this.log("Error flushing emit queue, will retry later",e);break}}}destroy(){this.flushTimeout&&("undefined"!=typeof window&&"cancelIdleCallback"in window&&"number"==typeof this.flushTimeout?window.cancelIdleCallback(this.flushTimeout):clearTimeout(this.flushTimeout),this.flushTimeout=null),this._stopHeartbeat(),this.disconnect(),this.eventBuffers.clear(),this.emitQueue=[],this.listeners.clear()}isConnected(){return!(!this.socket||!this.socket.connected)}changeNamespace(e){e!==this.namespace&&(this.log(`Changing namespace from ${this.namespace} to ${e}`),this.disconnect(),this.connect(e))}waitForConnection(e=1e4){return this.isConnected()?Promise.resolve(this.socket):new Promise(((t,a)=>{let r=null;const s=()=>{r&&clearTimeout(r),this.removeListener("connect",s),t(this.socket)};this.addListener("connect",s),this.isConnecting||this.manualDisconnect||this.connect(this.namespace),r=setTimeout((()=>{this.removeListener("connect",s),a(Error("waitForConnection timeout"))}),e)}))}_startHeartbeat(){if(this._stopHeartbeat(),this.socket&&this.socket.connected)try{this.heartbeatTimer=setInterval((()=>{const e=Date.now();try{this.socket.timeout(5e3).emit("client:ping",{t:e},(t=>{this.latency=Date.now()-e,this.notifyListeners("latency",this.latency)}))}catch(t){this.log("Heartbeat error",t)}}),this.heartbeatInterval)}catch(e){this.log("Failed to start heartbeat",e)}}_stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}setDebug(e){this.debug=!!e}}),Oe),He=async(t,a=!0)=>{try{const r=await(async()=>{try{if(!navigator.geolocation)return null;const e=await new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})),{latitude:t,longitude:a}=e.coords;return await(async(e,t)=>{try{const a=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${e}&longitude=${t}&localityLanguage=en`);if(!a.ok)throw Error("Failed to get location information from geocoding service");const r=await a.json(),s={city:r.locality||r.city||null,state:r.principalSubdivision||r.administrativeArea||null,country:r.countryName||null,postalCode:r.postcode||r.postalCode||r.zipCode||r.zip||null,county:r.county||r.subAdministrativeArea||null,neighborhood:r.neighbourhood||null,street:r.street||null,latitude:e,longitude:t,shortName:null,fullName:null,detailedName:null},i=[];return s.city&&i.push(s.city),s.state&&i.push(s.state),s.country&&i.push(s.country),s.city&&s.state?s.shortName=`${s.city}, ${s.state}`:s.city?s.shortName=s.city:s.state?s.shortName=s.state:s.country&&(s.shortName=s.country),i.length>0&&(s.fullName=i.join(", ")),s.postalCode&&s.fullName?s.detailedName=`${s.fullName} ${s.postalCode}`:s.detailedName=s.fullName,s.shortName||(s.shortName=r.locality||r.city||r.principalSubdivision||r.countryName||"Unknown location",s.fullName=s.shortName,s.detailedName=s.shortName),s}catch(a){return{city:null,state:null,country:null,postalCode:null,county:null,neighborhood:null,street:null,latitude:e,longitude:t,shortName:`${e.toFixed(4)}, ${t.toFixed(4)}`,fullName:`${e.toFixed(4)}, ${t.toFixed(4)}`,detailedName:`${e.toFixed(4)}, ${t.toFixed(4)}`}}})(t,a)}catch(e){return 1===e.code||2===e.code||e.code,null}})();if(!r)return a&&o.error("Location detection failed. Please check your browser permissions."),{success:!1,error:"Location detection failed"};const s=await(async(t,a)=>{if(!t)return{success:!1,error:"No location data"};const r=((e,t="short")=>{if(!e)return"Unknown location";switch(t){case"short":default:return e.shortName||"Unknown location";case"full":return e.fullName||e.shortName||"Unknown location";case"detailed":return e.detailedName||e.fullName||e.shortName||"Unknown location";case"custom":const t=[];return e.city&&t.push(e.city),e.state&&t.push(e.state),e.country&&e.country!==e.state&&t.push(`(${e.country})`),t.length>0?t.join(", "):"Unknown location";case"withPostalCode":return e.postalCode&&e.fullName?`${e.fullName} ${e.postalCode}`:e.fullName||e.shortName||"Unknown location"}})(t,"full"),s=localStorage.getItem("accessToken");if(!s)return{success:!1,error:"No access token"};try{const i=await fetch(e()+"/user/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify({location:r})});return i.ok?(await i.json()).success?(a&&a((e=>({...e,location:r}))),{success:!0,location:r,details:t}):{success:!1,error:"Database update failed"}:(await i.text(),{success:!1,error:"HTTP error: "+i.status})}catch(i){return{success:!1,error:i.message}}})(r,t);if(s.success&&a){let e="Location detected: "+s.location;r.city&&r.state&&(e+=`\n📍 ${r.city}, ${r.state}`,r.country&&r.country!==r.state&&(e+=", "+r.country)),r.postalCode||(e+="\n💡 Postal code not available for this area"),o.success(e,{duration:4e3,icon:"📍"})}else!s.success&&a&&o.error("Failed to update location. Please try again.");return s}catch(r){return a&&o.error("Location detection failed. Please try again."),{success:!1,error:r.message}}},Fe={refreshToken:async()=>{try{const t=localStorage.getItem("refreshToken"),a={"Content-Type":"application/json"};t&&(a.Authorization="Bearer "+t);const r=await fetch(e()+"/auth/refresh-token",{method:"POST",headers:a,credentials:"include"});if(!r.ok)throw await r.text(),Error("Token refresh failed");const s=await r.json();return s.data?.refreshToken&&localStorage.setItem("refreshToken",s.data.refreshToken),s}catch(t){throw t}},login:async t=>{try{const r=await fetch(e()+"/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"});let s=null;try{s=await r.json()}catch(a){}if(!r.ok){const e=s?.message||Array.isArray(s?.errors)&&s.errors[0]?.msg||"Login failed";throw Error(e)}return s?.data?.refreshToken&&localStorage.setItem("refreshToken",s.data.refreshToken),s}catch(r){throw r}},logout:async()=>{try{const t=await fetch(e()+"/auth/logout",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});return localStorage.removeItem("refreshToken"),await t.json()}catch(t){throw t}},forgotPassword:async t=>{try{const a=await fetch(e()+"/auth/forgot-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(!a.ok)throw Error("Forgot password request failed");return await a.json()}catch(a){throw a}},resetPassword:async(t,a)=>{try{const r=await fetch(e()+"/auth/reset-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t,newPassword:a})});if(!r.ok)throw Error("Password reset failed");return await r.json()}catch(r){throw r}},verifyEmail:async t=>{try{const a=await fetch(e()+"/auth/verify-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});if(!a.ok)throw Error("Email verification failed");return await a.json()}catch(a){throw a}},signup:async t=>{try{const a=await fetch(e()+"/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"});if(!a.ok)throw Error("Signup failed");return await a.json()}catch(a){throw a}}},Ue={getProfile:async()=>{try{const t=localStorage.getItem("accessToken");if(!t)throw Error("No access token");const a=await fetch(e()+"/user/profile",{method:"GET",headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},credentials:"include"});if(!a.ok)throw Error("Failed to get user profile");return await a.json()}catch(t){throw t}},updateProfile:async t=>{try{const a=localStorage.getItem("accessToken");if(!a)throw Error("No access token");const r=await fetch(e()+"/user/profile",{method:"PUT",headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"});if(!r.ok)throw Error("Failed to update profile");return await r.json()}catch(a){throw a}}},ze=new class{constructor(){this.config={criticalSections:["featured","trending"],highPrioritySections:["popular","topRated","upcoming"],mediumPrioritySections:["action","comedy","drama","horror","sciFi","documentary","family","animation","awardWinning","latest","popularTV","topRatedTV","airingToday","nowPlaying"],lowPrioritySections:[],maxConcurrentRequests:4,requestTimeout:8e3,batchDelay:150,idleDelay:300,maxCacheSize:500,memoryThreshold:209715200,aggressiveCleanup:!0,aggressiveCaching:!0,prefetchThreshold:.8,cacheWarmup:!0,persistentCacheEnabled:!0,cacheTTL:9e5,maxCacheAge:18e5},this.state={isInitialLoadComplete:!1,loadedSections:new Set,pendingRequests:new Map,performanceMetrics:{initialLoadTime:0,criticalLoadTime:0,highPriorityLoadTime:0,mediumPriorityLoadTime:0,cacheHitRate:0}},this.persistentCache=new Map,this.cacheTimestamps=new Map,this.cacheHits=0,this.cacheMisses=0,this.observers=new Set,this.initializePersistentCache(),this.initializeMemoryMonitoring()}initializePersistentCache(){if(this.config.persistentCacheEnabled)try{const e=localStorage.getItem("streamr_persistent_cache");if(e){const t=JSON.parse(e);this.persistentCache=new Map(t.cache||[]),this.cacheTimestamps=new Map(t.timestamps||[]),this.cacheHits=t.cacheHits||0,this.cacheMisses=t.cacheMisses||0,this.cleanExpiredCache()}}catch(e){this.clearPersistentCache()}}savePersistentCache(){if(this.config.persistentCacheEnabled)try{const e={cache:Array.from(this.persistentCache.entries()),timestamps:Array.from(this.cacheTimestamps.entries()),cacheHits:this.cacheHits,cacheMisses:this.cacheMisses,lastSaved:Date.now()};localStorage.setItem("streamr_persistent_cache",JSON.stringify(e))}catch(e){}}getCachedSection(e){if(!this.config.persistentCacheEnabled)return null;const t=this.persistentCache.get(e);if(!t)return this.cacheMisses++,null;const a=this.cacheTimestamps.get(e);return Date.now()-a>this.config.maxCacheAge?(this.persistentCache.delete(e),this.cacheTimestamps.delete(e),this.cacheMisses++,null):(this.cacheHits++,t)}setCachedSection(e,t){this.config.persistentCacheEnabled&&(this.persistentCache.set(e,t),this.cacheTimestamps.set(e,Date.now()),this.persistentCache.size%5==0&&this.savePersistentCache())}cleanExpiredCache(){const e=Date.now(),t=[];for(const[a,r]of this.cacheTimestamps.entries())e-r>this.config.maxCacheAge&&t.push(a);t.forEach((e=>{this.persistentCache.delete(e),this.cacheTimestamps.delete(e)})),t.length}clearPersistentCache(){this.persistentCache.clear(),this.cacheTimestamps.clear(),this.cacheHits=0,this.cacheMisses=0;try{localStorage.removeItem("streamr_persistent_cache")}catch(e){}}initializeMemoryMonitoring(){this.config.aggressiveCleanup&&(setInterval((()=>{this.checkMemoryUsage()}),1e4),document.addEventListener("visibilitychange",(()=>{document.hidden&&this.performMemoryCleanup()})))}checkMemoryUsage(){performance.memory&&performance.memory.usedJSHeapSize/1024/1024>this.config.memoryThreshold/1024/1024&&this.performMemoryCleanup()}performMemoryCleanup(){if(this.cleanExpiredCache(),this.persistentCache.size>this.config.maxCacheSize){const e=Array.from(this.persistentCache.entries());e.sort(((e,t)=>(this.cacheTimestamps.get(e[0])||0)-(this.cacheTimestamps.get(t[0])||0)));const t=this.persistentCache.size-this.config.maxCacheSize;e.slice(0,t).forEach((([e])=>{this.persistentCache.delete(e),this.cacheTimestamps.delete(e)}))}window.gc&&window.gc()}isSectionCached(e){if(!this.config.persistentCacheEnabled)return!1;if(!this.persistentCache.get(e))return!1;const t=this.cacheTimestamps.get(e);return Date.now()-t<=this.config.maxCacheAge}getCacheStats(){const e=this.cacheHits+this.cacheMisses,t=e>0?this.cacheHits/e*100:0;return{totalEntries:this.persistentCache.size,cacheHits:this.cacheHits,cacheMisses:this.cacheMisses,hitRate:t,totalRequests:e}}async executeInitialLoad(e,t={}){const a=performance.now();try{const r=new Set,s=new Set,i=[...this.config.criticalSections,...this.config.highPrioritySections,...this.config.mediumPrioritySections,...this.config.lowPrioritySections];for(const e of i)if(this.isSectionCached(e)){const a=this.getCachedSection(e);a&&t[e]&&(t[e](a),r.add(e),this.state.loadedSections.add(e))}else s.add(e);if(this.config.criticalSections.every((e=>r.has(e)))&&(this.state.isInitialLoadComplete=!0,this.notifyObservers("initialLoadComplete")),s.size>0){const a=performance.now(),r=this.config.criticalSections.filter((e=>s.has(e)));if(r.length>0){const s=r.map((async a=>{const r=await this.fetchSectionWithTimeout(a,e[a]);return r&&t[a]&&(t[a](r),this.setCachedSection(a,r)),r}));await Promise.allSettled(s),this.state.performanceMetrics.criticalLoadTime=performance.now()-a}const i=performance.now(),n=this.config.highPrioritySections.filter((e=>s.has(e)));if(n.length>0){const a=n.map((async a=>{const r=await this.fetchSectionWithTimeout(a,e[a]);return r&&t[a]&&(t[a](r),this.setCachedSection(a,r)),r}));await Promise.allSettled(a),this.state.performanceMetrics.highPriorityLoadTime=performance.now()-i}const o=performance.now(),c=this.config.mediumPrioritySections.filter((e=>s.has(e)));if(c.length>0){const a=c.map((async a=>{const r=await this.fetchSectionWithTimeout(a,e[a]);return r&&t[a]&&(t[a](r),this.setCachedSection(a,r)),r}));Promise.allSettled(a).then((()=>{this.state.performanceMetrics.mediumPriorityLoadTime=performance.now()-o}))}this.state.isInitialLoadComplete=!0,this.notifyObservers("initialLoadComplete");const l=Array.from(s).filter((e=>!this.config.criticalSections.includes(e)&&!this.config.highPrioritySections.includes(e)&&!this.config.mediumPrioritySections.includes(e)));l.length>0&&this.loadRemainingSections(l,e,t)}return this.state.performanceMetrics.initialLoadTime=performance.now()-a,this.logPerformanceMetrics(),!0}catch(r){return u.trackError(r,{service:"PerformanceOptimizationService",function:"executeInitialLoad"}),!1}}async fetchSectionWithTimeout(e,t){if(!t)return null;const a=e+"-initial";if(this.state.pendingRequests.has(a))return this.state.pendingRequests.get(a);try{const a=new Promise(((t,a)=>{setTimeout((()=>a(Error("Request timeout for "+e))),this.config.requestTimeout)})),r=t(1),s=await Promise.race([r,a]);return this.state.loadedSections.add(e),s&&this.config.persistentCacheEnabled&&this.setCachedSection(e,s),s}catch(r){return null}finally{this.state.pendingRequests.delete(a)}}async loadRemainingSections(e,t,a={}){for(let s=0;s<e.length;s+=4){const i=e.slice(s,s+4).map((async e=>{const r=await this.fetchSectionWithTimeout(e,t[e]);return r&&a[e]&&(a[e](r),this.setCachedSection(e,r)),r}));try{await Promise.allSettled(i),s+4<e.length&&await new Promise((e=>setTimeout(e,this.config.batchDelay)))}catch(r){}}}async loadMediumPriorityContent(e,t={}){for(let r=0;r<this.config.mediumPrioritySections.length;r+=2){const s=this.config.mediumPrioritySections.slice(r,r+2).map((async a=>{const r=await this.fetchSectionWithTimeout(a,e[a]);return r&&t[a]&&(t[a](r),this.setCachedSection(a,r)),r}));try{await Promise.allSettled(s),r+2<this.config.mediumPrioritySections.length&&await new Promise((e=>setTimeout(e,this.config.batchDelay)))}catch(a){}}}scheduleLowPriorityLoading(e,t={}){setTimeout((()=>{this.loadLowPriorityContent(e,t)}),this.config.idleDelay)}async loadLowPriorityContent(e,t={}){const a=async r=>{const s=this.config.lowPrioritySections.slice(r,r+2).map((async a=>{const r=await this.fetchSectionWithTimeout(a,e[a]);return r&&t[a]&&t[a](r),r}));try{await Promise.allSettled(s),r+2<this.config.lowPrioritySections.length&&setTimeout((()=>a(r+2)),this.config.batchDelay)}catch(i){}};a(0)}addObserver(e){this.observers.add(e)}removeObserver(e){this.observers.delete(e)}notifyObservers(e,t=null){this.observers.forEach((a=>{"function"==typeof a?a(e,t):a&&"function"==typeof a.handlePerformanceEvent&&a.handlePerformanceEvent(e,t)}))}logPerformanceMetrics(){this.state.performanceMetrics,this.getCacheStats()}getPerformanceState(){return{...this.state,config:this.config}}getMetrics(){return this.getPerformanceState()}updateConfig(e){this.config={...this.config,...e}}reset(){this.state={isInitialLoadComplete:!1,loadedSections:new Set,pendingRequests:new Map,performanceMetrics:{initialLoadTime:0,criticalLoadTime:0,highPriorityLoadTime:0,mediumPriorityLoadTime:0,cacheHitRate:0}},this.notifyObservers("reset")}cleanup(){this.observers.clear(),this.state.pendingRequests.clear(),this.state.loadedSections.clear(),this.config.persistentCacheEnabled&&this.savePersistentCache()}},Be="w185",qe=new Map,We=(e,t=Be,a=null,r=!1)=>{if(!e)return a||"/placeholder-image.jpg";const s=`${e}_${t}_${r}`,i=qe.get(s);if(i&&864e5>Date.now()-i.timestamp)return i.url;const n=((e,t=Be)=>e?e.startsWith("http")?e:`https://image.tmdb.org/t/p/${t}${e.startsWith("/")?e:"/"+e}`:"/placeholder-image.jpg")(e,t);return(()=>{if(qe.size>1e3){const e=Array.from(qe.entries());e.sort(((e,t)=>e[1].timestamp-t[1].timestamp));const t=200;e.slice(0,t).forEach((([e])=>qe.delete(e)))}})(),qe.set(s,{url:n,timestamp:Date.now()}),n},Ve=async(e,t=Be)=>{const a=e.filter((e=>e)).map((e=>new Promise((a=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>a(e),r.onerror=()=>a(null),r.src=We(e,t)}))));return Promise.allSettled(a)};function Qe(e){return JSON.parse(JSON.stringify(e))}function Ge(){if("undefined"!=typeof navigator&&navigator.connection){const{effectiveType:e,downlink:t,rtt:a,saveData:r}=navigator.connection;return{effectiveType:e,downlink:t,rtt:a,saveData:r}}return null}const Je=new class{constructor(){this.coreWebVitals={fcp:null,lcp:null,fid:null,cls:null,ttfb:null,domContentLoaded:null,loadComplete:null,navigationStart:null,firstPaint:null},this.homepageMetrics={initialLoadTime:0,criticalContentLoadTime:0,highPriorityContentLoadTime:0,mediumPriorityContentLoadTime:0,imageLoadTimes:[],apiCallTimes:[],cacheHitRate:0,totalSectionsLoaded:0,sectionsLoadOrder:[],userInteractionTime:null,slowResources:[],resourceSummary:{},jsHeapUsed:[],memoryInfo:null},this.observers=new Set,this.performanceObservers=new Map,this.isMonitoring=!1,this.resourceObserver=null,this.memoryInterval=null,this.initCoreWebVitalsMonitoring()}initCoreWebVitalsMonitoring(){if("undefined"!=typeof window&&"PerformanceObserver"in window)try{const e=new PerformanceObserver((e=>{const t=e.getEntries();for(const a of t)"first-contentful-paint"===a.name&&(this.coreWebVitals.fcp=a.startTime,this.notifyObservers("fcp",this.coreWebVitals.fcp)),"first-paint"===a.name&&(this.coreWebVitals.firstPaint=a.startTime,this.notifyObservers("firstPaint",this.coreWebVitals.firstPaint))}));e.observe({entryTypes:["paint"]}),this.performanceObservers.set("fcp",e);const t=new PerformanceObserver((e=>{const t=e.getEntries(),a=t[t.length-1];a&&(this.coreWebVitals.lcp=a.startTime,this.notifyObservers("lcp",this.coreWebVitals.lcp))}));t.observe({entryTypes:["largest-contentful-paint"]}),this.performanceObservers.set("lcp",t);const a=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{this.coreWebVitals.fid=e.processingStart-e.startTime,this.notifyObservers("fid",this.coreWebVitals.fid)}))}));a.observe({entryTypes:["first-input"]}),this.performanceObservers.set("fid",a);let r=0;const s=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{e.hadRecentInput||(r+=e.value)})),this.coreWebVitals.cls=r,this.notifyObservers("cls",this.coreWebVitals.cls)}));if(s.observe({entryTypes:["layout-shift"]}),this.performanceObservers.set("cls",s),"performance"in window){const e=performance.getEntriesByType("navigation")[0];e&&(this.coreWebVitals.navigationStart=e.startTime,this.coreWebVitals.ttfb=e.responseStart-e.requestStart,this.coreWebVitals.domContentLoaded=e.domContentLoadedEventEnd-e.startTime,this.coreWebVitals.loadComplete=e.loadEventEnd-e.startTime)}"PerformanceObserver"in window&&"PerformanceResourceTiming"in window&&(this.resourceObserver=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{e.duration>1e3&&(this.homepageMetrics.slowResources.push({name:e.name,initiatorType:e.initiatorType,duration:e.duration}),this.notifyObservers("slowResource",e)),this.homepageMetrics.resourceSummary[e.initiatorType]||(this.homepageMetrics.resourceSummary[e.initiatorType]={count:0,totalDuration:0}),this.homepageMetrics.resourceSummary[e.initiatorType].count+=1,this.homepageMetrics.resourceSummary[e.initiatorType].totalDuration+=e.duration}))})),this.resourceObserver.observe({entryTypes:["resource"]}),this.performanceObservers.set("resource",this.resourceObserver)),window.performance&&window.performance.memory&&(this.memoryInterval=setInterval((()=>{const{usedJSHeapSize:e,totalJSHeapSize:t,jsHeapSizeLimit:a}=window.performance.memory;this.homepageMetrics.jsHeapUsed.push(e),this.homepageMetrics.memoryInfo={usedJSHeapSize:e,totalJSHeapSize:t,jsHeapSizeLimit:a},this.homepageMetrics.jsHeapUsed.length>30&&(this.homepageMetrics.jsHeapUsed=this.homepageMetrics.jsHeapUsed.slice(-30))}),2e3)),this.networkInfo=Ge()}catch(e){}}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,u&&"function"==typeof u.startMonitoring&&u.startMonitoring(),ze.addObserver(((e,t)=>{this.handleOptimizationEvent(e,t)})),"undefined"!=typeof document&&"function"==typeof document.addEventListener&&(this._visibilityHandler=()=>{"hidden"===document.visibilityState&&this.recordHomepageMetric("userInteraction",performance.now())},document.addEventListener("visibilitychange",this._visibilityHandler)),"undefined"!=typeof window&&"function"==typeof window.addEventListener&&(this._errorHandler=e=>{this.recordHomepageMetric("jsError",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,time:performance.now()})},window.addEventListener("error",this._errorHandler)))}handleOptimizationEvent(e,t){switch(e){case"initialLoadComplete":this.homepageMetrics.initialLoadTime=performance.now(),this.notifyObservers("initialLoadComplete",Qe(this.homepageMetrics));break;case"sectionLoaded":t&&t.section&&(this.homepageMetrics.totalSectionsLoaded++,this.homepageMetrics.sectionsLoadOrder.push(t.section),this.notifyObservers("sectionLoaded",Qe(t)));break;default:this.notifyObservers(e,Qe(t))}}recordHomepageMetric(e,t,a={}){switch(e){case"criticalContentLoad":this.homepageMetrics.criticalContentLoadTime=t;break;case"highPriorityContentLoad":this.homepageMetrics.highPriorityContentLoadTime=t;break;case"mediumPriorityContentLoad":this.homepageMetrics.mediumPriorityContentLoadTime=t;break;case"imageLoad":this.homepageMetrics.imageLoadTimes.push(t),this.homepageMetrics.imageLoadTimes.length>50&&(this.homepageMetrics.imageLoadTimes=this.homepageMetrics.imageLoadTimes.slice(-50));break;case"apiCall":this.homepageMetrics.apiCallTimes.push(t),this.homepageMetrics.apiCallTimes.length>50&&(this.homepageMetrics.apiCallTimes=this.homepageMetrics.apiCallTimes.slice(-50));break;case"cacheHit":this.homepageMetrics.cacheHitRate=t;break;case"userInteraction":this.homepageMetrics.userInteractionTime=t;break;case"jsError":this.homepageMetrics.jsErrors||(this.homepageMetrics.jsErrors=[]),this.homepageMetrics.jsErrors.push({...t,...a}),this.homepageMetrics.jsErrors.length>20&&(this.homepageMetrics.jsErrors=this.homepageMetrics.jsErrors.slice(-20))}this.notifyObservers("metricRecorded",{type:e,value:t,additionalData:a})}getComprehensiveReport(){const e=ze.getPerformanceState(),t=u?u.getReport():{},a=this.homepageMetrics.imageLoadTimes.length>0?this.homepageMetrics.imageLoadTimes.reduce(((e,t)=>e+t),0)/this.homepageMetrics.imageLoadTimes.length:0,r=this.homepageMetrics.apiCallTimes.length>0?this.homepageMetrics.apiCallTimes.reduce(((e,t)=>e+t),0)/this.homepageMetrics.apiCallTimes.length:0,s=this.homepageMetrics.jsHeapUsed.length>0?this.homepageMetrics.jsHeapUsed.reduce(((e,t)=>e+t),0)/this.homepageMetrics.jsHeapUsed.length:null,i=this.homepageMetrics.jsErrors?this.homepageMetrics.jsErrors.length:0,n=Qe(this.homepageMetrics.resourceSummary),o=this.networkInfo||Ge();return{coreWebVitals:Qe(this.coreWebVitals),homepage:{...Qe(this.homepageMetrics),averageImageLoadTime:a,averageApiCallTime:r,averageJsHeapUsed:s,jsErrorCount:i,resourceSummary:n,networkInfo:o},optimization:Qe(e),base:Qe(t),performanceScore:this.calculatePerformanceScore(),recommendations:this.generateRecommendations(),timestamp:Date.now()}}calculatePerformanceScore(){let e=100;return this.coreWebVitals.fcp&&this.coreWebVitals.fcp>1500&&(e-=15),this.coreWebVitals.lcp&&this.coreWebVitals.lcp>2500&&(e-=20),this.coreWebVitals.fid&&this.coreWebVitals.fid>100&&(e-=15),this.coreWebVitals.cls&&this.coreWebVitals.cls>.1&&(e-=15),this.homepageMetrics.initialLoadTime>5e3&&(e-=10),this.homepageMetrics.criticalContentLoadTime>3e3&&(e-=10),(this.homepageMetrics.imageLoadTimes.length>0?this.homepageMetrics.imageLoadTimes.reduce(((e,t)=>e+t),0)/this.homepageMetrics.imageLoadTimes.length:0)>1e3&&(e-=5),(this.homepageMetrics.apiCallTimes.length>0?this.homepageMetrics.apiCallTimes.reduce(((e,t)=>e+t),0)/this.homepageMetrics.apiCallTimes.length:0)>500&&(e-=5),this.homepageMetrics.jsErrors&&this.homepageMetrics.jsErrors.length>0&&(e-=Math.min(10,2*this.homepageMetrics.jsErrors.length)),this.homepageMetrics.slowResources&&this.homepageMetrics.slowResources.length>5&&(e-=5),this.homepageMetrics.jsHeapUsed&&this.homepageMetrics.jsHeapUsed.length>0&&this.homepageMetrics.jsHeapUsed.reduce(((e,t)=>e+t),0)/this.homepageMetrics.jsHeapUsed.length>104857600&&(e-=5),Math.max(0,e)}generateRecommendations(){const e=[];return this.coreWebVitals.lcp&&this.coreWebVitals.lcp>2500&&e.push("Optimize Largest Contentful Paint by reducing image sizes, using modern formats, and improving server response times."),this.coreWebVitals.fid&&this.coreWebVitals.fid>100&&e.push("Improve First Input Delay by reducing JavaScript execution time and optimizing event handlers."),this.coreWebVitals.cls&&this.coreWebVitals.cls>.1&&e.push("Reduce Cumulative Layout Shift by setting explicit dimensions for images and avoiding dynamic content insertion."),this.homepageMetrics.initialLoadTime>5e3&&e.push("Optimize initial page load by implementing code splitting, reducing bundle size, and leveraging server-side rendering."),(this.homepageMetrics.imageLoadTimes.length>0?this.homepageMetrics.imageLoadTimes.reduce(((e,t)=>e+t),0)/this.homepageMetrics.imageLoadTimes.length:0)>1e3&&e.push("Optimize image loading by implementing lazy loading, using modern image formats, and compressing images."),(this.homepageMetrics.apiCallTimes.length>0?this.homepageMetrics.apiCallTimes.reduce(((e,t)=>e+t),0)/this.homepageMetrics.apiCallTimes.length:0)>500&&e.push("Optimize API calls by implementing caching strategies, batching requests, and reducing server response times."),this.homepageMetrics.jsErrors&&this.homepageMetrics.jsErrors.length>0&&e.push("Reduce JavaScript errors by improving error handling and testing."),this.homepageMetrics.slowResources&&this.homepageMetrics.slowResources.length>0&&e.push("Investigate slow-loading resources (e.g., scripts, images, fonts) and optimize or defer them."),this.homepageMetrics.jsHeapUsed&&this.homepageMetrics.jsHeapUsed.length>0&&this.homepageMetrics.jsHeapUsed.reduce(((e,t)=>e+t),0)/this.homepageMetrics.jsHeapUsed.length>104857600&&e.push("Reduce JavaScript memory usage by optimizing data structures and cleaning up unused objects."),e}addObserver(e){this.observers.add(e)}removeObserver(e){this.observers.delete(e)}notifyObservers(e,t=null){this.observers.forEach((a=>{"function"==typeof a?a(e,t):a&&"function"==typeof a.handlePerformanceEvent&&a.handlePerformanceEvent(e,t)}))}cleanup(){this.isMonitoring=!1,this.performanceObservers.forEach((e=>{e&&"function"==typeof e.disconnect&&e.disconnect()})),this.performanceObservers.clear(),this.resourceObserver&&"function"==typeof this.resourceObserver.disconnect&&(this.resourceObserver.disconnect(),this.resourceObserver=null),this.observers.clear(),"undefined"!=typeof document&&this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null),"undefined"!=typeof window&&this._errorHandler&&(window.removeEventListener("error",this._errorHandler),this._errorHandler=null),this.memoryInterval&&(clearInterval(this.memoryInterval),this.memoryInterval=null),u&&"function"==typeof u.cleanup&&u.cleanup(),ze&&"function"==typeof ze.cleanup&&ze.cleanup()}},Ye={MOVIES111:{name:"111Movies",description:"Fastest",baseUrl:"https://111movies.com",movieFormat:"/movie/{id}",tvFormat:"/tv/{id}/{season}/{episode}",quality:"1080p",autoplay:!0,preload:"metadata",bandwidth:"high"},RIVESTREAM:{name:"RiveStream",description:"Download, Dubbed",baseUrl:"https://rivestream.net/embed",movieFormat:"?type=movie&id={id}",tvFormat:"?type=tv&id={id}&season={season}&episode={episode}",quality:"1080p",autoplay:!0,preload:"metadata",bandwidth:"high"},VIDFAST:{name:"VidFast",description:"Ad-free",baseUrl:"https://vidfast.pro",movieFormat:"/movie/{id}",tvFormat:"/tv/{id}/{season}/{episode}",quality:"1080p",autoplay:!0,preload:"auto",bandwidth:"high"},CINEMAOS:{name:"Cinemaos",description:"Download, Dubbed",baseUrl:"https://cinemaos.tech/player",movieFormat:"/{id}",tvFormat:"/{id}/{season}/{episode}",quality:"1080p",autoplay:!0,preload:"auto",bandwidth:"high"},VIDEASY:{name:"Videasy",description:"Fast",baseUrl:"https://player.videasy.net",movieFormat:"/movie/{id}",tvFormat:"/tv/{id}/{season}/{episode}",quality:"720p",autoplay:!0,preload:"metadata",bandwidth:"high"},VIDJOY:{name:"VidJoy",description:"Dubbed",baseUrl:"https://vidjoy.pro/embed",movieFormat:"/movie/{id}",tvFormat:"/tv/{id}/{season}/{episode}",quality:"720p",autoplay:!1,preload:"metadata",bandwidth:"high"}},Ke="MOVIES111",Ze=(e=Ke)=>Ye[e]||Ye[Ke],Xe=(e,t=Ke,a={})=>{if(!e)return null;try{const r=Ze(t),s=(e+"").trim();if(!s)return null;let i=r.baseUrl+r.movieFormat.replace("{id}",s);const n=new URLSearchParams;if((a.quality||r.quality)&&n.append("quality",a.quality||r.quality),void 0!==a.autoplay?n.append("autoplay",a.autoplay?"1":"0"):r.autoplay&&n.append("autoplay","1"),(a.preload||r.preload)&&n.append("preload",a.preload||r.preload),(a.bandwidth||r.bandwidth)&&n.append("bandwidth",a.bandwidth||r.bandwidth),a.adaptive&&n.append("adaptive","1"),a.buffer&&n.append("buffer",a.buffer),n.toString()){const e=i.includes("?")?"&":"?";i+=e+n.toString()}return i}catch(r){return null}},et=(e,t,a,r=Ke,s={})=>{if(!e||!t||!a)return null;try{const i=Ze(r),n=(e+"").trim();if(!n)return null;const o=+t,c=+a;if(!o||!c||1>o||1>c)return null;let l=i.baseUrl+i.tvFormat.replace("{id}",n).replace("{season}",o).replace("{episode}",c);const u=new URLSearchParams;(s.quality||i.quality)&&u.append("quality",s.quality||i.quality),void 0!==s.autoplay?u.append("autoplay",s.autoplay?"1":"0"):i.autoplay&&u.append("autoplay","1"),(s.preload||i.preload)&&u.append("preload",s.preload||i.preload),(s.bandwidth||i.bandwidth)&&u.append("bandwidth",s.bandwidth||i.bandwidth),u.append("season",o),u.append("episode",c),s.adaptive&&u.append("adaptive","1"),s.buffer&&u.append("buffer",s.buffer);const h=l.includes("?")?"&":"?";return l+=h+u.toString(),l}catch(i){return null}},tt=e=>{if(!e||!e.id)return!1;const t=e.type||e.media_type||"movie";return"movie"===t||"tv"===t&&e.season&&e.episode},at=(e,t=Ke)=>{if(!tt(e))return null;const a=e.type||e.media_type||"movie";return"movie"===a?Xe(e.id,t):"tv"===a&&e.season&&e.episode?et(e.id,e.season,e.episode,t):null},rt=e=>!!e&&!("tv"!==(e.type||e.media_type||"movie")||e.season&&e.episode),st=e=>{if(!tt(e))return[];const t=[];return Object.entries(Ye).forEach((([a,r])=>{const s=at(e,a);s&&t.push({key:a,name:r.name,description:r.description,url:s})})),t},it=new class{constructor(){this.portals=new Map,this.stack=[],this.eventListeners=new Map,this.performanceMetrics=new Map,this.baseZIndex=2147483647,this.debugMode=!1,this.isInitialized=!1,this.animationService=null,this.stateService=null,this.analyticsService=null,this.accessibilityService=null,this.themeConfig={current:"default",customStyles:new Map,darkMode:!1,highContrast:!1},this.syncConfig={enabled:!1,sessionId:null,lastSync:null},this.metrics={portalsCreated:0,portalsDestroyed:0,memoryLeaksDetected:0,averageLifetime:0,maxConcurrentPortals:0,animationPerformance:[],stateOperations:0,analyticsEvents:0},this.init()}init(){"undefined"!=typeof window&&(this.isInitialized=!0,this.initializeEnhancedServices(),this.setupGlobalEventListeners(),this.startPerformanceMonitoring(),this.detectThemePreferences(),this.setupSyncConfiguration(),this.debugMode)}async initializeEnhancedServices(){try{const[{default:e},{default:t},{default:r},{default:s}]=await Promise.all([a((()=>Promise.resolve().then((()=>Ut))),void 0,import.meta.url),a((()=>Promise.resolve().then((()=>Bt))),void 0,import.meta.url),a((()=>Promise.resolve().then((()=>Wt))),void 0,import.meta.url),a((()=>Promise.resolve().then((()=>Qt))),void 0,import.meta.url)]);this.animationService=e,this.stateService=t,this.analyticsService=r,this.accessibilityService=s,this.debugMode}catch(e){}}detectThemePreferences(){if("undefined"!=typeof window&&window.matchMedia){const e=window.matchMedia("(prefers-color-scheme: dark)");this.themeConfig.darkMode=e.matches,this.darkModeHandler=e=>{this.themeConfig.darkMode=e.matches,this.updateThemeStyles()},e.addEventListener("change",this.darkModeHandler);const t=window.matchMedia("(prefers-contrast: high)");this.themeConfig.highContrast=t.matches,this.highContrastHandler=e=>{this.themeConfig.highContrast=e.matches,this.updateThemeStyles()},t.addEventListener("change",this.highContrastHandler),this.mediaQueryListeners={darkMode:{query:e,handler:this.darkModeHandler},highContrast:{query:t,handler:this.highContrastHandler}}}}setupSyncConfiguration(){this.syncConfig.sessionId=`portal_session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.syncConfig.lastSync=Date.now()}setupGlobalEventListeners(){this.beforeUnloadHandler=()=>{this.cleanupAll()},window.addEventListener("beforeunload",this.beforeUnloadHandler),"memory"in performance&&(this.memoryMonitorInterval=setInterval((()=>{this.monitorMemoryUsage()}),6e4)),this.visibilityChangeHandler=()=>{"hidden"===document.visibilityState?this.pauseNonEssentialOperations():this.resumeOperations()},document.addEventListener("visibilitychange",this.visibilityChangeHandler)}startPerformanceMonitoring(){const e=this.createPortal.bind(this),t=this.removePortal.bind(this);this.createPortal=(...t)=>{const a=performance.now(),r=e(...t),s=performance.now();return this.metrics.portalsCreated++,this.metrics.maxConcurrentPortals=Math.max(this.metrics.maxConcurrentPortals,this.portals.size),this.performanceMetrics.set(r.id,{createdAt:Date.now(),creationTime:s-a,isActive:!0}),r},this.removePortal=(...e)=>{const a=performance.now(),r=t(...e),s=performance.now();this.metrics.portalsDestroyed++;const i=e[0],n=this.performanceMetrics.get(i);if(n){n.destroyedAt=Date.now(),n.destroyTime=s-a,n.lifetime=n.destroyedAt-n.createdAt,n.isActive=!1;const e=Array.from(this.performanceMetrics.values()).filter((e=>e.lifetime));this.metrics.averageLifetime=e.reduce(((e,t)=>e+t.lifetime),0)/e.length}return r}}monitorMemoryUsage(){"memory"in performance&&performance.memory.usedJSHeapSize/1024/1024>200&&(this.metrics.memoryLeaksDetected++,this.cleanupInactivePortals(),window.gc&&"function"==typeof window.gc&&window.gc(),this.cleanupOldPerformanceMetrics())}updatePortalInteraction(e){const t=this.portals.get(e);t&&(t.lastInteraction=Date.now(),this.debugMode)}cleanupInactivePortals(){const e=Date.now();let t=0;return Array.from(this.portals.entries()).forEach((([a,r])=>{r&&r.lastInteraction&&e-r.lastInteraction>3e5&&!r.isPinned&&(this.removePortal(a,!0),t++)})),Array.from(this.performanceMetrics.keys()).forEach((e=>{this.portals.has(e)||this.performanceMetrics.delete(e)})),t>0&&this.debugMode,t}cleanupOldPerformanceMetrics(){const e=Date.now();let t=0;return Array.from(this.performanceMetrics.entries()).forEach((([a,r])=>{r&&r.createdAt&&e-r.createdAt>6e5&&!r.isActive&&(this.performanceMetrics.delete(a),t++)})),this.metrics.animationPerformance.length>100&&(this.metrics.animationPerformance=this.metrics.animationPerformance.slice(-50)),t>0&&this.debugMode,t}createPortal(e,t={}){if(!this.isInitialized||"undefined"==typeof window)return{container:null,portal:null,cleanup:()=>{}};const{zIndex:a=this.getNextZIndex(),accessibility:r=!0,stacking:s=!0,cleanup:i=!0,debug:n=this.debugMode,priority:o="normal",group:c="default",onFocus:l=null,onBlur:u=null,onEscape:h=null}=t;if(this.portals.has(e))return this.portals.get(e);let m=document.getElementById(e);m||(m=document.createElement("div"),m.id=e,m.className=`portal-container ${e} ${c}`,Object.assign(m.style,{position:"fixed",inset:"0",zIndex:a.toString(),pointerEvents:"none",contain:"layout style paint",isolation:"isolate"}),r&&(m.setAttribute("role","dialog"),m.setAttribute("aria-modal","true"),m.setAttribute("tabindex","-1"),m.setAttribute("aria-hidden","false"),m.setAttribute("aria-label","Portal "+e)),m.setAttribute("data-portal-id",e),m.setAttribute("data-portal-group",c),m.setAttribute("data-portal-priority",o),m.setAttribute("data-portal-created",Date.now().toString()),document.body&&document.body.appendChild(m));const d={container:m,id:e,zIndex:a,priority:o,group:c,options:t,createdAt:Date.now(),lastInteraction:Date.now(),isActive:!0,portal:e=>m&&e?ReactDOM.createPortal(e,m):null,focus:()=>{m&&(m.focus(),l&&l(e))},blur:()=>{m&&(m.blur(),u&&u(e))},updateZIndex:t=>{this.updatePortalZIndex(e,t)},bringToFront:()=>{this.bringPortalToFront(e)},sendToBack:()=>{this.sendPortalToBack(e)},cleanup:()=>{this.removePortal(e,i)}};if(this.portals.set(e,d),this.animationService&&"function"==typeof this.animationService.queueAnimation){const e=this.animationService.queueAnimation.bind(this.animationService);this.animationService.queueAnimation=(t,a)=>{const r=this.portals.get(t);r&&r.container&&r.container.style&&(r.container.style.willChange="transform, opacity");const s=e(t,a);return setTimeout((()=>{const e=this.portals.get(t);e&&e.container&&e.container.style&&(e.container.style.willChange="")}),a&&a.duration?Math.min(a.duration+100,1e3):500),s}}return s&&this.addToStack(e,a,o),this.setupPortalEventListeners(e,{onFocus:l,onBlur:u,onEscape:h}),d}removePortal(e,t=!0){const a=this.portals.get(e);if(!a)return;const{container:r}=a;if(this.removePortalEventListeners(e),t&&r&&r.parentNode)try{0===r.childElementCount?this.performCleanup(r,e):this.performDelayedCleanup(r,e)}catch(s){}this.portals.delete(e),this.removeFromStack(e),a.isActive=!1,this.debugMode}performCleanup(e,t){e&&(e.style&&e.style.transition?(e.style.opacity="0",setTimeout((()=>{try{e.parentNode&&e.parentNode.removeChild(e)}catch(t){}}),150)):e.parentNode&&e.parentNode.removeChild(e))}performDelayedCleanup(e,t){if(!e)return;const a=new MutationObserver((()=>{e&&0===e.childElementCount&&(a.disconnect(),this.performCleanup(e,t))}));a.observe(e,{childList:!0}),this.activeObservers||(this.activeObservers=new Map),this.activeObservers.set(t,a);const r=setTimeout((()=>{a.disconnect(),this.activeObservers?.delete(t),e&&e.parentNode&&0===e.childElementCount&&this.performCleanup(e,t)}),1e3);this.activeTimeouts||(this.activeTimeouts=new Map),this.activeTimeouts.set(t,r)}setupPortalEventListeners(e,t){const{onFocus:a,onBlur:r,onEscape:s}=t,i=[];if(a){const t=()=>a(e);document.addEventListener("focusin",t),i.push({type:"focusin",handler:t})}if(r){const t=()=>r(e);document.addEventListener("focusout",t),i.push({type:"focusout",handler:t})}if(s){const t=t=>{"Escape"===t.key&&this.isTopPortal(e)&&s(e)};document.addEventListener("keydown",t),i.push({type:"keydown",handler:t})}this.eventListeners.set(e,i)}removePortalEventListeners(e){const t=this.eventListeners.get(e);t&&(t.forEach((({type:e,handler:t})=>{document.removeEventListener(e,t)})),this.eventListeners.delete(e))}addToStack(e,t,a){const r={id:e,zIndex:t,priority:a,addedAt:Date.now()},s=this.stack.findIndex((e=>this.getPriorityWeight(e.priority)<this.getPriorityWeight(a)||this.getPriorityWeight(e.priority)===this.getPriorityWeight(a)&&e.zIndex<t));-1===s?this.stack.push(r):this.stack.splice(s,0,r)}removeFromStack(e){this.stack=this.stack.filter((t=>t.id!==e))}getPriorityWeight(e){return{low:1,normal:2,high:3,critical:4}[e]||2}getNextZIndex(){return++this.baseZIndex}updatePortalZIndex(e,t){const a=this.portals.get(e);a&&a.container&&(a.container.style.zIndex=t.toString(),a.zIndex=t,this.removeFromStack(e),this.addToStack(e,t,a.priority))}bringPortalToFront(e){if(this.portals.get(e)){this.updatePortalInteraction(e);const t=this.getNextZIndex();this.updatePortalZIndex(e,t)}}sendPortalToBack(e){if(this.portals.get(e)){const t=Math.min(...this.stack.map((e=>e.zIndex)))-1;this.updatePortalZIndex(e,t)}}isTopPortal(e){return this.stack.length>0&&this.stack[0].id===e}getStackInfo(){return{activePortals:Array.from(this.portals.entries()).map((([e,t])=>({id:e,zIndex:t.zIndex,priority:t.priority,group:t.group,isActive:t.isActive,createdAt:t.createdAt}))),stack:[...this.stack],metrics:{...this.metrics}}}getPortalInfo(e){return this.portals.get(e)}getPortalsByGroup(e){return Array.from(this.portals.values()).filter((t=>t.group===e))}cleanupGroup(e){this.getPortalsByGroup(e).forEach((e=>this.removePortal(e.id,!0)))}cleanupAll(){Array.from(this.portals.keys()).forEach((e=>this.removePortal(e,!0))),this.eventListeners.clear(),this.debugMode}debugPortals(){this.debugMode}updateThemeStyles(){document.querySelectorAll(".portal-container").forEach((e=>{this.themeConfig.darkMode?e.classList.add("portal-dark-mode"):e.classList.remove("portal-dark-mode"),this.themeConfig.highContrast?e.classList.add("portal-high-contrast"):e.classList.remove("portal-high-contrast")}))}setTheme(e,t={}){this.themeConfig.current=e,this.themeConfig.customStyles.set(e,t),this.updateThemeStyles()}coordinateAnimations(e,t="modal"){if(this.animationService&&"function"==typeof this.animationService.createCoordinatedAnimation)try{const a=e.map((e=>this.portals.get(e))).filter(Boolean),r=this.animationService.createCoordinatedAnimation(a,t);Array.isArray(r)&&r.forEach((e=>{e&&e.portalId&&this.animationService.queueAnimation(e.portalId,{type:"enter",...e})}))}catch(a){}}savePortalState(e,t){this.stateService&&(this.stateService.savePortalState(e,t),this.metrics.stateOperations++)}loadPortalState(e){return this.stateService?this.stateService.loadPortalState(e):null}trackPortalEvent(e,t,a={}){this.analyticsService&&(this.analyticsService.trackPortalEvent(e,t,a),this.metrics.analyticsEvents++)}setupPortalAccessibility(e,t={}){if(this.accessibilityService&&"function"==typeof this.accessibilityService.setupPortalAttributes){const r=this.portals.get(e);if(r&&r.container)try{return this.accessibilityService.setupPortalAttributes(r.container,{portalId:e,...t}),this.accessibilityService.setupFocusTrap(r.container)||(()=>{})}catch(a){return()=>{}}}return()=>{}}enableSync(e=!0){this.syncConfig.enabled=e,e&&this.setupSyncListeners()}setupSyncListeners(){const e=this.createPortal.bind(this),t=this.removePortal.bind(this);this.createPortal=(...t)=>{const a=e(...t);return this.syncConfig.enabled&&this.syncPortalState(t[0],"created"),a},this.removePortal=(...e)=>{const a=t(...e);return this.syncConfig.enabled&&this.syncPortalState(e[0],"removed"),a}}syncPortalState(e,t){this.debugMode}createPortalGroup(e,t={}){const a=this.getPortalsByGroup(e);return{id:e,portals:a,createPortal:(a,r={})=>this.createPortal(a,{...t,...r,group:e}),removeAll:()=>this.cleanupGroup(e),coordinateAnimations:e=>{const t=a.map((e=>e.id));this.coordinateAnimations(t,e)}}}getPerformanceMetrics(){const e={...this.metrics,activePortals:this.portals.size,stackDepth:this.stack.length,memoryUsage:"memory"in performance?(performance.memory.usedJSHeapSize/1024/1024).toFixed(2)+"MB":"N/A"};return this.animationService&&(e.animationMetrics=this.animationService.getPerformanceMetrics()),this.stateService&&(e.stateMetrics=this.stateService.getStateMetrics()),this.analyticsService&&(e.analyticsMetrics=this.analyticsService.getSessionMetrics()),e}debugPortals(){this.debugMode&&(this.animationService,this.stateService,this.analyticsService)}pauseNonEssentialOperations(){this.debugMode,this.memoryMonitorInterval&&(clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=null),this.analyticsService&&this.analyticsService.pause&&this.analyticsService.pause()}resumeOperations(){this.debugMode,"memory"in performance&&(this.memoryMonitorInterval=setInterval((()=>{this.monitorMemoryUsage()}),3e4)),this.analyticsService&&this.analyticsService.resume&&this.analyticsService.resume()}cleanupAll(){Array.from(this.portals.keys()).forEach((e=>this.removePortal(e,!0))),this.eventListeners.clear(),this.beforeUnloadHandler&&(window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null),this.visibilityChangeHandler&&(document.removeEventListener("visibilitychange",this.visibilityChangeHandler),this.visibilityChangeHandler=null),this.memoryMonitorInterval&&(clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=null),this.mediaQueryListeners&&(Object.values(this.mediaQueryListeners).forEach((({query:e,handler:t})=>{e.removeEventListener("change",t)})),this.mediaQueryListeners=null),this.activeObservers&&(this.activeObservers.forEach((e=>e.disconnect())),this.activeObservers.clear()),this.activeTimeouts&&(this.activeTimeouts.forEach((e=>clearTimeout(e))),this.activeTimeouts.clear()),this.animationService&&this.animationService.cleanup(),this.stateService&&this.stateService.cleanup(),this.analyticsService&&this.analyticsService.cleanup(),this.accessibilityService&&this.accessibilityService.cleanup(),this.portals.clear(),this.stack=[],this.performanceMetrics.clear(),this.themeConfig.customStyles.clear(),this.debugMode}},nt="streamr_search_history";function ot(e){return e.trim().toLowerCase().replace(/\s+/g," ")}const ct=new class{constructor(){this.history=this.loadHistory(),this.listeners=new Set,this.saveHistoryDebounced=function(e,t=200){let a;return(...r)=>{clearTimeout(a),a=setTimeout((()=>e(...r)),t)}}(this.saveHistory.bind(this),150),this._lastCleanup=Date.now(),this._autoCleanupInterval=setInterval((()=>this.cleanup()),6e5)}loadHistory(){try{const e=localStorage.getItem(nt);if(!e)return[];let t=JSON.parse(e);const a=new Set;t=t.filter((e=>{const t=ot(e.query);return!a.has(t)&&(a.add(t),!0)}));const r=Date.now(),s=t.filter((e=>{const t=new Date(e.timestamp).getTime();return 3888e6>r-t}));return s.length!==t.length&&this.saveHistory(s),s}catch(e){return[]}}saveHistory(e=this.history){try{localStorage.setItem(nt,JSON.stringify(e))}catch(t){}}addToHistory(e,t="general",a={}){if(!e||!e.trim())return;const r=e.trim(),s=ot(r),i=(new Date).toISOString(),n=this.history.findIndex((e=>ot(e.query)===s&&e.type===t));if(-1!==n){const e=this.history[n];e.count=(e.count||1)+1,e.timestamp=i,e.meta={...e.meta,...a},this.history.splice(n,1),this.history.unshift(e)}else this.history.unshift({query:r,type:t,timestamp:i,count:1,meta:{...a}});this.history.length>30&&(this.history=this.history.slice(0,30)),this.saveHistoryDebounced(this.history),this.notifyListeners()}getHistory(e=null){return e?this.history.filter((t=>t.type===e)):[...this.history]}getHistoryByType(e){return this.history.filter((t=>t.type===e))}getRecentSearches(e=10,t=null){return(t?this.getHistoryByType(t):this.history).slice(0,e)}getPopularSearches(e=10,t=null){return[...t?this.getHistoryByType(t):this.history].sort(((e,t)=>t.count-e.count||new Date(t.timestamp)-new Date(e.timestamp))).slice(0,e)}removeFromHistory(e,t=null){const a=ot(e);this.history=this.history.filter((e=>ot(e.query)!==a||t&&e.type!==t)),this.saveHistoryDebounced(this.history),this.notifyListeners()}clearHistory(e=null){this.history=e?this.history.filter((t=>t.type!==e)):[],this.saveHistoryDebounced(this.history),this.notifyListeners()}incrementSearchCount(e,t=null){const a=ot(e),r=this.history.find((e=>ot(e.query)===a&&(!t||e.type===t)));r&&(r.count=(r.count||1)+1,r.timestamp=(new Date).toISOString(),this.saveHistoryDebounced(this.history),this.notifyListeners())}searchHistory(e,t=null){const a=ot(e);return this.history.filter((e=>ot(e.query).includes(a)&&(!t||e.type===t)))}getSuggestions(e,t=5,a=null){if(!e||!e.trim())return[];const r=ot(e),s=this.history.filter((e=>ot(e.query).includes(r)&&(!a||e.type===a))).sort(((e,t)=>ot(e.query)===r?-1:ot(t.query)===r?1:e.count!==t.count?t.count-e.count:new Date(t.timestamp)-new Date(e.timestamp))).slice(0,t).map((e=>e.query));return[...new Set(s)]}getTrendingSearches(e=5,t=null){const a=Date.now()-6048e5,r=this.history.filter((e=>new Date(e.timestamp).getTime()>a&&(!t||e.type===t))),s={};return r.forEach((e=>{const t=ot(e.query);s[t]=(s[t]||0)+(e.count||1)})),Object.entries(s).sort((([,e],[,t])=>t-e)).slice(0,e).map((([e])=>e))}exportHistory(){return{version:2,history:this.history,exportDate:(new Date).toISOString(),totalItems:this.history.length}}importHistory(e){try{if(e&&Array.isArray(e.history)){const t=[...e.history,...this.history],a=new Map;for(const e of t){const t=ot(e.query)+"|"+(e.type||"general");if(a.has(t)){const r=a.get(t);r.count+=e.count||1,new Date(e.timestamp)>new Date(r.timestamp)&&(r.timestamp=e.timestamp,r.meta={...r.meta,...e.meta}),a.set(t,r)}else a.set(t,{...e,count:e.count||1})}return this.history=Array.from(a.values()).sort(((e,t)=>new Date(t.timestamp)-new Date(e.timestamp))).slice(0,30),this.saveHistoryDebounced(this.history),this.notifyListeners(),!0}return!1}catch(t){return!1}}subscribe(e){return this.listeners.add(e),e([...this.history]),()=>this.listeners.delete(e)}notifyListeners(){for(const t of this.listeners)try{t([...this.history])}catch(e){}}getStats(){const e=Date.now(),t=e-864e5,a=e-6048e5,r=e-2592e6,s=this.history.filter((e=>new Date(e.timestamp).getTime()>t)),i=this.history.filter((e=>new Date(e.timestamp).getTime()>a)),n=this.history.filter((e=>new Date(e.timestamp).getTime()>r)),o=this.getPopularSearches(1)[0]?.query||null,c=new Set(this.history.map((e=>ot(e.query)))),l=Math.max(1,this.history.length>0?(e-new Date(this.history[this.history.length-1].timestamp).getTime())/864e5:1),u=this.history.length/l;return{totalSearches:this.history.length,uniqueQueries:c.size,searchesToday:s.length,searchesThisWeek:i.length,searchesThisMonth:n.length,mostSearched:o,averageSearchesPerDay:+u.toFixed(2)}}cleanup(){const e=Date.now(),t=this.history.filter((t=>{const a=new Date(t.timestamp).getTime();return 3888e6>e-a}));t.length!==this.history.length&&(this.history=t,this.saveHistoryDebounced(this.history),this.notifyListeners()),this._lastCleanup=e}_destroy(){clearInterval(this._autoCleanupInterval)}};"undefined"!=typeof window&&window.addEventListener("beforeunload",(()=>{ct.cleanup(),ct._destroy&&ct._destroy()}));const lt=new class{constructor(){this.retryConfig={maxRetries:3,baseDelay:1e3,maxDelay:5e3,backoffMultiplier:2,jitterFactor:.1},this.networkProfiles={fast:{timeout:8e3,retries:2},slow:{timeout:15e3,retries:3},verySlow:{timeout:25e3,retries:4}}}detectNetworkProfile(){if("connection"in navigator){const e=navigator.connection;return"4g"===e.effectiveType||e.downlink>10?"fast":"3g"===e.effectiveType||e.downlink>2?"slow":"verySlow"}return"fast"}calculateRetryDelay(e,t=this.retryConfig.baseDelay){const a=t*Math.pow(this.retryConfig.backoffMultiplier,e-1),r=a*this.retryConfig.jitterFactor*Math.random();return Math.min(a+r,this.retryConfig.maxDelay)}async retryWithBackoff(e,t=""){const a=this.detectNetworkProfile(),r=this.networkProfiles[a];let s;for(let n=1;n<=r.retries;n++)try{const t=new AbortController,a=setTimeout((()=>t.abort()),r.timeout);try{const r=await e(t.signal);return clearTimeout(a),{success:!0,data:r,attempt:n}}catch(i){throw clearTimeout(a),i}}catch(i){if(s=i,this.isNonRetryableError(i))break;if(n===r.retries)break;const e=this.calculateRetryDelay(n);await new Promise((t=>setTimeout(t,e)))}return{success:!1,error:s,attempts:r.retries,context:t}}isNonRetryableError(e){return 401===e.status||403===e.status||429===e.status||("AbortError"===e.name&&e.message.includes("timeout"),!1)}createLoadingState(){return{isLoading:!1,error:null,retryCount:0,lastAttempt:null,isRetrying:!1}}updateLoadingState(e,t){return{...e,...t,lastAttempt:Date.now()}}async handleLoadingFailure(e,t,a,r){const s=await this.retryWithBackoff(e,t);if(s.success)return s.data;throw r&&r(s.error,s.attempts),s.error}createRetryableOperation(e,t){return async()=>this.retryWithBackoff(e,t)}monitorNetworkStatus(e){if("connection"in navigator){const t=navigator.connection,a=()=>{const a=this.detectNetworkProfile();e(a,t)};return t.addEventListener("change",a),a(),()=>t.removeEventListener("change",a)}return()=>{}}getErrorMessage(e,t=""){return e?"string"==typeof e?e.includes("Failed to fetch")?"Unable to connect to the server. Please check your internet connection.":e:"AbortError"===e.name?"Request timed out. Please check your connection and try again.":(e.message||"").includes("Failed to fetch")?"Unable to connect to the server. Please check your internet connection.":429===e.status?"Too many requests. Please wait a moment and try again.":500>e.status?`Failed to load ${t}. Please try again.`:"Server error. Please try again in a moment.":`Failed to load ${t}. Please try again.`}getNetworkStatusBadge(e){return"fast"===e?null:{slow:{text:"Slow Connection",color:"bg-yellow-500/20 border-yellow-500/30 text-yellow-300"},verySlow:{text:"Very Slow Connection",color:"bg-orange-500/20 border-orange-500/30 text-orange-300"}}[e]||null}createLoadingIndicatorState(){return{showRetryButton:!1,retryButtonText:"Retry",showNetworkStatus:!1,networkStatusText:"",canRetry:!0}}updateLoadingIndicator(e,t,a,r){const s=a>t;let i="Retry";t>0&&(i=`Retry (${t}/${a})`);let n="";return"slow"===r?n="Slow connection detected":"verySlow"===r&&(n="Very slow connection detected"),{...e,showRetryButton:t>0&&s,retryButtonText:i,showNetworkStatus:n.length>0,networkStatusText:n,canRetry:s}}},ut=18e5,ht=36e5,mt=new Map,dt=new class{constructor(){this.cache=new Map,this.requestQueue=[],this.isProcessingQueue=!1,this.rateLimitConfig={maxRequests:40,windowMs:1e4,currentRequests:0,resetTime:Date.now()},this.analytics={totalRequests:0,cacheHits:0,cacheMisses:0,errors:0,lastError:null}}generateCacheKey(e,t,a=null,r=null,s=null){const i=[e,t];return null!==a&&i.push("s"+a),null!==r&&i.push("e"+r),s&&i.push(s),i.join("_")}getCachedData(e,t){const a=this.cache.get(e);return a?Date.now()-a.timestamp>t?(this.cache.delete(e),this.analytics.cacheMisses++,null):(this.analytics.cacheHits++,a.data):(this.analytics.cacheMisses++,null)}setCachedData(e,t,a){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:a})}checkRateLimit(){const e=Date.now();return e-this.rateLimitConfig.resetTime>this.rateLimitConfig.windowMs&&(this.rateLimitConfig.currentRequests=0,this.rateLimitConfig.resetTime=e),this.rateLimitConfig.currentRequests<this.rateLimitConfig.maxRequests&&(this.rateLimitConfig.currentRequests++,!0)}async fetchWithRetry(e,t=1){const a=`${e}_${t}`;if(this.analytics.totalRequests++,mt.has(a))return mt.get(a);const r=this._executeFetchWithRetry(e,t);mt.set(a,r);try{return await r}finally{mt.delete(a)}}async _executeFetchWithRetry(e,t=1){const a=performance.now();try{const t=new AbortController,r=setTimeout((()=>t.abort()),1e4),s=await fetch(e,{signal:t.signal,headers:{Accept:"application/json","Content-Type":"application/json"}});if(clearTimeout(r),!s.ok)throw Error(`HTTP ${s.status}: ${s.statusText}`);const i=await s.json(),n=performance.now()-a;return u.trackApiCall(e,"GET",n,s.status,JSON.stringify(i).length),i}catch(r){const s=performance.now()-a;if(u.trackApiCall(e,"GET",s,0,0),u.trackError(r,{url:e,attempt:t}),this.analytics.errors++,this.analytics.lastError=r,4>t&&this.shouldRetry(r)){let a=1e3*Math.pow(2,t-1);return a=Math.min(a,1e4),a=Math.floor(a*(.7+.6*Math.random())),await new Promise((e=>setTimeout(e,a))),this._executeFetchWithRetry(e,t+1)}throw r}}shouldRetry(e){return"AbortError"===e.name||e.message.includes("fetch")||e.message.includes("network")||e.message.includes("timeout")||e.message.includes("HTTP 5")&&!e.message.includes("HTTP 404")}transformEpisodeData(e,t,a){if(!e)return null;const r=!!e.air_date&&new Date(e.air_date)<=new Date;return{id:e.id,name:e.name||"Unknown Episode",overview:e.overview||"",air_date:e.air_date,episode_number:e.episode_number||0,season_number:a,runtime:e.runtime||0,vote_average:e.vote_average||0,vote_count:e.vote_count||0,still_path:e.still_path?`${v}/w300${e.still_path.startsWith("/")?e.still_path:"/"+e.still_path}`:null,crew:e.crew||[],guest_stars:e.guest_stars||[],production_code:e.production_code||"",show_id:t,formatted_runtime:this.formatRuntime(e.runtime),formatted_air_date:this.formatDate(e.air_date),rating_percentage:e.vote_average?Math.round(10*e.vote_average):0,has_overview:!(!e.overview||!e.overview.trim()),has_still:!!e.still_path,is_aired:r,is_upcoming:!r,short_overview:e.overview&&e.overview.length>120?e.overview.slice(0,120)+"…":e.overview||""}}transformSeasonData(e,t){if(!e)return null;let a=0,r=0;if(e.episodes&&Array.isArray(e.episodes)){const t=new Date;for(const s of e.episodes)s.air_date&&new Date(s.air_date)<=t?a++:r++}return{id:e.id,name:e.name||"Season "+e.season_number,overview:e.overview||"",season_number:e.season_number,air_date:e.air_date,episode_count:e.episode_count||0,poster_path:e.poster_path?`${v}/w500${e.poster_path.startsWith("/")?e.poster_path:"/"+e.poster_path}`:null,show_id:t,formatted_air_date:this.formatDate(e.air_date),has_overview:!(!e.overview||!e.overview.trim()),has_poster:!!e.poster_path,is_special:0===e.season_number,is_latest:!1,aired_episodes:a,unaired_episodes:r}}formatRuntime(e){if(!e||0>=e)return"Unknown";const t=Math.floor(e/60),a=e%60;return t>0?`${t}h ${a}m`:a+"m"}formatDate(e){if(!e)return"TBA";try{const t=new Date(e),a=t-new Date;let r="";if(!isNaN(a)){const e=Math.round(a/864e5);0===e?r=" (Today)":1===e?r=" (Tomorrow)":e>1&&7>e?r=` (in ${e} days)`:-1===e?r=" (Yesterday)":-1>e&&e>-7&&(r=` (${Math.abs(e)} days ago)`)}return t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})+r}catch(t){return"Invalid Date"}}async getSeason(e,t,a={}){const r=this.generateCacheKey("season",e,t),s=a.cacheTTL||ut,i=this.getCachedData(r,s);if(i&&!a.forceRefresh)return i;if(!this.checkRateLimit())return this.queueRequest((()=>this.getSeason(e,t,a)));try{const a=`${w}/tv/${e}/season/${t}?api_key=${f}&language=en-US&append_to_response=credits,videos,images`,i=await this.fetchWithRetry(a);if(!i)throw Error("Invalid response from TMDB API");const n={id:i.id,name:i.name,overview:i.overview||"",season_number:i.season_number,air_date:i.air_date,poster_path:i.poster_path?`${v}/w500${i.poster_path.startsWith("/")?i.poster_path:"/"+i.poster_path}`:null,episode_count:i.episodes?i.episodes.length:0,episodes:i.episodes?i.episodes.map((a=>this.transformEpisodeData(a,e,t))).filter(Boolean):[],show_id:e,formatted_air_date:this.formatDate(i.air_date),has_overview:!(!i.overview||!i.overview.trim()),has_poster:!!i.poster_path,is_special:0===i.season_number};return this.setCachedData(r,n,s),n}catch(n){throw this.analytics.errors++,this.analytics.lastError=n,n}}async getSeasonsBatch(e,t,a={}){const r=[],s=[];for(const i of t){const n=this.generateCacheKey("season",e,i),o=a.cacheTTL||ut,c=this.getCachedData(n,o);c&&!a.forceRefresh?r.push(c):s.push(this.getSeason(e,i,a).then((e=>({season:e,index:t.indexOf(i)}))).catch((e=>({error:e,index:t.indexOf(i)}))))}if(s.length>0){const e=await Promise.allSettled(s);for(const t of e)if("fulfilled"===t.status){const{season:e,index:a}=t.value;e&&(r[a]=e)}else this.analytics.errors++,this.analytics.lastError=t.reason}return r.filter(Boolean)}async getAllSeasons(e,t={}){const a=this.generateCacheKey("seasons_metadata",e),r=t.cacheTTL||ht,s=this.getCachedData(a,r);if(s&&!t.forceRefresh)return s;try{const t=`${w}/tv/${e}?api_key=${f}&language=en-US&append_to_response=seasons`,s=await this.fetchWithRetry(t);if(!s||!s.seasons)throw Error("Invalid response from TMDB API");const i=s.seasons.map((t=>this.transformSeasonData(t,e))).filter(Boolean);return i.length>0&&(i[i.length-1].is_latest=!0),this.setCachedData(a,i,r),i}catch(i){throw this.analytics.errors++,this.analytics.lastError=i,i}}async getEpisodesProgressive(e,t,a={}){const{page:r=1,pageSize:s=20,sortBy:i="episode_number",sortOrder:n="asc"}=a;try{const o=await this.getSeason(e,t,a);if(!o||!o.episodes)return{episodes:[],total:0,page:1,hasMore:!1};let c=[...o.episodes];c.sort(((e,t)=>{const a=e[i]||0,r=t[i]||0;return"asc"===n?a-r:r-a}));const l=(r-1)*s,u=l+s;return{episodes:c.slice(l,u),total:c.length,page:r,hasMore:u<c.length,totalPages:Math.ceil(c.length/s)}}catch(o){throw this.analytics.errors++,this.analytics.lastError=o,o}}async searchEpisodes(e,t,a,r={}){try{const s=await this.getSeason(e,t,r);if(!s||!s.episodes)return[];const i=a.toLowerCase();return s.episodes.filter((e=>[e.name?.toLowerCase()||"",e.overview?.toLowerCase()||"",e.episode_number?.toString()||"",e.production_code?.toLowerCase()||""].some((e=>e.includes(i)||this.fuzzyMatch(e,i)))))}catch(s){throw this.analytics.errors++,this.analytics.lastError=s,s}}fuzzyMatch(e,t){if(!e||!t)return!1;if(e.includes(t))return!0;if(Math.abs(e.length-t.length)>2)return!1;const a=Array(e.length+1).fill(null).map((()=>Array(t.length+1).fill(0)));for(let r=0;r<=e.length;r++)a[r][0]=r;for(let r=0;r<=t.length;r++)a[0][r]=r;for(let r=1;r<=e.length;r++)for(let s=1;s<=t.length;s++)e[r-1]===t[s-1]?a[r][s]=a[r-1][s-1]:a[r][s]=1+Math.min(a[r-1][s],a[r][s-1],a[r-1][s-1]);return 2>=a[e.length][t.length]}async getSeasonStats(e,t,a={}){try{const r=await this.getSeason(e,t,a);if(!r||!r.episodes)return null;const s=r.episodes,i=s.length,n=s.filter((e=>e.vote_average>0)),o=s.filter((e=>e.runtime>0)),c=s.filter((e=>e.has_overview)),l=s.filter((e=>e.is_aired)),u=s.filter((e=>!e.is_aired));return{total_episodes:i,average_rating:n.length>0?n.reduce(((e,t)=>e+t.vote_average),0)/n.length:0,total_runtime:o.reduce(((e,t)=>e+t.runtime),0),average_runtime:o.length>0?o.reduce(((e,t)=>e+t.runtime),0)/o.length:0,episodes_with_overview:c.length,episodes_with_ratings:n.length,episodes_with_runtime:o.length,best_rated_episode:n.length>0?n.reduce(((e,t)=>t.vote_average>e.vote_average?t:e)):null,longest_episode:o.length>0?o.reduce(((e,t)=>t.runtime>e.runtime?t:e)):null,aired_episodes:l.length,unaired_episodes:u.length,first_air_date:s.length>0?s[0].air_date:null,last_air_date:s.length>0?s[s.length-1].air_date:null}}catch(r){throw this.analytics.errors++,this.analytics.lastError=r,r}}async queueRequest(e){return new Promise(((t,a)=>{this.requestQueue.push({requestFn:e,resolve:t,reject:a}),this.processQueue()}))}async processQueue(){if(!this.isProcessingQueue&&0!==this.requestQueue.length){for(this.isProcessingQueue=!0;this.requestQueue.length>0;){const{requestFn:t,resolve:a,reject:r}=this.requestQueue.shift();try{a(await t())}catch(e){this.analytics.errors++,this.analytics.lastError=e,r(e)}await new Promise((e=>setTimeout(e,100)))}this.isProcessingQueue=!1}}clearCache(e=null){if(e)for(const[t]of this.cache)t.includes(`_${e}_`)&&this.cache.delete(t);else this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys()),memoryUsage:1e3*this.cache.size,analytics:{...this.analytics}}}cleanup(){this.cache.clear(),this.requestQueue=[],mt.clear(),this.analytics={totalRequests:0,cacheHits:0,cacheMisses:0,errors:0,lastError:null}}},pt=new class{calculateTotalWatchTime(e){if(!e||"object"!=typeof e)return 0;let t=0;return Object.values(e).forEach((e=>{if(e.progress&&e.progress>0){let a=0;"movie"===e.type?a=120:"tv"===e.type&&(a=45);const r=e.progress/100*a;t+=r}})),Math.round(t/60*10)/10}calculateContentCompleted(e){if(!e||"object"!=typeof e)return{movies:0,tvEpisodes:0,total:0};let t=0,a=0;return Object.values(e).forEach((e=>{e.progress&&e.progress>=90&&("movie"===e.type?t++:"tv"===e.type&&a++)})),{movies:t,tvEpisodes:a,total:t+a}}calculateReviewsWritten(e,t){if(!e||!Array.isArray(e))return 0;let a=0;return a+=e.length,t&&"object"==typeof t&&Object.values(t).forEach((e=>{e.progress&&e.progress>=90&&(a+=.5)})),Math.round(a)}calculateWatchTimeByType(e){if(!e||"object"!=typeof e)return{movies:0,tv:0};let t=0,a=0;return Object.values(e).forEach((e=>{if(e.progress&&e.progress>0){let r=0;if("movie"===e.type){r=120;const a=e.progress/100*r;t+=a}else if("tv"===e.type){r=45;const t=e.progress/100*r;a+=t}}})),{movies:Math.round(t/60*10)/10,tv:Math.round(a/60*10)/10}}calculateAverageRating(e){if(!e||!Array.isArray(e)||0===e.length)return 0;const t=e.reduce(((e,t)=>e+(parseFloat(t.rating)||0)),0);return Math.round(t/e.length*10)/10}calculateFavoriteGenres(e){if(!e||!Array.isArray(e))return[];const t={};return e.forEach((e=>{e.genres&&Array.isArray(e.genres)&&e.genres.forEach((e=>{const a="string"==typeof e?e:e.name;a&&(t[a]=(t[a]||0)+1)}))})),Object.entries(t).sort((([,e],[,t])=>t-e)).slice(0,3).map((([e])=>e))}calculateViewingStreak(e){if(!e||"object"!=typeof e)return 0;const t=new Date,a=Object.values(e).map((e=>new Date(e.lastWatched))).filter((e=>!isNaN(e.getTime()))).sort(((e,t)=>t-e));if(0===a.length)return 0;let r=0,s=new Date(t);s.setHours(0,0,0,0);for(let i=0;365>i&&a.some((e=>{const t=new Date(e);return t.setHours(0,0,0,0),t.getTime()===s.getTime()}));i++)r++,s.setDate(s.getDate()-1);return r}getComprehensiveStats(e){const{viewingProgress:t={},watchlist:a=[]}=e,r=this.calculateTotalWatchTime(t),s=this.calculateContentCompleted(t),i=this.calculateReviewsWritten(a,t),n=this.calculateWatchTimeByType(t),o=this.calculateAverageRating(a),c=this.calculateFavoriteGenres(a),l=this.calculateViewingStreak(t);return{watchTime:{total:r,movies:n.movies,tv:n.tv,formatted:r+"h"},content:{completed:s.total,movies:s.movies,tvEpisodes:s.tvEpisodes,inProgress:Object.keys(t).length},reviews:{written:i,averageRating:o,watchlistItems:a.length},preferences:{favoriteGenres:c,viewingStreak:l},summary:{totalHours:r,completedContent:s.total,totalReviews:i,currentStreak:l}}}formatWatchTime(e){return 1>e?Math.round(60*e)+"m":24>e?e+"h":Math.round(e/24)+"d"}getAchievementBadgesWithProgress(e){return e?[{id:"century_watcher",name:"Century Watcher",description:"Watch 100+ hours of content",icon:"FilmIcon",category:"watch_time",progress:Math.min(e.watchTime.total,100),maxProgress:100,unlocked:e.watchTime.total>=100,rarity:"common",points:10},{id:"binge_master",name:"Binge Master",description:"Watch 500+ hours of content",icon:"TvIcon",category:"watch_time",progress:Math.min(e.watchTime.total,500),maxProgress:500,unlocked:e.watchTime.total>=500,rarity:"rare",points:25},{id:"marathon_runner",name:"Marathon Runner",description:"Watch 1000+ hours of content",icon:"TrophyIcon",category:"watch_time",progress:Math.min(e.watchTime.total,1e3),maxProgress:1e3,unlocked:e.watchTime.total>=1e3,rarity:"epic",points:50},{id:"first_steps",name:"First Steps",description:"Complete your first piece of content",icon:"CheckCircleIcon",category:"completion",progress:Math.min(e.content.completed,1),maxProgress:1,unlocked:e.content.completed>=1,rarity:"common",points:5},{id:"content_crusher",name:"Content Crusher",description:"Complete 50+ pieces of content",icon:"PlayIcon",category:"completion",progress:Math.min(e.content.completed,50),maxProgress:50,unlocked:e.content.completed>=50,rarity:"rare",points:20},{id:"completionist",name:"Completionist",description:"Complete 100+ pieces of content",icon:"TrophyIcon",category:"completion",progress:Math.min(e.content.completed,100),maxProgress:100,unlocked:e.content.completed>=100,rarity:"epic",points:40},{id:"getting_hooked",name:"Getting Hooked",description:"Maintain a 3+ day viewing streak",icon:"FlagIcon",category:"streak",progress:Math.min(e.preferences.viewingStreak,3),maxProgress:3,unlocked:e.preferences.viewingStreak>=3,rarity:"common",points:10},{id:"weekly_warrior",name:"Weekly Warrior",description:"Maintain a 7+ day viewing streak",icon:"BoltIcon",category:"streak",progress:Math.min(e.preferences.viewingStreak,7),maxProgress:7,unlocked:e.preferences.viewingStreak>=7,rarity:"rare",points:20},{id:"streak_master",name:"Streak Master",description:"Maintain a 30+ day viewing streak",icon:"FireIcon",category:"streak",progress:Math.min(e.preferences.viewingStreak,30),maxProgress:30,unlocked:e.preferences.viewingStreak>=30,rarity:"legendary",points:100},{id:"critic",name:"Critic",description:"Rate 10+ pieces of content",icon:"StarIcon",category:"rating",progress:Math.min(e.reviews.written,10),maxProgress:10,unlocked:e.reviews.written>=10,rarity:"common",points:15},{id:"senior_critic",name:"Senior Critic",description:"Rate 50+ pieces of content",icon:"StarIcon",category:"rating",progress:Math.min(e.reviews.written,50),maxProgress:50,unlocked:e.reviews.written>=50,rarity:"rare",points:30},{id:"master_critic",name:"Master Critic",description:"Rate 100+ pieces of content",icon:"TrophyIcon",category:"rating",progress:Math.min(e.reviews.written,100),maxProgress:100,unlocked:e.reviews.written>=100,rarity:"epic",points:60},{id:"explorer",name:"Explorer",description:"Watch content from 5+ different genres",icon:"GlobeAltIcon",category:"diversity",progress:Math.min(e.preferences.favoriteGenres.length,5),maxProgress:5,unlocked:e.preferences.favoriteGenres.length>=5,rarity:"common",points:15},{id:"genre_master",name:"Genre Master",description:"Watch content from 10+ different genres",icon:"LightBulbIcon",category:"diversity",progress:Math.min(e.preferences.favoriteGenres.length,10),maxProgress:10,unlocked:e.preferences.favoriteGenres.length>=10,rarity:"rare",points:30},{id:"early_bird",name:"Early Bird",description:"Join the platform early",icon:"UserIcon",category:"special",progress:1,maxProgress:1,unlocked:!0,rarity:"special",points:5},{id:"active_user",name:"Active User",description:"Use the platform for 7+ consecutive days",icon:"FireIcon",category:"special",progress:Math.min(e.preferences.viewingStreak,7),maxProgress:7,unlocked:e.preferences.viewingStreak>=7,rarity:"common",points:15}]:[]}calculateTotalPoints(e){return e&&Array.isArray(e)?e.filter((e=>e.unlocked)).reduce(((e,t)=>e+t.points),0):0}getAchievementStats(e){return e&&Array.isArray(e)?{total:e.length,unlocked:e.filter((e=>e.unlocked)).length,locked:e.filter((e=>!e.unlocked)).length,totalPoints:this.calculateTotalPoints(e),completionRate:Math.round(e.filter((e=>e.unlocked)).length/e.length*100),rarityBreakdown:{common:e.filter((e=>"common"===e.rarity&&e.unlocked)).length,rare:e.filter((e=>"rare"===e.rarity&&e.unlocked)).length,epic:e.filter((e=>"epic"===e.rarity&&e.unlocked)).length,legendary:e.filter((e=>"legendary"===e.rarity&&e.unlocked)).length,special:e.filter((e=>"special"===e.rarity&&e.unlocked)).length}}:{total:0,unlocked:0,locked:0,totalPoints:0,completionRate:0,rarityBreakdown:{common:0,rare:0,epic:0,legendary:0,special:0}}}getRecentlyUnlocked(e,t=5){return e&&Array.isArray(e)?e.filter((e=>e.unlocked)).slice(0,t):[]}getNextAchievements(e,t=3){return e&&Array.isArray(e)?e.filter((e=>!e.unlocked)).sort(((e,t)=>e.maxProgress-t.maxProgress)).slice(0,t):[]}},gt=3e5,yt=new Map,ft={hits:0,misses:0,evictions:0,sets:0,clears:0};function wt(e,t){if(yt.size>=50){const e=yt.keys().next().value;yt.delete(e),ft.evictions++}yt.set(e,{data:t,timestamp:Date.now()}),ft.sets++}function vt(){yt.clear(),ft.clears++}let _t=null,bt=null;const Tt=new Map;async function St({method:t="get",url:a,data:r,params:s,cacheKey:i=null,forceRefresh:n=!1,staleWhileRevalidate:o=!0,signal:l=null,timeoutOverride:u=null}){const{timeout:h}=xe(),m=u||h,d=i?function(e){try{return"string"==typeof e?e:JSON.stringify(e)}catch(t){return e+""}}(i):null;if(d&&!n){const e=function(e){return yt.get(e)||null}(d);if(e&&Date.now()-e.timestamp<gt)return ft.hits++,o&&function({method:e,url:t,data:a,params:r,key:s,signal:i,effectiveTimeout:n}){(async()=>{try{const o={method:e,url:t,data:a,params:r,cacheKey:s,forceRefresh:!0,staleWhileRevalidate:!1,signal:i,timeoutOverride:n};await St(o)}catch(o){}})()}({method:t,url:a,data:r,params:s,key:d,signal:l,effectiveTimeout:m}),e.data}const p=d||`${t.toUpperCase()}::${a}::${JSON.stringify(s||{})}::${JSON.stringify(r||{})}`;if(Tt.has(p))return Tt.get(p);const g=(async()=>{try{const i={timeout:m};l&&(i.signal=l),s&&(i.params=s);const n=(bt||(bt=function(){const t=c.create({baseURL:(_t||(_t=e()),_t),headers:{"Content-Type":"application/json"}});var a;return(a=t).interceptors.request.use((e=>{const t=localStorage.getItem("accessToken");return t&&(e.headers.Authorization="Bearer "+t),e.metadata={startTime:Date.now()},e}),(e=>Promise.reject(e))),a.interceptors.response.use((e=>(Date.now(),e.config.metadata?.startTime||Date.now(),e)),(e=>{const t={message:e.message||"API request failed",status:e.response?.status||null,data:e.response?.data||null};return t._raw=e,e.response?Promise.reject(t):e.request?Promise.reject({...t,message:"No response from server"}):Promise.reject(t)})),t}()),bt),o=()=>n.request({method:t,url:a,data:r,...i}).then((e=>e.data)),u=await Le(o);return d&&wt(d,u),u}finally{Tt.delete(p)}})();return Tt.set(p,g),g}const kt={async getDiscussions(e=1,t=10,a="newest",r="",s="",i={}){const n={page:e,limit:t,sortBy:a};r&&(n.category=r),s&&(n.tag=s);const o=`discussions_${e}_${t}_${a}_${r}_${s}`;try{return await St({method:"get",url:"/community/discussions",params:n,cacheKey:o,staleWhileRevalidate:!0,signal:i.signal||null,forceRefresh:!!i.forceRefresh,timeoutOverride:i.timeoutOverride||null})}catch(c){throw c}},async getDiscussion(e,t={}){const a="discussion_"+e;try{return await St({method:"get",url:"/community/discussions/"+e,cacheKey:a,staleWhileRevalidate:!0,signal:t.signal||null,forceRefresh:!!t.forceRefresh,timeoutOverride:t.timeoutOverride||null})}catch(r){throw r}},async createDiscussion(e,t={}){localStorage.getItem("accessToken");const a=await St({method:"post",url:"/community/discussions",data:e,cacheKey:null,signal:t.signal||null,timeoutOverride:t.timeoutOverride||null});return vt(),a},async updateDiscussion(e,t,a={}){localStorage.getItem("accessToken");const r=await St({method:"put",url:"/community/discussions/"+e,data:t,signal:a.signal||null,timeoutOverride:a.timeoutOverride||null});return vt(),r},async deleteDiscussion(e,t={}){localStorage.getItem("accessToken");const a=await St({method:"delete",url:"/community/discussions/"+e,signal:t.signal||null,timeoutOverride:t.timeoutOverride||null});return vt(),a},async addReply(e,t,a={}){if(!localStorage.getItem("accessToken"))throw Error("Authentication required");const r=await St({method:"post",url:`/community/discussions/${e}/replies`,data:{content:t.content,parentReplyId:t.parentReplyId},signal:a.signal||null,timeoutOverride:a.timeoutOverride||null});return vt(),r},async updateReply(e,t,a,r={}){const s=await St({method:"put",url:`/community/discussions/${e}/replies/${t}`,data:a,signal:r.signal||null,timeoutOverride:r.timeoutOverride||null});return vt(),s},async deleteReply(e,t,a={}){const r=await St({method:"delete",url:`/community/discussions/${e}/replies/${t}`,signal:a.signal||null,timeoutOverride:a.timeoutOverride||null});return vt(),r},async likeDiscussion(e,t={}){if(!localStorage.getItem("accessToken"))throw Error("Authentication required");const a=await St({method:"post",url:`/community/discussions/${e}/like`,data:{},signal:t.signal||null,timeoutOverride:t.timeoutOverride||null});return vt(),a},async likeReply(e,t,a={}){if(!localStorage.getItem("accessToken"))throw Error("Authentication required");const r=await St({method:"post",url:`/community/discussions/${e}/replies/${t}/like`,data:{},signal:a.signal||null,timeoutOverride:a.timeoutOverride||null});return vt(),r},async searchDiscussions(e,t={}){const a="search_"+e;return await St({method:"get",url:"/community/search",params:{q:e},cacheKey:a,staleWhileRevalidate:!0,signal:t.signal||null,forceRefresh:!!t.forceRefresh,timeoutOverride:t.timeoutOverride||null})},getCategories:async(e={})=>await St({method:"get",url:"/community/categories",cacheKey:"categories",staleWhileRevalidate:!0,signal:e.signal||null,forceRefresh:!!e.forceRefresh,timeoutOverride:e.timeoutOverride||null}),getTopTags:async(e={})=>await St({method:"get",url:"/community/tags",cacheKey:"tags",staleWhileRevalidate:!0,signal:e.signal||null,forceRefresh:!!e.forceRefresh,timeoutOverride:e.timeoutOverride||null}),getTrendingTopics:async(e={})=>await St({method:"get",url:"/community/trending",cacheKey:"trending",staleWhileRevalidate:!0,signal:e.signal||null,forceRefresh:!!e.forceRefresh,timeoutOverride:e.timeoutOverride||null}),getCommunityStats:async(e={})=>await St({method:"get",url:"/community/stats",cacheKey:"stats",staleWhileRevalidate:!0,signal:e.signal||null,forceRefresh:!!e.forceRefresh,timeoutOverride:e.timeoutOverride||null}),clearCache:vt,getCachedData:function(e){const t=yt.get(e);return t&&Date.now()-t.timestamp<gt?(yt.delete(e),yt.set(e,t),ft.hits++,t.data):(t&&(yt.delete(e),ft.evictions++),ft.misses++,null)},setCachedData:wt,getCacheStats:function(){return{...ft,size:yt.size}}},Mt=new class{constructor(){this.listeners=new Map,this.isListening=!1,this.allowedDomains=["111movies.com","player.videasy.net","vidjoy.pro","vidfast.pro","rivestream.net","cinemaos.tech"]}startListening(){this.isListening||(this.isListening=!0,window.addEventListener("message",this.handleMessage.bind(this)))}stopListening(){this.isListening&&(this.isListening=!1,window.removeEventListener("message",this.handleMessage.bind(this)))}handleMessage(e){const t=e.origin||"";if(this.allowedDomains.some((e=>t.includes(e))))try{const t=e.data,a=this.parseProgressData(t);a&&this.notifyListeners(a)}catch(a){}}parseProgressData(e){if(!e||"object"!=typeof e)return null;let t=null;if("timeupdate"===e.event&&e.data?t=e.data:void 0!==e.currentTime||void 0!==e.progress?t=e:"progress"!==e.type&&"timeUpdate"!==e.type||(t=e),!t)return null;if(void 0!==t.currentTime&&void 0!==t.duration)return{currentTime:t.currentTime,duration:t.duration,progress:t.currentTime/t.duration*100,playing:void 0===t.playing||t.playing};if(void 0!==t.progress)return{currentTime:t.currentTime||0,duration:t.duration||0,progress:t.progress,playing:void 0===t.playing||t.playing};if(void 0!==t.time){const e=t.duration||7200;return{currentTime:t.time,duration:e,progress:t.time/e*100,playing:void 0===t.playing||t.playing}}return null}addListener(e,t){this.listeners.set(e,t)}removeListener(e){this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(((t,a)=>{try{t(e)}catch(r){}}))}extractTimestampFromUrl(e){if(!e)return null;try{const t=new URL(e),a=["t","time","start","position","seek","timestamp"];for(const e of a){const a=t.searchParams.get(e);if(a){const t=parseFloat(a);if(!isNaN(t)&&t>0)return{timestamp:t,param:e,progress:this.estimateProgressFromTimestamp(t)}}}}catch(t){}return null}estimateProgressFromTimestamp(e){return Math.min(e/7200*100,100)}checkLocalStorageForProgress(){try{const t=Object.keys(localStorage).filter((e=>e.includes("progress")||e.includes("time")||e.includes("position")||e.includes("watch")||e.includes("video")));for(const a of t)try{const e=localStorage.getItem(a);if(e){const t=JSON.parse(e);if(t&&(t.currentTime||t.time||t.position)){const e=t.currentTime||t.time||t.position,r=t.duration||7200;return{currentTime:e,duration:r,progress:e/r*100,source:"localStorage",key:a}}}}catch(e){const t=parseFloat(value);if(!isNaN(t)&&t>0){const e=7200;return{currentTime:t,duration:e,progress:t/e*100,source:"localStorage",key:a}}}}catch(t){}return null}requestProgressFromIframe(e){if(e&&e.contentWindow)try{[{type:"GET_PROGRESS",action:"getProgress"},{type:"PROGRESS_REQUEST",action:"getCurrentTime"},{type:"TIME_REQUEST",action:"getTime"},{action:"getProgress"},{action:"getCurrentTime"},{action:"getTime"}].forEach((t=>{try{e.contentWindow.postMessage(t,"*")}catch(a){}}))}catch(t){}}startUrlMonitoring(e,t,a=5e3){if(!e)return null;const r=()=>{try{const a=e.src;if(a){const e=this.extractTimestampFromUrl(a);e&&t(e)}}catch(a){}};return r(),setInterval(r,a)}stopUrlMonitoring(e){e&&clearInterval(e)}getStreamingServiceFromUrl(e){if(!e)return null;for(const t of this.allowedDomains)if(e.includes(t))return{domain:t,name:this.getServiceName(t)};return null}getServiceName(e){return{"111movies.com":"111Movies","player.videasy.net":"Videasy","vidjoy.pro":"VidJoy","vidfast.pro":"VidFast","rivestream.net":"RiveStream","cinemaos.tech":"Cinemaos"}[e]||e}cleanup(){this.stopListening(),this.listeners.clear()}};"undefined"!=typeof window&&Mt.startListening();const Ct=()=>{try{return r("/jikan")}catch{return"/api/jikan"}},Pt=(e={})=>{const t=new URLSearchParams;Object.entries(e).forEach((([e,a])=>{null!=a&&""!==a&&t.set(e,a+"")}));const a=t.toString();return a?"?"+a:""},Et=new Map,Rt=new Map,It=e=>new Promise((t=>setTimeout(t,e)));let At=0;const Dt=async(e,t={},{ttlMs:a=0}={})=>{const r="GET "+e,s="undefined"!=typeof performance&&performance.now?performance.now():Date.now();if(a>0){const e=Et.get(r);if(e&&e.expiry>s)return e.data;const t=Rt.get(r);if(t)return t}const i=(async()=>{try{let a=0;for(;;){const r=Date.now()-At;350>r&&await It(350-r);const s=await fetch(e,{...t,headers:{accept:"application/json",...t.headers||{}}});if(At=Date.now(),s.ok)return s.json();const i=s.status,n=await s.text().catch((()=>""));if(429!==i&&503!==i||a>=3)throw Error(`Jikan ${i}: ${n||s.statusText}`);{const e=s.headers.get("retry-after"),t=e?Math.min(5e3,1e3*(parseFloat(e)||1)):500*Math.pow(2,a);a+=1,await It(t)}}}finally{Rt.delete(r)}})();Rt.set(r,i);const n=await i;return a>0&&Et.set(r,{expiry:s+a,data:n}),n},$t={searchManga:(e={})=>{const{q:t,page:a=1,limit:r=20,type:s,status:i,order_by:n="popularity",sort:o="desc",sfw:c=!0}=e,l=Pt({q:t,page:a,limit:r,type:s,status:i,order_by:n,sort:o,sfw:c});return Dt(`${Ct()}/manga${l}`,{},{ttlMs:3e4})},getMangaById:e=>Dt(`${Ct()}/manga/${encodeURIComponent(e)}`,{},{ttlMs:864e5}),getMangaFullById:e=>Dt(`${Ct()}/manga/${encodeURIComponent(e)}/full`,{},{ttlMs:864e5}),getTopManga:(e={})=>{const{page:t=1,type:a,filter:r,limit:s=20}=e,i=Pt({page:t,type:a,filter:r,limit:s});return Dt(`${Ct()}/top/manga${i}`,{},{ttlMs:3e5})}},xt=()=>{try{return r("/mangadex")}catch{return"/api/mangadex"}},Lt=(e={})=>{const t=new URLSearchParams;Object.entries(e).forEach((([e,a])=>{if(null!=a&&""!==a)if(Array.isArray(a)){const r=e.endsWith("[]")?e:e+"[]";a.forEach((e=>t.append(r,e+"")))}else t.set(e,a+"")}));const a=t.toString();return a?"?"+a:""},jt=e=>new Promise((t=>setTimeout(t,e))),Ot=async e=>{const t=await fetch(e,{headers:{accept:"application/json"}});if(!t.ok){const e=await t.text().catch((()=>""));throw Error(`MangaDex ${t.status}: ${e||t.statusText}`)}return t.json()},Nt={searchManga:(e={})=>{const{title:t,limit:a=20,offset:r=0,order:s={relevance:"desc"}}=e,i=Object.entries(s).map((([e,t])=>[`order[${e}]`,t])).reduce(((e,[t,a])=>({...e,[t]:a})),{}),n=Lt({title:t,limit:a,offset:r,...i});return Ot(`${xt()}/manga${n}`)},getManga:e=>Ot(`${xt()}/manga/${encodeURIComponent(e)}`),getMangaFeed:(e,t={})=>{const{limit:a=100,translatedLanguage:r,order:s={chapter:"desc"},offset:i=0}=t,n=Object.entries(s).map((([e,t])=>[`order[${e}]`,t])).reduce(((e,[t,a])=>({...e,[t]:a})),{}),o=Lt({limit:a,offset:i,...r?{translatedLanguage:r}:{},...n});return Ot(`${xt()}/manga/${encodeURIComponent(e)}/feed${o}`)},getChapter:e=>Ot(`${xt()}/chapter/${encodeURIComponent(e)}`),getAtHomeServer:async(e,t={})=>{const a=async t=>{const a=Lt({forcePort443:t?"true":void 0});return Ot(`${xt()}/at-home/server/${encodeURIComponent(e)}${a}`)};for(const s of[!0,!1])try{return await a(s)}catch(r){if((r.message||"").includes("MangaDex 5")){await jt(400);try{return await a(s)}catch{}}}return a(!1)},getAggregate:(e,t={})=>{const{translatedLanguage:a}=t,r=Lt({...a?{translatedLanguage:a}:{}});return Ot(`${xt()}/manga/${encodeURIComponent(e)}/aggregate${r}`)}},Ht=new class{constructor(){this.lastCheck=null,this.cacheDuration=3e4,this.isChecking=!1,this.checkQueue=[]}async checkHealth(e=!1){if(!e&&this.lastCheck&&Date.now()-this.lastCheck.timestamp<this.cacheDuration)return this.lastCheck.result;if(this.isChecking)return new Promise((e=>{this.checkQueue.push(e)}));this.isChecking=!0;try{const e=new AbortController,a=setTimeout((()=>e.abort()),1e4);try{const t=await fetch("/api/health",{method:"GET",cache:"no-cache",signal:e.signal});clearTimeout(a);const r={status:t.ok?"online":"error",httpStatus:t.status,timestamp:Date.now(),responseTime:Date.now()-(this.lastCheck?.timestamp||Date.now())};return this.lastCheck={result:r,timestamp:Date.now()},this.checkQueue.forEach((e=>e(r))),this.checkQueue=[],r}catch(t){clearTimeout(a);const e={status:"error",error:t.message,timestamp:Date.now()};return this.lastCheck={result:e,timestamp:Date.now()},this.checkQueue.forEach((t=>t(e))),this.checkQueue=[],e}}finally{this.isChecking=!1}}getCachedHealth(){return this.lastCheck&&Date.now()-this.lastCheck.timestamp<this.cacheDuration?this.lastCheck.result:null}async forceCheck(){return this.checkHealth(!0)}},Ft=new class{constructor(){this.animationQueue=new Map,this.activeAnimations=new Set,this.rafIds=new Set,this.animationPresets=this.createAnimationPresets(),this.performanceMode=this.detectPerformanceMode(),this.isInitialized=!1,this.init()}init(){"undefined"!=typeof window&&(this.isInitialized=!0,queueMicrotask((()=>{try{this.setupPerformanceMonitoring()}catch(e){}try{this.setupAnimationOptimizations()}catch(e){}})))}detectPerformanceMode(){if("undefined"==typeof window)return"high";const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=navigator.deviceMemory||4,a=navigator.hardwareConcurrency||4;return 8>t||8>a||e&&"4g"!==e.effectiveType?4>t||4>a?"low":"medium":"high"}createAnimationPresets(){return{modal:{enter:{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},transition:{duration:.3,ease:"easeOut"}},exit:{animate:{opacity:0,scale:.95,y:20},transition:{duration:.2,ease:"easeIn"}}},slide:{enter:{initial:{opacity:0,x:"100%"},animate:{opacity:1,x:0},transition:{duration:.4,ease:"easeOut"}},exit:{animate:{opacity:0,x:"100%"},transition:{duration:.3,ease:"easeIn"}}},fade:{enter:{initial:{opacity:0},animate:{opacity:1},transition:{duration:.2,ease:"easeOut"}},exit:{animate:{opacity:0},transition:{duration:.15,ease:"easeIn"}}},scale:{enter:{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{duration:.25,ease:"backOut"}},exit:{animate:{opacity:0,scale:.8},transition:{duration:.2,ease:"backIn"}}},toast:{enter:{initial:{opacity:0,y:-50,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"}},exit:{animate:{opacity:0,y:-50,scale:.9},transition:{duration:.2,ease:"easeIn"}}},critical:{enter:{initial:{opacity:0,scale:.98},animate:{opacity:1,scale:1},transition:{duration:.15,ease:"easeOut"}},exit:{animate:{opacity:0,scale:.98},transition:{duration:.1,ease:"easeIn"}}}}}setupPerformanceMonitoring(){"low"===this.performanceMode&&(this.animationPresets=this.optimizeForLowPerformance(this.animationPresets))}optimizeForLowPerformance(e){const t={...e};return Object.keys(t).forEach((e=>{const a=t[e];a.enter?.transition?.duration&&(a.enter.transition.duration*=.7),a.exit?.transition?.duration&&(a.exit.transition.duration*=.7),a.enter?.transition?.ease&&(a.enter.transition.ease="easeOut"),a.exit?.transition?.ease&&(a.exit.transition.ease="easeIn")})),t}setupAnimationOptimizations(){if("undefined"!=typeof window){const e=document.createElement("style");e.textContent="\n        /* .portal-animated kept for semantic purposes; will-change is applied dynamically per-portal to\n           avoid forcing multiple composited layers across the page. */\n        .portal-animated {\n          transform: translateZ(0);\n        }\n        .portal-animated * {\n          will-change: auto;\n        }\n      ",document.head.appendChild(e)}}getAnimationPreset(e,t="normal"){let a=this.animationPresets[e]||this.animationPresets.modal;return"critical"===t?a=this.animationPresets.critical:"low"===t&&"toast"!==e&&(a=this.animationPresets.fade),a}createCoordinatedAnimation(e,t="modal"){const a=[];return e.forEach(((e,r)=>{const s={...this.getAnimationPreset(t,e.priority),delay:50*r,portalId:e.id};a.push(s)})),a}queueAnimation(e,t){this.animationQueue.has(e)||this.animationQueue.set(e,[]),this.animationQueue.get(e).push(t),this.processAnimationQueue(e)}async processAnimationQueue(e){const t=this.animationQueue.get(e);if(!t||0===t.length)return;const a=t.shift();this.activeAnimations.add(e);try{await this.executeAnimation(e,a)}catch(r){}finally{this.activeAnimations.delete(e),t.length>0&&setTimeout((()=>this.processAnimationQueue(e)),10)}}async executeAnimation(e,t){return new Promise((a=>{const r=document.getElementById(e);r?(r.classList.add("portal-animated"),"enter"===t.type?this.animateEnter(r,t,a):"exit"===t.type?this.animateExit(r,t,a):a()):a()}))}animateEnter(e,t,a){const{initial:r,animate:i,transition:n}=t;if(!t||"object"!=typeof t)return void(a&&a());try{const t=this.styleFromMotion(r);Object.assign(e.style,t)}catch(c){}const o=s((()=>{try{o&&this.rafIds&&this.rafIds.delete(o)}catch(t){}try{const t=this.styleFromMotion(i);Object.assign(e.style,t)}catch(c){}setTimeout((()=>{e.classList.remove("portal-animated"),a&&a()}),1e3*(n?.duration||.3))}));if(o)try{this.rafIds.add(o)}catch(l){}if(!o){try{const t=this.styleFromMotion(i);Object.assign(e.style,t)}catch(l){}setTimeout((()=>{e.classList.remove("portal-animated"),a&&a()}),1e3*(n?.duration||.3))}}animateExit(e,t,a){const{animate:r,transition:s}=t;if(t&&"object"==typeof t){try{const t=this.styleFromMotion(r);Object.assign(e.style,t)}catch(i){}setTimeout((()=>{e.classList.remove("portal-animated"),a&&a()}),1e3*(s?.duration||.2))}else a&&a()}styleFromMotion(e){const t={};return e&&"object"==typeof e?(void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.scale&&(t.transform=`scale(${e.scale})`),void 0!==e.x&&(t.transform=`translateX(${e.x})`),void 0!==e.y&&(t.transform=`translateY(${e.y})`),t):t}createStackAnimation(e){const t=[];return e.forEach(((a,r)=>{const s=e.length-r-1,i=1-.05*s,n=1-.1*s;t.push({portalId:a.id,type:"stack",scale:i,opacity:n,zIndex:a.zIndex})})),t}animateStackTransition(e){this.createStackAnimation(e).forEach((e=>{const t=document.getElementById(e.portalId);t&&(t.style.transform=`scale(${e.scale})`,t.style.opacity=e.opacity,t.style.zIndex=e.zIndex)}))}getPerformanceMetrics(){return{activeAnimations:this.activeAnimations.size,queuedAnimations:Array.from(this.animationQueue.values()).reduce(((e,t)=>e+t.length),0),performanceMode:this.performanceMode,isInitialized:this.isInitialized}}cleanup(){if(this.animationQueue.clear(),this.activeAnimations.clear(),this.rafIds&&this.rafIds.size){for(const t of Array.from(this.rafIds))try{i(t)}catch(e){}this.rafIds.clear()}}},Ut=Object.freeze(Object.defineProperty({__proto__:null,default:Ft},Symbol.toStringTag,{value:"Module"})),zt=new class{constructor(){this.storageKey="streamr_portal_states",this.historyKey="streamr_portal_history",this.maxHistorySize=50,this.maxStateAge=864e5,this.isInitialized=!1,this.stateCache=new Map,this.history=[],this.init()}init(){"undefined"!=typeof window&&(this.isInitialized=!0,this.loadPersistedState(),this.loadHistory(),this.setupStateCleanup())}savePortalState(e,t){if(!this.isInitialized)return;const a={id:e,state:{...t},timestamp:Date.now(),version:"1.0"};this.stateCache.set(e,a),this.persistToStorage()}loadPortalState(e){if(!this.isInitialized)return null;const t=this.stateCache.get(e);return t?this.isStateExpired(t)?(this.stateCache.delete(e),null):t.state:null}deletePortalState(e){this.isInitialized&&(this.stateCache.delete(e),this.persistToStorage())}addToHistory(e,t,a={}){if(!this.isInitialized)return;const r={id:e,action:t,data:a,timestamp:Date.now()};this.history.unshift(r),this.history.length>this.maxHistorySize&&(this.history=this.history.slice(0,this.maxHistorySize)),this.persistHistory()}getHistory(e=null,t=10){if(!this.isInitialized)return[];let a=this.history;return e&&(a=this.history.filter((t=>t.id===e))),a.slice(0,t)}clearHistory(){this.history=[],this.persistHistory()}createSnapshot(e){if(!this.isInitialized)return null;const t=this.stateCache.get(e);if(!t)return null;const a={id:e,state:{...t.state},timestamp:Date.now(),snapshotId:`snapshot_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},r="snapshot_"+e;return this.stateCache.set(r,a),this.addToHistory(e,"snapshot_created",{snapshotId:a.snapshotId}),a.snapshotId}rollbackToSnapshot(e,t){if(!this.isInitialized)return!1;const a="snapshot_"+e,r=this.stateCache.get(a);return!(!r||r.snapshotId!==t||(this.savePortalState(e,r.state),this.addToHistory(e,"rollback",{snapshotId:t}),0))}exportPortalStates(){if(!this.isInitialized)return null;const e={states:Array.from(this.stateCache.entries()),history:this.history,exportTimestamp:Date.now(),version:"1.0"};return JSON.stringify(e)}importPortalStates(e){if(!this.isInitialized)return!1;try{const t=JSON.parse(e);return"1.0"===t.version&&(t.states&&(this.stateCache.clear(),t.states.forEach((([e,t])=>{this.stateCache.set(e,t)}))),t.history&&(this.history=t.history),this.persistToStorage(),this.persistHistory(),!0)}catch(t){return!1}}persistToStorage(){if("undefined"!=typeof window&&localStorage)try{const e=Array.from(this.stateCache.entries());localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(e){}}loadPersistedState(){if("undefined"!=typeof window&&localStorage)try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);this.stateCache=new Map(t),this.cleanupExpiredStates()}}catch(e){}}persistHistory(){if("undefined"!=typeof window&&localStorage)try{localStorage.setItem(this.historyKey,JSON.stringify(this.history))}catch(e){}}loadHistory(){if("undefined"!=typeof window&&localStorage)try{const e=localStorage.getItem(this.historyKey);e&&(this.history=JSON.parse(e),this.cleanupOldHistory())}catch(e){}}isStateExpired(e){return Date.now()-e.timestamp>this.maxStateAge}cleanupExpiredStates(){let e=0;for(const[t,a]of this.stateCache.entries())this.isStateExpired(a)&&(this.stateCache.delete(t),e++);e>0&&this.persistToStorage()}cleanupOldHistory(){const e=Date.now()-this.maxStateAge,t=this.history.length;this.history=this.history.filter((t=>t.timestamp>e)),this.history.length!==t&&this.persistHistory()}setupStateCleanup(){this.cleanupInterval=setInterval((()=>{this.cleanupExpiredStates(),this.cleanupOldHistory()}),36e5)}getStateMetrics(){return{totalStates:this.stateCache.size,historyEntries:this.history.length,oldestState:this.getOldestStateAge(),newestState:this.getNewestStateAge(),isInitialized:this.isInitialized}}getOldestStateAge(){if(0===this.stateCache.size)return null;const e=Math.min(...Array.from(this.stateCache.values()).map((e=>e.timestamp)));return Date.now()-e}getNewestStateAge(){if(0===this.stateCache.size)return null;const e=Math.max(...Array.from(this.stateCache.values()).map((e=>e.timestamp)));return Date.now()-e}cleanup(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.stateCache.clear(),this.history=[]}},Bt=Object.freeze(Object.defineProperty({__proto__:null,default:zt},Symbol.toStringTag,{value:"Module"})),qt=new class{constructor(){this.metrics={portals:new Map,events:[],errors:[],performance:{creationTimes:[],destructionTimes:[],renderTimes:[],memoryUsage:[],fps:[]},userInteractions:{clicks:0,keyPresses:0,focusEvents:0,escapePresses:0}},this.isInitialized=!1,this.sessionId=this.generateSessionId(),this.startTime=Date.now(),this.reportingInterval=null,this.memoryMonitorInterval=null,this.maxEvents=1e3,this.maxErrors=100,this.rafIds=new Set,this.init()}init(){"undefined"!=typeof window&&(this.isInitialized=!0,queueMicrotask((()=>{try{this.setupPerformanceMonitoring()}catch(e){}try{this._targetFps=30,this._minFrameMs=1e3/this._targetFps,this._lastFpsRender=performance.now(),this._visibilityHandler=this._visibilityHandler||(()=>{if("hidden"===document.visibilityState){if(this.fpsAnimationId){try{i(this.fpsAnimationId)}catch(e){}this.fpsAnimationId=null}}else if(this._lastFpsRender=performance.now(),!this.fpsAnimationId){const t=s(this.measureFPS);this.fpsAnimationId=t;try{t&&this.rafIds.add(t)}catch(e){}}}),document.addEventListener("visibilitychange",this._visibilityHandler)}catch(e){}try{this.setupEventListeners()}catch(e){}try{this.startReporting()}catch(e){}})))}generateSessionId(){return`portal_session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}trackPortalCreated(e,t){if(!this.isInitialized)return;const a={id:e,config:t,createdAt:Date.now(),events:[],interactions:0,errors:0,isActive:!0};this.metrics.portals.set(e,a),this.trackEvent("portal_created",{portalId:e,config:t})}trackPortalDestroyed(e,t="unknown"){if(!this.isInitialized)return;const a=this.metrics.portals.get(e);a&&(a.destroyedAt=Date.now(),a.lifetime=a.destroyedAt-a.createdAt,a.isActive=!1,a.destroyReason=t,this.trackEvent("portal_destroyed",{portalId:e,lifetime:a.lifetime,reason:t}))}trackPortalEvent(e,t,a={}){if(!this.isInitialized)return;const r=this.metrics.portals.get(e);r&&(r.events.push({type:t,data:a,timestamp:Date.now()}),r.events.length>100&&(r.events=r.events.slice(-100))),this.trackEvent("portal_"+t,{portalId:e,...a})}trackPerformanceMetric(e,t,a=null){if(!this.isInitialized)return;const r={type:e,value:t,portalId:a,timestamp:Date.now()};this.metrics.performance[e]&&(this.metrics.performance[e].push(r),this.metrics.performance[e].length>500&&(this.metrics.performance[e]=this.metrics.performance[e].slice(-500)))}trackPortalCreationTime(e,t,a){const r=a-t;this.trackPerformanceMetric("creationTimes",r,e),r>100&&this.trackEvent("slow_portal_creation",{portalId:e,duration:r})}trackPortalDestructionTime(e,t,a){const r=a-t;this.trackPerformanceMetric("destructionTimes",r,e)}trackPortalRenderTime(e,t,a){const r=a-t;this.trackPerformanceMetric("renderTimes",r,e)}trackUserInteraction(e,t=null,a={}){if(this.isInitialized&&(this.metrics.userInteractions[e]=(this.metrics.userInteractions[e]||0)+1,this.trackEvent("user_interaction",{type:e,portalId:t,...a}),t)){const e=this.metrics.portals.get(t);e&&e.interactions++}}trackClick(e,t,a){this.trackUserInteraction("clicks",e,{element:t?.tagName||"unknown",coordinates:a})}trackKeyPress(e,t,a){this.trackUserInteraction("keyPresses",e,{key:t,element:a?.tagName||"unknown"}),"Escape"===t&&this.trackUserInteraction("escapePresses",e)}trackFocusEvent(e,t){this.trackUserInteraction("focusEvents",e,{element:t?.tagName||"unknown"})}trackError(e,t=null,a={}){if(!this.isInitialized)return;const r={message:e.message||e,stack:e.stack,portalId:t,context:a,timestamp:Date.now(),sessionId:this.sessionId};if(this.metrics.errors.push(r),this.metrics.errors.length>this.maxErrors&&(this.metrics.errors=this.metrics.errors.slice(-this.maxErrors)),t){const e=this.metrics.portals.get(t);e&&e.errors++}this.trackEvent("portal_error",{portalId:t,error:r})}trackEvent(e,t={}){if(!this.isInitialized)return;const a={type:e,data:t,timestamp:Date.now(),sessionId:this.sessionId};this.metrics.events.push(a),this.metrics.events.length>this.maxEvents&&(this.metrics.events=this.metrics.events.slice(-this.maxEvents))}setupPerformanceMonitoring(){if("undefined"==typeof window)return;"memory"in performance&&(this.memoryMonitorInterval=setInterval((()=>{const e=performance.memory;this.trackPerformanceMetric("memoryUsage",{used:e.usedJSHeapSize,total:e.totalJSHeapSize,limit:e.jsHeapSizeLimit})}),3e4));let e=performance.now(),t=0;this.measureFPS=a=>{if(a-this._lastFpsRender<this._minFrameMs)return void(this.fpsAnimationId=s(this.measureFPS));t++;const r=performance.now();if(r-e>=1e3){const a=Math.round(1e3*t/(r-e));this.trackPerformanceMetric("fps",a),t=0,e=r}this._lastFpsRender=a,this.fpsAnimationId=s(this.measureFPS)};const a=s(this.measureFPS);this.fpsAnimationId=a;try{a&&this.rafIds.add(a)}catch(r){}}setupEventListeners(){"undefined"!=typeof window&&(this.clickHandler=e=>{const t=e.target.closest("[data-portal-id]");if(t){const a=t.getAttribute("data-portal-id");this.trackClick(a,e.target,{x:e.clientX,y:e.clientY})}},document.addEventListener("click",this.clickHandler),this.keydownHandler=e=>{const t=document.activeElement,a=t?.closest("[data-portal-id]");if(a){const r=a.getAttribute("data-portal-id");this.trackKeyPress(r,e.key,t)}},document.addEventListener("keydown",this.keydownHandler),this.focusinHandler=e=>{const t=e.target.closest("[data-portal-id]");if(t){const a=t.getAttribute("data-portal-id");this.trackFocusEvent(a,e.target)}},document.addEventListener("focusin",this.focusinHandler))}startReporting(){this.reportingInterval=setInterval((()=>{this.reportMetrics()}),3e5)}reportMetrics(){}getPortalSummary(){const e=[];for(const[t,a]of this.metrics.portals.entries())e.push({id:t,lifetime:a.lifetime||Date.now()-a.createdAt,events:a.events.length,interactions:a.interactions,errors:a.errors,isActive:a.isActive});return e}getPerformanceSummary(){const e={};return Object.keys(this.metrics.performance).forEach((t=>{const a=this.metrics.performance[t];if(a.length>0){const r=a.map((e=>e.value));e[t]={count:r.length,average:r.reduce(((e,t)=>e+t),0)/r.length,min:Math.min(...r),max:Math.max(...r)}}})),e}getSessionMetrics(){const e=Date.now()-this.startTime,t=Array.from(this.metrics.portals.values()).filter((e=>e.isActive)).length;return{sessionId:this.sessionId,duration:e,activePortals:t,totalPortals:this.metrics.portals.size,totalEvents:this.metrics.events.length,totalErrors:this.metrics.errors.length,userInteractions:this.metrics.userInteractions}}exportAnalytics(){return{sessionId:this.sessionId,startTime:this.startTime,metrics:this.metrics,exportedAt:Date.now()}}cleanup(){if(this.reportingInterval&&(clearInterval(this.reportingInterval),this.reportingInterval=null),this.memoryMonitorInterval&&(clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=null),this.fpsAnimationId){try{i(this.fpsAnimationId)}catch(e){}this.fpsAnimationId=null}if(this.rafIds&&this.rafIds.size){for(const t of Array.from(this.rafIds))try{i(t)}catch(e){}this.rafIds.clear()}this.clickHandler&&(document.removeEventListener("click",this.clickHandler),this.clickHandler=null),this.keydownHandler&&(document.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null),this.focusinHandler&&(document.removeEventListener("focusin",this.focusinHandler),this.focusinHandler=null),this.metrics.portals.clear(),this.metrics.events=[],this.metrics.errors=[],this.metrics.performance={creationTimes:[],destructionTimes:[],renderTimes:[],memoryUsage:[]},this.metrics.userInteractions={clicks:0,keyPresses:0,focusEvents:0,escapePresses:0},this.measureFPS=null}},Wt=Object.freeze(Object.defineProperty({__proto__:null,default:qt},Symbol.toStringTag,{value:"Module"})),Vt=new class{constructor(){this.focusHistory=[],this.announcements=[],this.isInitialized=!1,this.reducedMotion=!1,this.highContrast=!1,this.currentFocusTrap=null,this.announcementContainer=null,this.init()}init(){"undefined"!=typeof window&&(this.isInitialized=!0,this.setupAccessibilityFeatures(),this.createAnnouncementContainer(),this.detectUserPreferences())}setupAccessibilityFeatures(){const e=document.createElement("style");e.id="portal-accessibility-styles",e.textContent="\n      /* Screen reader only content */\n      .sr-only {\n        position: absolute;\n        width: 1px;\n        height: 1px;\n        padding: 0;\n        margin: -1px;\n        overflow: hidden;\n        clip: rect(0, 0, 0, 0);\n        white-space: nowrap;\n        border: 0;\n      }\n      \n      /* Focus indicators */\n      .portal-focus-visible {\n        outline: 2px solid #3b82f6;\n        outline-offset: 2px;\n      }\n      \n      /* High contrast mode */\n      @media (prefers-contrast: high) {\n        .portal-high-contrast {\n          border: 2px solid currentColor;\n          background: Canvas;\n          color: CanvasText;\n        }\n      }\n      \n      /* Reduced motion - DISABLED to enable animations on all devices including mobile */\n      /* Animations will work on all devices without reduced motion constraints */\n      \n      /* Portal announcement container */\n      #portal-announcements {\n        position: absolute;\n        left: -10000px;\n        width: 1px;\n        height: 1px;\n        overflow: hidden;\n      }\n    ",document.head.appendChild(e)}createAnnouncementContainer(){this.announcementContainer=document.createElement("div"),this.announcementContainer.id="portal-announcements",this.announcementContainer.setAttribute("aria-live","polite"),this.announcementContainer.setAttribute("aria-atomic","true"),this.announcementContainer.className="sr-only",document.body.appendChild(this.announcementContainer)}detectUserPreferences(){if(this.reducedMotion=!1,window.matchMedia){const e=window.matchMedia("(prefers-contrast: high)");this.highContrast=e.matches,this.highContrastHandler=e=>{this.highContrast=e.matches,this.updateHighContrastStyles()},e.addEventListener("change",this.highContrastHandler),this.mediaQueryListeners={highContrast:{query:e,handler:this.highContrastHandler}}}}saveFocus(){document.activeElement&&document.activeElement!==document.body&&this.focusHistory.push(document.activeElement)}restoreFocus(){if(this.focusHistory.length>0){const e=this.focusHistory.pop();if(e&&document.contains(e))return e.focus(),!0}return!1}setupFocusTrap(e){if(!e)return null;const t=this.getFocusableElements(e);if(0===t.length)return null;const a=t[0],r=t[t.length-1],s=t=>{"Tab"===t.key?t.shiftKey?document.activeElement===a&&(t.preventDefault(),r.focus()):document.activeElement===r&&(t.preventDefault(),a.focus()):"Escape"===t.key&&this.handleEscapeKey(e)};e.addEventListener("keydown",s),setTimeout((()=>a.focus()),100);const i=()=>{e.removeEventListener("keydown",s)};return this.currentFocusTrap={container:e,cleanup:i},i}getFocusableElements(e){return Array.from(e.querySelectorAll('button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), a[href], [tabindex]:not([tabindex="-1"]), [contenteditable="true"]')).filter((e=>{const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility}))}handleEscapeKey(e){const t=e.querySelector("[data-portal-close]");if(t)t.click();else{const t=new CustomEvent("portal-escape",{bubbles:!0,detail:{container:e}});e.dispatchEvent(t)}}announce(e,t="polite"){if(!this.announcementContainer)return;const a=document.createElement("div");a.setAttribute("aria-live",t),a.textContent=e,this.announcementContainer.appendChild(a),setTimeout((()=>{a.parentNode&&a.parentNode.removeChild(a)}),1e3),this.announcements.push({message:e,priority:t,timestamp:Date.now()})}announcePortalOpen(e,t=""){const a=t?t+" dialog opened":"Dialog opened";this.announce(a,"assertive")}announcePortalClose(e,t=""){const a=t?t+" dialog closed":"Dialog closed";this.announce(a,"polite")}announcePortalContent(e,t){this.announce(t,"polite")}setupPortalAttributes(e,t={}){const{role:a="dialog",ariaLabel:r="",ariaDescribedBy:s="",ariaLabelledBy:i="",modal:n=!0}=t;e.setAttribute("role",a),e.setAttribute("aria-modal",n.toString()),e.setAttribute("tabindex","-1"),r&&e.setAttribute("aria-label",r),s&&e.setAttribute("aria-describedby",s),i&&e.setAttribute("aria-labelledby",i),e.setAttribute("data-portal-id",t.portalId||""),e.setAttribute("data-portal-role",a),e.classList.add("portal-accessible"),this.highContrast&&e.classList.add("portal-high-contrast")}setupKeyboardNavigation(e){const t=t=>{switch(t.key){case"ArrowDown":this.navigateToNext(e,"down"),t.preventDefault();break;case"ArrowUp":this.navigateToNext(e,"up"),t.preventDefault();break;case"ArrowLeft":this.navigateToNext(e,"left"),t.preventDefault();break;case"ArrowRight":this.navigateToNext(e,"right"),t.preventDefault();break;case"Home":this.navigateToFirst(e),t.preventDefault();break;case"End":this.navigateToLast(e),t.preventDefault()}};return e.addEventListener("keydown",t),()=>{e.removeEventListener("keydown",t)}}navigateToNext(e,t){const a=this.getFocusableElements(e),r=a.indexOf(document.activeElement);if(-1===r)return;let s;switch(t){case"down":case"right":s=(r+1)%a.length;break;case"up":case"left":s=0===r?a.length-1:r-1}a[s]?.focus()}navigateToFirst(e){const t=this.getFocusableElements(e);t[0]?.focus()}navigateToLast(e){const t=this.getFocusableElements(e);t[t.length-1]?.focus()}updateHighContrastStyles(){document.querySelectorAll(".portal-accessible").forEach((e=>{this.highContrast?e.classList.add("portal-high-contrast"):e.classList.remove("portal-high-contrast")}))}updateReducedMotionStyles(){}validateAccessibility(e){const t=[];return e.getAttribute("role")||t.push("Missing role attribute"),e.getAttribute("aria-label")||e.getAttribute("aria-labelledby")||t.push("Missing aria-label or aria-labelledby"),0===this.getFocusableElements(e).length&&t.push("No focusable elements found"),0===e.querySelectorAll("h1, h2, h3, h4, h5, h6").length&&t.push("No headings found for screen reader navigation"),{isValid:0===t.length,issues:t}}cleanup(){this.currentFocusTrap&&(this.currentFocusTrap.cleanup(),this.currentFocusTrap=null),this.announcementContainer&&this.announcementContainer.parentNode&&(this.announcementContainer.parentNode.removeChild(this.announcementContainer),this.announcementContainer=null),this.mediaQueryListeners&&(Object.values(this.mediaQueryListeners).forEach((({query:e,handler:t})=>{e.removeEventListener("change",t)})),this.mediaQueryListeners=null),this.focusHistory=[],this.announcements=[],this.highContrastHandler=null}},Qt=Object.freeze(Object.defineProperty({__proto__:null,default:Vt},Symbol.toStringTag,{value:"Module"})),Gt=new class{constructor(){this.networkInfo=null,this.currentQuality="auto",this.performanceMetrics={},this.qualityHistory=[],this.isMonitoring=!1}async initialize(){try{"connection"in navigator&&(this.networkInfo=navigator.connection,this.setupNetworkListeners()),"performance"in window&&this.setupPerformanceMonitoring()}catch(e){}}setupNetworkListeners(){this.networkInfo&&this.networkInfo.addEventListener("change",this.handleNetworkChange.bind(this))}setupPerformanceMonitoring(){if("PerformanceObserver"in window)try{new PerformanceObserver((e=>{for(const t of e.getEntries())this.recordPerformanceMetric(t)})).observe({entryTypes:["navigation","resource"]})}catch(e){}}handleNetworkChange(){if(this.networkInfo){const e=this.getOptimalQuality();e!==this.currentQuality&&(this.currentQuality=e,this.emitQualityChange(e))}}getOptimalQuality(){if(!this.networkInfo)return"720p";const{downlink:e,effectiveType:t}=this.networkInfo;return e>25||"4g"===t?"1080p":e>10||"3g"===t?"720p":e>5?"480p":"360p"}getOptimalStreamingUrl(e,t=null){try{const a=((e,t=Ke,a={})=>{if(!e)return null;const{id:r,type:s,season:i,episode:n}=e;return"tv"===s&&i&&n?et(r,i,n,t,a):Xe(r,t,a)})(e,t||this.getBestServiceForNetwork(),this.getAdaptiveOptions());return a}catch(a){return null}}getBestServiceForNetwork(){return this.networkInfo?((e={})=>{const{downlink:t,effectiveType:a}=e;return t>50||"4g"===a&&t>40?"CINEMAOS":t>25||"4g"===a&&t>20?"RIVESTREAM":t>15?"VIDFAST":t>10?"MOVIES111":t>5?"VIDEASY":"VIDJOY"})({downlink:this.networkInfo.downlink,effectiveType:this.networkInfo.effectiveType}):"MOVIES111"}getAdaptiveOptions(){return this.networkInfo?((e={})=>{const{downlink:t}=e;return t>25?{quality:"1080p",preload:"auto",adaptive:!0,buffer:"high"}:t>10?{quality:"720p",preload:"metadata",adaptive:!0,buffer:"medium"}:{quality:"480p",preload:"none",adaptive:!0,buffer:"low"}})({downlink:this.networkInfo.downlink}):{quality:"720p",preload:"metadata",adaptive:!0,buffer:"medium"}}recordPerformanceMetric(e){const t={name:e.name,type:e.entryType,duration:e.duration,timestamp:Date.now()};this.performanceMetrics[e.name]=t;const a=Object.keys(this.performanceMetrics);a.length>100&&delete this.performanceMetrics[a[0]]}getPerformanceAnalytics(){const e=Object.values(this.performanceMetrics);if(0===e.length)return null;const t=e.reduce(((e,t)=>e+t.duration),0)/e.length,a=e.reduce(((e,t)=>t.duration>e.duration?t:e),e[0]),r=e.reduce(((e,t)=>t.duration<e.duration?t:e),e[0]);return{totalMetrics:e.length,averageDuration:t,slowest:a,fastest:r,networkInfo:this.networkInfo?{downlink:this.networkInfo.downlink,effectiveType:this.networkInfo.effectiveType,connectionType:this.networkInfo.connectionType}:null}}emitQualityChange(e){const t=new CustomEvent("streamingQualityChange",{detail:{quality:e,networkInfo:this.networkInfo,timestamp:Date.now()}});window.dispatchEvent(t)}getNetworkStatus(){if(!this.networkInfo)return"unknown";const{downlink:e}=this.networkInfo;return e>25?"excellent":e>15?"good":e>8?"fair":e>3?"poor":"very-poor"}getRecommendedQuality(){switch(this.getNetworkStatus()){case"excellent":return"1080p";case"good":default:return"720p";case"fair":return"480p";case"poor":return"360p";case"very-poor":return"240p"}}},Jt=()=>Gt.initialize(),Yt={28:"Action",12:"Adventure",16:"Animation",35:"Comedy",80:"Crime",99:"Documentary",18:"Drama",10751:"Family",14:"Fantasy",36:"History",27:"Horror",10402:"Music",9648:"Mystery",10749:"Romance",878:"Science Fiction",10770:"TV Movie",53:"Thriller",10752:"War",37:"Western",10759:"Action & Adventure",10762:"Kids",10763:"News",10764:"Reality",10765:"Sci-Fi & Fantasy",10766:"Soap",10767:"Talk",10768:"War & Politics"},Kt=new class{constructor(){this.cache=l,this.relevanceWeights={genre:.22,cast:.16,crew:.1,franchise:.12,language:.15,region:.15,year:.06,rating:.05,popularity:.04,runtime:.02,budget:.02,productionCompany:.01},this.minRelevanceScore=.2,this.userProfiles=new Map,this.contentProfiles=new Map,this.interactionMatrix=new Map,this.userCulturalPreferences=new Map,this.regionalContentBoost=new Map,this.languageContentBoost=new Map,this.maxCacheSize=1e3,this.lastCleanup=Date.now(),this.cleanupInterval=3e5,this.culturalContextWeights={"north-america":{language:.2,region:.18,genre:.2},europe:{language:.18,region:.2,genre:.18},asia:{language:.25,region:.22,genre:.15},"latin-america":{language:.22,region:.2,genre:.16},"middle-east":{language:.2,region:.22,genre:.16},africa:{language:.18,region:.2,genre:.18},oceania:{language:.16,region:.18,genre:.2}},this.recommendationStrategies={collaborative:this.collaborativeFiltering.bind(this),contentBased:this.contentBasedFiltering.bind(this),hybrid:this.hybridRecommendation.bind(this),contextual:this.contextualRecommendation.bind(this),deepLearning:this.deepLearningRecommendation.bind(this),reinforcement:this.reinforcementLearningRecommendation.bind(this),cultural:this.culturalRecommendation.bind(this)}}withTimeout(e,{ms:t=1500,signal:a}={}){return t?new Promise((r=>{let s=!1;const i=setTimeout((()=>{s||r([])}),t);e.then((e=>{s||(s=!0,clearTimeout(i),r(e))})).catch((e=>{s||(s=!0,clearTimeout(i),r([]))})),a&&a.addEventListener("abort",(()=>{s||(s=!0,clearTimeout(i),r([]))}),{once:!0})})):e}async mapWithConcurrency(e,t,a){const r=Array(e.length);let s=0;const i=Array.from({length:Math.min(t,e.length)},(async()=>{for(;s<e.length;){const t=s++;r[t]=await a(e[t],t)}}));return await Promise.all(i),r}calculateSimilarityScore(e,t,a=null){this.performMemoryCleanup();let r=0;const s=a?.region||"global",i=a?.preferredLanguage||"en",n=this.culturalContextWeights[s]||this.relevanceWeights;if(e.genres&&t.genres&&(r+=this.calculateGenreOverlap(e.genres,t.genres)*n.genre),e.cast&&t.cast&&(r+=this.calculateCastOverlap(e.cast,t.cast)*this.relevanceWeights.cast),e.crew&&t.crew&&(r+=this.calculateCrewOverlap(e.crew,t.crew)*this.relevanceWeights.crew),e.belongs_to_collection&&t.belongs_to_collection&&(r+=this.calculateFranchiseSimilarity(e.belongs_to_collection,t.belongs_to_collection)*this.relevanceWeights.franchise),e.original_language&&t.original_language){const a=this.calculateLanguageSimilarity(e.original_language,t.original_language);let o=n.language;e.original_language!==i&&t.original_language!==i||(o*=1.5),o*=1+this.getRegionalLanguageBoost(e.original_language,s),r+=a*o}if(e.production_countries&&t.production_countries){const a=this.calculateRegionSimilarity(e.production_countries,t.production_countries);let i=n.region;(this.isContentFromRegion(e,s)||this.isContentFromRegion(t,s))&&(i*=1.4),i*=1+this.calculateCulturalAffinity(e,t,s),r+=a*i}if(e.year&&t.year){const a=Math.abs(e.year-t.year);r+=Math.max(0,1-a/15)*this.relevanceWeights.year}if(e.vote_average&&t.vote_average){const a=Math.abs(e.vote_average-t.vote_average);r+=Math.max(0,1-a/4)*this.relevanceWeights.rating}if(e.popularity&&t.popularity){const a=Math.abs(e.popularity-t.popularity);r+=Math.max(0,1-a/80)*this.relevanceWeights.popularity}if(e.runtime&&t.runtime){const a=Math.abs(e.runtime-t.runtime);r+=Math.max(0,1-a/30)*this.relevanceWeights.runtime}if(e.budget&&t.budget){const a=Math.abs(e.budget-t.budget);r+=Math.max(0,1-a/5e7)*this.relevanceWeights.budget}return e.production_companies&&t.production_companies&&(r+=this.calculateProductionCompanySimilarity(e.production_companies,t.production_companies)*this.relevanceWeights.productionCompany),void 0!==e.adult&&void 0!==t.adult&&e.adult===t.adult&&(r+=.02),r+=.05*this.calculateCulturalContentSimilarity(e,t,s),Math.min(1,Math.max(0,r))}calculateGenreOverlap(e,t){if(!e||!t)return 0;const a=new Set(e.map((e=>"object"==typeof e?e.id:e))),r=new Set(t.map((e=>"object"==typeof e?e.id:e))),s=new Set([...a].filter((e=>r.has(e)))),i=new Set([...a,...r]);return s.size/i.size}calculateCastOverlap(e,t){if(!e||!t)return 0;const a=new Set(e.slice(0,10).map((e=>e.id))),r=new Set(t.slice(0,10).map((e=>e.id))),s=new Set([...a].filter((e=>r.has(e)))),i=new Set([...a,...r]);return s.size/i.size}calculateCrewOverlap(e,t){if(!e||!t)return 0;const a=e.find((e=>"Director"===e.job))?.id,r=t.find((e=>"Director"===e.job))?.id,s=e.find((e=>"Writer"===e.job))?.id,i=t.find((e=>"Writer"===e.job))?.id;let n=0;return a&&r&&a===r&&(n+=.5),s&&i&&s===i&&(n+=.3),Math.min(1,n)}calculateFranchiseSimilarity(e,t){if(!e||!t)return 0;if(e.id===t.id)return 1;const a=e.name?.toLowerCase()||"",r=t.name?.toLowerCase()||"";return a===r?1:a.includes(r)||r.includes(a)?.8:["marvel","dc","star wars","star trek","james bond","harry potter","lord of the rings","fast and furious","mission impossible","transformers","pirates of the caribbean","indiana jones","terminator","alien","predator","x-men","spider-man","batman","superman","avengers","justice league"].some((e=>a.includes(e)&&r.includes(e)))?.6:0}calculateLanguageSimilarity(e,t){if(!e||!t)return 0;if(e===t)return 1;const a={english:["en","eng"],spanish:["es","spa"],french:["fr","fra"],german:["de","ger"],italian:["it","ita"],portuguese:["pt","por"],russian:["ru","rus"],chinese:["zh","chi","cmn"],japanese:["ja","jpn"],korean:["ko","kor"],hindi:["hi","hin"],arabic:["ar","ara"],turkish:["tr","tur"],dutch:["nl","nld"],swedish:["sv","swe"],norwegian:["no","nor"],danish:["da","dan"],finnish:["fi","fin"],polish:["pl","pol"],czech:["cs","ces"],hungarian:["hu","hun"],romanian:["ro","ron"],bulgarian:["bg","bul"],greek:["el","ell"],hebrew:["he","heb"],thai:["th","tha"],vietnamese:["vi","vie"],indonesian:["id","ind"],malay:["ms","msa"],filipino:["tl","fil"]};let r=null,s=null;for(const[n,o]of Object.entries(a))o.includes(e)&&(r=n),o.includes(t)&&(s=n);if(r&&s&&r===s)return.8;const i={romance:["spanish","french","italian","portuguese","romanian"],germanic:["english","german","dutch","swedish","norwegian","danish"],slavic:["russian","polish","czech","bulgarian"],scandinavian:["swedish","norwegian","danish"],chinese:["chinese"],japanese:["japanese"],korean:["korean"]};for(const[n,o]of Object.entries(i))if(o.includes(r)&&o.includes(s))return.6;return 0}calculateRegionSimilarity(e,t){if(!e||!t)return 0;const a=new Set(e.map((e=>"object"==typeof e?e.iso_3166_1:e))),r=new Set(t.map((e=>"object"==typeof e?e.iso_3166_1:e))),s=new Set([...a].filter((e=>r.has(e))));if(s.size>0)return Math.min(1,s.size/Math.min(a.size,r.size));const i={"north-america":["US","CA","MX"],europe:["GB","FR","DE","IT","ES","NL","SE","NO","DK","FI","PL","CZ","HU","RO","BG","GR"],asia:["JP","KR","CN","IN","TH","VN","ID","MY","PH","SG","TW","HK"],"latin-america":["BR","AR","CL","CO","PE","VE","MX"],"middle-east":["TR","IL","AE","SA","EG","IR"],africa:["ZA","NG","EG","KE","GH"],oceania:["AU","NZ"],"eastern-europe":["RU","UA","BY","MD","GE","AM","AZ"],scandinavia:["SE","NO","DK","FI","IS"],balkans:["RS","HR","SI","BA","ME","MK","AL"],baltic:["EE","LV","LT"],benelux:["BE","NL","LU"],iberia:["ES","PT"],"central-europe":["DE","AT","CH","LI"],mediterranean:["IT","GR","CY","MT"]},n=new Set,o=new Set;for(const l of a)for(const[e,t]of Object.entries(i))if(t.includes(l)){n.add(e);break}for(const l of r)for(const[e,t]of Object.entries(i))if(t.includes(l)){o.add(e);break}if(new Set([...n].filter((e=>o.has(e)))).size>0)return.7;const c={european:["europe","scandinavia","balkans","baltic","benelux","iberia","central-europe","mediterranean","eastern-europe"],asian:["asia"],american:["north-america","latin-america"],african:["africa","middle-east"]};for(const[l,u]of Object.entries(c)){const e=n.size>0&&n.size===new Set([...n].filter((e=>u.includes(e)))).size,t=o.size>0&&o.size===new Set([...o].filter((e=>u.includes(e)))).size;if(e&&t)return.5}return 0}calculateProductionCompanySimilarity(e,t){if(!e||!t)return 0;const a=new Set(e.map((e=>"object"==typeof e?e.id:e))),r=new Set(t.map((e=>"object"==typeof e?e.id:e))),s=new Set([...a].filter((e=>r.has(e)))),i=new Set([...a,...r]);return s.size/i.size}async getEnhancedSimilarContent(e,t="movie",a={}){const{limit:r=200,minScore:s=.2,includeDetails:i=!0,forceRefresh:n=!1,page:o=1,infiniteLoading:c=!1,userId:l=null,useCulturalContext:u=!0,signal:h,fastStart:m=!0}=a;if(h?.aborted)return[];const d=`enhanced_similar_${t}_${e}_${o}_${l||"global"}`;if(!n&&!c){const e=this.cache.get(d);if(e)return e.slice(0,r)}try{if(m&&1===o&&!n){const a=[this.withTimeout(this.fetchRecommendations(e,t,o,{signal:h}),{ms:1200,signal:h}),this.withTimeout(this.fetchSimilar(e,t,o,{signal:h}),{ms:1200,signal:h})],m=await Promise.all(a);let d=[];m.forEach((e=>{Array.isArray(e)&&d.push(...e)})),d=this.removeDuplicates(d,{strategy:"basic"});const p=d.slice(0,Math.min(16,r)).map((e=>({...e,similarityScore:Math.min(1,Math.max(0,.7*(e.vote_average?e.vote_average/10:.2)+(e.popularity?Math.min(e.popularity/100,.3):0)))}))).sort(((e,t)=>(t.similarityScore||0)-(e.similarityScore||0)));return(async()=>{try{const a=await this.getEnhancedSimilarContent(e,t,{limit:r,minScore:s,includeDetails:i,forceRefresh:n,page:o,infiniteLoading:c,userId:l,useCulturalContext:u,fastStart:!1}),h=`enhanced_similar_${t}_${e}_${o}_${l||"global"}`;a&&a.length&&this.cache.set(h,a,{ttl:18e5,priority:"high",namespace:"similar_content"})}catch(a){}})(),p}let a=null;if(u&&l)try{if(h?.aborted)return[];const e=await this.detectUserCulturalPreferences(l),t=Array.from(e.preferredLanguages.entries()).sort(((e,t)=>t[1]-e[1]))[0],r=Array.from(e.preferredRegions.entries()).sort(((e,t)=>t[1]-e[1]))[0];a={preferredLanguage:t?t[0]:"en",region:r?r[0]:"global",preferences:e}}catch(p){}let g=[];const y=[];if(y.push(this.fetchRecommendations(e,t,o,{signal:h}).catch((e=>[]))),y.push(this.fetchSimilar(e,t,o,{signal:h}).catch((e=>[]))),y.push(this.fetchGenreBased(e,t,o,{signal:h}).catch((e=>[]))),a&&a.preferences&&y.push(this.culturalRecommendation(l,t,{limit:Math.ceil(r/4),useUserPreferences:!0,includeRegionalContent:!0,includeLanguageSpecific:!0,signal:h}).catch((e=>[]))),c&&o>1&&(y.push(this.fetchTrendingContent(t,o,{signal:h}).catch((e=>[]))),y.push(this.fetchPopularContent(t,o,{signal:h}).catch((e=>[]))),y.push(this.fetchTopRatedContent(t,o,{signal:h}).catch((e=>[]))),y.push(this.fetchUpcomingContent(t,o,{signal:h}).catch((e=>[]))),y.push(this.fetchNowPlayingContent(t,o,{signal:h}).catch((e=>[])))),h?.aborted)return[];if((await Promise.all(y)).forEach((e=>{Array.isArray(e)&&g.push(...e.filter((e=>e&&e.id)))})),g=this.removeDuplicates(g,{strategy:"smart",keepBestScore:!0,preserveOrder:!1}),0===g.length)return[];const f=c?g:g.slice(0,30);if(h?.aborted)return[];const w=await this.getDetailedContent(f,t,{signal:h});if(h?.aborted)return[];const v=await this.getOriginalContentDetails(e,t,{signal:h}),_=w.map((e=>{let t=0;return t=v?this.calculateSimilarityScore(v,e,a):e.vote_average?e.vote_average/10:.1,{...e,similarityScore:Math.min(1,Math.max(0,t))}}));let b=_.filter((e=>e.similarityScore>=s)).sort(((e,t)=>t.similarityScore-e.similarityScore)).slice(0,c?g.length:r);if(8>b.length&&_.length>0){const e=_.filter((e=>e.similarityScore>=.5*s)).sort(((e,t)=>t.similarityScore-e.similarityScore)).slice(0,8-b.length);b=[...b,...e]}return a&&a.preferences&&(b=this.applyCulturalDiversityBoost(b,a)),c||this.cache.set(d,b,{ttl:18e5,priority:"high",namespace:"similar_content"}),b}catch(p){return"AbortError"===p.name||p.message?.includes("aborted"),[]}}async fetchRecommendations(e,t,a,{signal:r}={}){try{if(r?.aborted)return[];const s=await fetch(`https://api.themoviedb.org/3/${t}/${e}/recommendations?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=${a}`,{signal:r});if(!s.ok){if(429===s.status)return[];if(404===s.status)return[];throw Error(`HTTP ${s.status}: ${s.statusText}`)}return(await s.json()).results||[]}catch(s){return"AbortError"===s.name||s.message?.includes("aborted"),[]}}async fetchSimilar(e,t,a,{signal:r}={}){try{if(r?.aborted)return[];const s=await fetch(`https://api.themoviedb.org/3/${t}/${e}/similar?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=${a}`,{signal:r});if(!s.ok){if(429===s.status)return[];if(404===s.status)return[];throw Error(`HTTP ${s.status}: ${s.statusText}`)}return(await s.json()).results||[]}catch(s){return"AbortError"===s.name||s.message?.includes("aborted"),[]}}async fetchGenreBased(e,t,a,{signal:r}={}){try{const s=await fetch(`https://api.themoviedb.org/3/${t}/${e}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&append_to_response=credits`,{signal:r});if(!s.ok){if(429===s.status)return[];throw Error(`HTTP ${s.status}: ${s.statusText}`)}const i=await s.json();if(!i.genres||0===i.genres.length)return[];const n=i.genres.slice(0,3).map((e=>e.id));await new Promise((e=>setTimeout(e,100)));const o=await fetch(`https://api.themoviedb.org/3/discover/${t}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=vote_average.desc&with_genres=${n.join(",")}&vote_count.gte=100&page=${a}`,{signal:r});if(!o.ok){if(429===o.status)return[];throw Error(`HTTP ${o.status}: ${o.statusText}`)}return(await o.json()).results||[]}catch(s){return[]}}async fetchTrendingContent(e,t,{signal:a}={}){try{const r=await fetch(`https://api.themoviedb.org/3/trending/${e}/week?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=${t}`,{signal:a});if(!r.ok){if(429===r.status)return[];throw Error(`HTTP ${r.status}: ${r.statusText}`)}return(await r.json()).results||[]}catch(r){return[]}}async fetchPopularContent(e,t,{signal:a}={}){try{const r=await fetch(`https://api.themoviedb.org/3/${e}/popular?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=${t}`,{signal:a});if(!r.ok){if(429===r.status)return[];throw Error(`HTTP ${r.status}: ${r.statusText}`)}return(await r.json()).results||[]}catch(r){return[]}}async fetchTopRatedContent(e,t,{signal:a}={}){try{const r=await fetch(`https://api.themoviedb.org/3/${e}/top_rated?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=${t}`,{signal:a});if(!r.ok){if(429===r.status)return[];throw Error(`HTTP ${r.status}: ${r.statusText}`)}return(await r.json()).results||[]}catch(r){return[]}}async fetchUpcomingContent(e,t,{signal:a}={}){try{const r=await fetch(`https://api.themoviedb.org/3/${e}/upcoming?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=${t}`,{signal:a});if(!r.ok){if(429===r.status)return[];throw Error(`HTTP ${r.status}: ${r.statusText}`)}return(await r.json()).results||[]}catch(r){return[]}}async fetchNowPlayingContent(e,t,{signal:a}={}){try{const r=await fetch(`https://api.themoviedb.org/3/${e}/now_playing?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=${t}`,{signal:a});if(!r.ok){if(429===r.status)return[];throw Error(`HTTP ${r.status}: ${r.statusText}`)}return(await r.json()).results||[]}catch(r){return[]}}async getOriginalContentDetails(e,t,{signal:a}={}){try{if(a?.aborted)return null;const r=await fetch(`https://api.themoviedb.org/3/${t}/${e}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&append_to_response=credits`,{signal:a});if(!r.ok){if(404===r.status)return null;throw Error(`HTTP ${r.status}: ${r.statusText}`)}const s=await r.json(),i=s.release_date?new Date(s.release_date).getFullYear():s.first_air_date?new Date(s.first_air_date).getFullYear():null;return{id:s.id,title:s.title||s.name,genres:s.genres||[],year:i,vote_average:s.vote_average,popularity:s.popularity,cast:s.credits?.cast||[],crew:s.credits?.crew||[],overview:s.overview,original_language:s.original_language,belongs_to_collection:s.belongs_to_collection||null,production_countries:s.production_countries||[],production_companies:s.production_companies||[],budget:s.budget,revenue:s.revenue,runtime:s.runtime,spoken_languages:s.spoken_languages||[],status:s.status,adult:s.adult}}catch(r){return"AbortError"===r.name||r.message?.includes("aborted"),null}}async getDetailedContent(e,t,{signal:a}={}){const r=e.slice(0,12);return[...await this.mapWithConcurrency(r,3,(async(e,r)=>{try{if(a?.aborted)return e;r>0&&await new Promise((e=>setTimeout(e,60+Math.floor(40*Math.random()))));const s=await fetch(`https://api.themoviedb.org/3/${t}/${e.id}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&append_to_response=credits`,{signal:a});if(!s.ok){if(429===s.status)return e;if(404===s.status)return e;throw Error(`HTTP ${s.status}: ${s.statusText}`)}const i=await s.json();return{...e,genres:i.genres||[],cast:i.credits?.cast||[],crew:i.credits?.crew||[],year:new Date(e.release_date||e.first_air_date).getFullYear(),vote_average:e.vote_average,popularity:e.popularity,belongs_to_collection:i.belongs_to_collection||null,production_countries:i.production_countries||[],production_companies:i.production_companies||[],budget:i.budget,revenue:i.revenue,runtime:i.runtime,spoken_languages:i.spoken_languages||[],status:i.status,adult:i.adult}}catch(s){return"AbortError"===s.name||s.message?.includes("aborted"),e}})),...e.slice(12).map((e=>({...e,genres:e.genre_ids?e.genre_ids.map((e=>({id:e,name:Yt[e]||`Unknown Genre (${e})`}))):[],cast:[],crew:[],year:new Date(e.release_date||e.first_air_date).getFullYear(),vote_average:e.vote_average,popularity:e.popularity,belongs_to_collection:null,production_countries:[],production_companies:[],budget:null,revenue:null,runtime:null,spoken_languages:[],status:null,adult:null})))]}async getPersonalizedRecommendations(e,t="movie",a={}){const{limit:r=50,strategy:s="hybrid",useContextual:i=!0,useDiversity:n=!0,useFreshness:o=!0}=a;try{let a=[];switch(s){case"collaborative":a=await this.collaborativeFiltering(e,t,{limit:r});break;case"content-based":a=await this.contentBasedFiltering(e,t,{limit:r});break;case"deep-learning":a=await this.deepLearningRecommendation(e,t,{limit:r});break;case"reinforcement":a=await this.reinforcementLearningRecommendation(e,t,{limit:r});break;case"contextual":a=await this.contextualRecommendation(e,t,{limit:r});break;case"mood-based":a=await this.getMoodBasedRecommendations("excited",t,{limit:r});break;default:a=await this.hybridRecommendation(e,t,{limit:r})}return i&&(a=await this.applyContextualBoost(a,e)),n&&(a=this.applyDiversityBoost(a)),o&&(a=this.applyFreshnessBoost(a)),a.slice(0,r)}catch(c){return[]}}async hybridRecommendation(e,t="movie",a={}){const{limit:r=50,collaborativeWeight:s=.4,contentWeight:i=.3,contextualWeight:n=.2,diversityWeight:o=.1}=a;try{const[a,c,l,u]=await Promise.allSettled([this.collaborativeFiltering(e,t,{limit:Math.ceil(1.5*r)}),this.contentBasedFiltering(e,t,{limit:Math.ceil(1.5*r)}),this.contextualRecommendation(e,t,{limit:Math.ceil(1.5*r)}),this.deepLearningRecommendation(e,t,{limit:Math.ceil(1.5*r)})]),h=new Map;if("fulfilled"===a.status)for(const e of a.value){const t=h.get(e.id)||0;h.set(e.id,t+e.score*s)}if("fulfilled"===c.status)for(const e of c.value){const t=h.get(e.id)||0;h.set(e.id,t+e.score*i)}if("fulfilled"===l.status)for(const e of l.value){const t=h.get(e.id)||0;h.set(e.id,t+e.score*n)}if("fulfilled"===u.status)for(const e of u.value){const t=h.get(e.id)||0;h.set(e.id,t+e.score*o)}return Array.from(h.entries()).map((([e,t])=>({id:e,score:t}))).sort(((e,t)=>t.score-e.score)).slice(0,r)}catch(c){return this.getFallbackRecommendations(t,r)}}async collaborativeFiltering(e,t="movie",a={}){const{limit:r=50,useMatrixFactorization:s=!0,useNeuralNetwork:i=!1}=a;try{const a=await this.getUserInteractionHistory(e),n=await this.findSimilarUsers(e,a);if(0===n.length)return this.getFallbackRecommendations(t,r);let o=[];return o=s?await this.matrixFactorizationRecommendation(e,n,t,r):i?await this.neuralNetworkRecommendation(e,a,t,r):await this.traditionalCollaborativeFiltering(e,n,t,r),this.postProcessRecommendations(o,e,t)}catch(n){return this.getFallbackRecommendations(t,r)}}async matrixFactorizationRecommendation(e,t,a,r){await this.buildUserItemMatrix(t);const s=new Map,i=new Map;for(const l of t)s.set(l.id,Array.from({length:20},(()=>Math.random())));const n=new Set;for(const l of t)(await this.getUserRatedItems(l.id)).forEach((e=>n.add(e.id)));for(const l of n)i.set(l,Array.from({length:20},(()=>Math.random())));for(let l=0;50>l;l++)for(const e of t){const t=await this.getUserRatedItems(e.id);for(const a of t){const t=a.rating-this.dotProduct(s.get(e.id),i.get(a.id)),r=s.get(e.id),n=i.get(a.id);for(let e=0;20>e;e++)r[e]+=.01*t*n[e],n[e]+=.01*t*r[e]}}const o=s.get(e)||Array.from({length:20},(()=>Math.random())),c=[];for(const[l,u]of i){const e=this.dotProduct(o,u);c.push({id:l,score:e})}return c.sort(((e,t)=>t.score-e.score)).slice(0,r)}async neuralNetworkRecommendation(e,t,a,r){const s=await this.extractUserFeatures(e,t),i=this.buildRecommendationNetwork(),n=[],o=await this.getCandidateItems(a,1e3);for(const c of o){const e=[...s,...await this.extractItemFeatures(c)],t=this.forwardPass(i,e);n.push({id:c.id,score:t})}return n.sort(((e,t)=>t.score-e.score)).slice(0,r)}buildRecommendationNetwork(){return{layers:[{type:"input",size:50},{type:"hidden",size:100,activation:"relu"},{type:"hidden",size:50,activation:"relu"},{type:"output",size:1,activation:"sigmoid"}],weights:this.initializeWeights([50,100,50,1])}}initializeWeights(e){const t=[];for(let a=0;a<e.length-1;a++){const r=[];for(let t=0;t<e[a+1];t++){const t=[];for(let r=0;r<e[a];r++)t.push(2*Math.random()-1);r.push(t)}t.push(r)}return t}forwardPass(e,t){let a=t;for(let r=0;r<e.weights.length;r++){const t=[];for(let s=0;s<e.weights[r].length;s++){let i=0;for(let t=0;t<e.weights[r][s].length;t++)i+=a[t]*e.weights[r][s][t];t.push(this.activate(i,"relu"))}a=t}return a[0]}activate(e,t){switch(t){case"relu":return Math.max(0,e);case"sigmoid":return 1/(1+Math.exp(-e));default:return e}}async traditionalCollaborativeFiltering(e,t,a,r){const s=new Map;for(const i of t){const e=await this.getUserRatedItems(i.id);for(const t of e){const e=s.get(t.id)||0;s.set(t.id,e+t.rating*i.similarity)}}return Array.from(s.entries()).map((([e,t])=>({id:e,score:t}))).sort(((e,t)=>t.score-e.score)).slice(0,r)}async contentBasedFiltering(e,t="movie",a={}){const{limit:r=50,useTFIDF:s=!0,useWordEmbeddings:i=!1,useDeepFeatures:n=!1}=a;try{const a=await this.buildUserProfile(e),o=await this.getCandidateItems(t,500);let c=[];return c=n?await this.deepFeatureMatching(a,o,r):i?await this.wordEmbeddingRecommendation(a,o,r):s?await this.tfidfRecommendation(a,o,r):await this.traditionalContentBasedFiltering(a,o,r),this.postProcessRecommendations(c,e,t)}catch(o){return this.getFallbackRecommendations(t,r)}}async tfidfRecommendation(e,t,a){const r=this.calculateTFIDF(e),s=[];for(const i of t){const e=this.calculateTFIDF(i),t=this.cosineSimilarity(r,e);s.push({id:i.id,score:t})}return s.sort(((e,t)=>t.score-e.score)).slice(0,a)}calculateTFIDF(e){const t=new Map,a=this.extractWords(e),r=new Map;for(const s of a)r.set(s,(r.get(s)||0)+1);for(const[s,i]of r){const e=i/a.length,r=this.calculateIDF(s);t.set(s,e*r)}return t}calculateIDF(e){return Math.log(100)}cosineSimilarity(e,t){const a=new Set([...e.keys(),...t.keys()]);let r=0,s=0,i=0;for(const n of a){const a=e.get(n)||0,o=t.get(n)||0;r+=a*o,s+=a*a,i+=o*o}return r/(Math.sqrt(s)*Math.sqrt(i))}async traditionalContentBasedFiltering(e,t,a){const r=[];for(const s of t){const t=this.calculateContentSimilarity(e,s);r.push({id:s.id,score:t})}return r.sort(((e,t)=>t.score-e.score)).slice(0,a)}calculateContentSimilarity(e,t){let a=0;return e.genres&&t.genres&&(a+=this.calculateGenreOverlap(e.genres,t.genres)*this.relevanceWeights.genre),e.favoriteActors&&t.cast&&(a+=this.calculateActorOverlap(e.favoriteActors,t.cast)*this.relevanceWeights.cast),e.preferredYears&&t.year&&(a+=this.calculateYearSimilarity(e.preferredYears,t.year)*this.relevanceWeights.year),a}async deepFeatureMatching(e,t,a){const r=await this.getUserEmbedding(e),s=[];for(const i of t){const e=await this.getItemEmbedding(i.id),t=this.cosineSimilarity(r,e);s.push({id:i.id,score:t})}return s.sort(((e,t)=>t.score-e.score)).slice(0,a)}async wordEmbeddingRecommendation(e,t,a){const r=this.getWordEmbedding(e),s=[];for(const i of t){const e=this.getWordEmbedding(i),t=this.cosineSimilarity(r,e);s.push({id:i.id,score:t})}return s.sort(((e,t)=>t.score-e.score)).slice(0,a)}getWordEmbedding(e){const t=Array(50).fill(0),a=this.extractWords(e);for(let r=0;r<Math.min(a.length,50);r++)t[r]=a[r].length/10;return t}extractWords(e){return"string"==typeof e?e.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter((e=>e.length>2)):[]}async getUserPreferences(e){return{genres:[28,12,35],recentWatched:[{id:550,title:"Fight Club",rating:5,timestamp:Date.now()-864e5},{id:13,title:"Forrest Gump",rating:4,timestamp:Date.now()-1728e5},{id:680,title:"Pulp Fiction",rating:5,timestamp:Date.now()-2592e5}],favoriteActors:[62,1100,976],preferredYears:[1990,2010],mood:"excited",watchPatterns:{bingeWatching:.3,genrePreference:.25,timeBased:.2,socialInfluence:.15,moodBased:.1},contentMaturity:"adult",languagePreference:"en",subtitlePreference:!0,qualityPreference:"high"}}async contextualRecommendation(e,t="movie",a={}){const{limit:r=50,timeOfDay:s=this.getTimeOfDay(),dayOfWeek:i=this.getDayOfWeek(),season:n=this.getSeason(),weather:o=await this.getWeather(),mood:c=await this.getUserMood(e)}=a;try{const a={timeOfDay:s,dayOfWeek:i,season:n,weather:o,mood:c},l=await this.getContextualRecommendations(a,t,r);return this.postProcessRecommendations(l,e,t)}catch(l){return this.getFallbackRecommendations(t,r)}}async deepLearningRecommendation(e,t="movie",a={}){const{limit:r=50,useAttention:s=!0,useTransformer:i=!1}=a;try{const a=await this.getUserEmbedding(e),n=await this.getCandidateItems(t,1e3);let o=[];return o=i?await this.transformerRecommendation(a,n,r):s?await this.attentionBasedRecommendation(a,n,r):await this.deepNeuralRecommendation(a,n,r),this.postProcessRecommendations(o,e,t)}catch(n){return this.getFallbackRecommendations(t,r)}}async reinforcementLearningRecommendation(e,t="movie",a={}){const{limit:r=50,explorationRate:s=.1,useMultiArmedBandit:i=!0}=a;try{let a=[];return a=i?await this.multiArmedBanditRecommendation(e,t,r,s):await this.qLearningRecommendation(e,t,r),this.postProcessRecommendations(a,e,t)}catch(n){return this.getFallbackRecommendations(t,r)}}async multiArmedBanditRecommendation(e,t,a,r){const s=await this.getUserProfile(e),i=await this.getCandidateItems(t,200),n=[];for(const o of i){const e=(s.getExpectedReward(o.id)||0)+r*Math.sqrt(Math.log(s.getTotalPlays())/(s.getItemPlays(o.id)||1));n.push({id:o.id,score:e})}return n.sort(((e,t)=>t.score-e.score)).slice(0,a)}async attentionBasedRecommendation(e,t,a){const r=[];for(const s of t){const t=await this.getItemEmbedding(s.id),a=this.calculateAttentionScore(e,t);r.push({id:s.id,score:a})}return r.sort(((e,t)=>t.score-e.score)).slice(0,a)}calculateAttentionScore(e,t){const a=e,r=t,s=t,i=this.dotProduct(a,r)/Math.sqrt(a.length);return this.softmax(i)*this.dotProduct(i,s)}softmax(e){return Math.exp(e)/(1+Math.exp(e))}async applyContextualBoost(e,t){const a=this.getTimeOfDay(),r=(this.getDayOfWeek(),this.getSeason(),await this.getWeather(),await this.getUserMood(t));return e.map((e=>{let t=e.score;return"night"===a&&e.genres?.includes("Horror")&&(t+=.1),"excited"===r&&e.genres?.includes("Action")&&(t+=.1),{...e,score:t}})).sort(((e,t)=>t.score-e.score))}applyDiversityBoost(e){const t=[],a=new Set,r=new Set;for(const s of e){const e=this.getItemDetails(s.id);let i=s.score;e.genres&&!e.genres.some((e=>a.has(e)))&&(i+=.05,e.genres.forEach((e=>a.add(e)))),e.year&&!r.has(e.year)&&(i+=.03,r.add(e.year)),t.push({...s,score:i})}return t.sort(((e,t)=>t.score-e.score))}applyFreshnessBoost(e){const t=(new Date).getFullYear();return e.map((e=>{let a=e.score;return e.year&&e.year>=t-2&&(a+=.05),{...e,score:a}})).sort(((e,t)=>t.score-e.score))}async postProcessRecommendations(e,t,a){const r=this.applyDiversityBoost(e),s=await this.addPersonalization(r,t);return this.applyFreshnessBoost(s)}async addPersonalization(e,t){const a=await this.getUserPreferences(t);return e.map((e=>{let t=e.score;return a.genres&&e.genres&&(t+=.1*e.genres.filter((e=>a.genres.includes(e))).length),{...e,score:t}})).sort(((e,t)=>t.score-e.score))}async getUserProfile(e){return{getExpectedReward:e=>Math.random(),getTotalPlays:()=>100,getItemPlays:e=>Math.floor(10*Math.random())}}getTimeOfDay(){const e=(new Date).getHours();return 6>e?"night":12>e?"morning":18>e?"afternoon":"evening"}getDayOfWeek(){return(new Date).toLocaleDateString("en-US",{weekday:"long"}).toLowerCase()}getSeason(){const e=(new Date).getMonth();return 3>e?"winter":6>e?"spring":9>e?"summer":"autumn"}async getWeather(){return"sunny"}async getUserMood(e){return"excited"}async getUserInteractionHistory(e){return[{itemId:550,rating:5,timestamp:Date.now()-864e5},{itemId:13,rating:4,timestamp:Date.now()-1728e5},{itemId:680,rating:5,timestamp:Date.now()-2592e5}]}async findSimilarUsers(e,t){return[{id:"user2",similarity:.8},{id:"user3",similarity:.7},{id:"user4",similarity:.6}]}async getUserRatedItems(e){return[{id:550,rating:5},{id:13,rating:4},{id:680,rating:5}]}async buildUserItemMatrix(e){const t=new Map;for(const a of e){const e=await this.getUserRatedItems(a.id);t.set(a.id,e)}return t}dotProduct(e,t){return e.reduce(((e,a,r)=>e+a*t[r]),0)}async extractUserFeatures(e,t){const a=Array(25).fill(0),r=new Map;for(const n of t){const e=await this.getItemDetails(n.itemId);if(e.genres)for(const t of e.genres)r.set(t,(r.get(t)||0)+1)}let s=0;for(const[n,o]of r)15>s&&(a[s]=o,s++);a[15]=t.reduce(((e,t)=>e+t.rating),0)/t.length,a[16]=t.length;const i=t.filter((e=>6048e5>Date.now()-e.timestamp));return a[17]=i.length,a}async extractItemFeatures(e){const t=Array(25).fill(0);if(e.genres)for(let r=0;r<Math.min(e.genres.length,15);r++)t[r]=1;t[15]=e.vote_average||0,t[16]=e.popularity||0;const a=new Date(e.release_date||e.first_air_date).getFullYear();return t[17]=(a-1900)/200,t}async getCandidateItems(e,t){try{const a=await fetch(`https://api.themoviedb.org/3/${e}/popular?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=1`);if(!a.ok)throw Error("HTTP "+a.status);const r=await a.json();return r.results?.slice(0,t)||[]}catch(a){return[]}}async buildUserProfile(e){const t=await this.getUserInteractionHistory(e),a=new Map;for(const r of t){const e=await this.getItemDetails(r.itemId);if(e.genres)for(const t of e.genres){const e=a.get(t)||0;a.set(t,e+r.rating)}}return a}async getItemDetails(e){return{id:e,genres:["Action","Drama"],vote_average:8.5,popularity:100,release_date:"1999-01-01"}}async getUserEmbedding(e){return Array.from({length:50},(()=>Math.random()))}async getItemEmbedding(e){return Array.from({length:50},(()=>Math.random()))}async getFallbackRecommendations(e,t){try{const a=await fetch(`https://api.themoviedb.org/3/${e}/popular?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=1`);if(!a.ok)throw Error("HTTP "+a.status);const r=await a.json();return r.results?.slice(0,t).map((e=>({id:e.id,score:.5})))||[]}catch(a){return[]}}async fetchContentByGenre(e,t,a=1){try{const r=await fetch(`https://api.themoviedb.org/3/discover/${t}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=vote_average.desc&with_genres=${e}&vote_count.gte=100&page=${a}`);if(!r.ok)throw Error(`HTTP ${r.status}: ${r.statusText}`);return(await r.json()).results||[]}catch(r){return[]}}removeDuplicates(e,t={}){const{strategy:a="id",preserveOrder:r=!0,keepBestScore:s=!0}=t;if(!Array.isArray(e)||0===e.length)return[];switch(a){case"strict":return this.removeDuplicatesStrict(e,{preserveOrder:r,keepBestScore:s});case"title":return this.removeDuplicatesByTitle(e,{preserveOrder:r,keepBestScore:s});case"smart":return this.removeDuplicatesSmart(e,{preserveOrder:r,keepBestScore:s});default:return this.removeDuplicatesById(e,{preserveOrder:r,keepBestScore:s})}}removeDuplicatesById(e,t={}){const{keepBestScore:a=!0}=t,r=new Map;return e.filter((e=>{if(!e||!e.id)return!1;if(r.has(e.id)){if(a){const t=r.get(e.id);return(e.similarityScore||0)>(t.similarityScore||0)&&(r.set(e.id,e),!0)}return!1}return r.set(e.id,e),!0}))}removeDuplicatesByTitle(e,t={}){const{keepBestScore:a=!0}=t,r=new Map;return e.filter((e=>{if(!e||!e.title&&!e.name)return!1;const t=(e.title||e.name||"").toLowerCase().trim();if(!t)return!1;if(r.has(t)){if(a){const a=r.get(t);return(e.similarityScore||0)>(a.similarityScore||0)&&(r.set(t,e),!0)}return!1}return r.set(t,e),!0}))}removeDuplicatesStrict(e,t={}){const{keepBestScore:a=!0}=t,r=new Map,s=new Map;return e.filter((e=>{if(!e)return!1;const t=e.id,i=(e.title||e.name||"").toLowerCase().trim(),n=t&&r.has(t),o=i&&s.has(i);if(n||o){if(a){const a=e.similarityScore||0;if(n&&a>(r.get(t).similarityScore||0))return r.set(t,e),i&&s.set(i,e),!0;if(o&&!n&&a>(s.get(i).similarityScore||0))return s.set(i,e),t&&r.set(t,e),!0}return!1}return t&&r.set(t,e),i&&s.set(i,e),!0}))}removeDuplicatesSmart(e,t={}){const{keepBestScore:a=!0,similarityThreshold:r=.9}=t,s=[];for(const i of e)if(i)if(s.some((e=>{if(i.id&&e.id&&i.id===e.id)return!0;const t=(i.title||i.name||"").toLowerCase().trim(),a=(e.title||e.name||"").toLowerCase().trim();return!(!t||!a||t!==a)||!!(t&&a&&this.calculateTitleSimilarity(t,a)>r)}))){if(a){const e=s.findIndex((e=>{if(i.id&&e.id&&i.id===e.id)return!0;const t=(i.title||i.name||"").toLowerCase().trim(),a=(e.title||e.name||"").toLowerCase().trim();return t&&a&&t===a}));if(-1!==e){const t=s[e];(i.similarityScore||0)>(t.similarityScore||0)&&(s[e]=i)}}}else s.push(i);return s}calculateTitleSimilarity(e,t){if(!e||!t)return 0;const a=e.length>t.length?e:t,r=e.length>t.length?t:e;if(0===a.length)return 1;const s=this.levenshteinDistance(a,r);return(a.length-s)/a.length}levenshteinDistance(e,t){const a=Array(t.length+1).fill(null).map((()=>Array(e.length+1).fill(null)));for(let r=0;r<=e.length;r++)a[0][r]=r;for(let r=0;r<=t.length;r++)a[r][0]=r;for(let r=1;r<=t.length;r++)for(let s=1;s<=e.length;s++){const i=e[s-1]===t[r-1]?0:1;a[r][s]=Math.min(a[r][s-1]+1,a[r-1][s]+1,a[r-1][s-1]+i)}return a[t.length][e.length]}async getTrendingSimilarContent(e,t="movie",a={}){const{limit:r=50,timeWindow:s="week"}=a;try{const e=await fetch(`https://api.themoviedb.org/3/trending/${t}/${s}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=1`);return((await e.json()).results||[]).map((e=>{let t=0;e.vote_average&&e.vote_average>=7?t+=.4:e.vote_average&&e.vote_average>=6?t+=.3:t+=.2,e.popularity&&e.popularity>100?t+=.3:e.popularity&&e.popularity>50?t+=.2:t+=.1;const a=new Date(e.release_date||e.first_air_date).getFullYear();return 2020>a?2010>a||(t+=.1):t+=.2,{...e,similarityScore:Math.min(1,Math.max(0,t))}})).sort(((e,t)=>t.similarityScore-e.similarityScore)).slice(0,r)}catch(i){return[]}}async getMoodBasedRecommendations(e,t="movie",a={}){const{limit:r=50,genres:s=[]}=a,i={uplifting:[35,10751],dark:[27,53],romantic:[10749],adventurous:[12,28],thoughtful:[18,9648],funny:[35],scary:[27],action:[28],drama:[18]}[e]||s;if(0===i.length)return[];try{const e=await fetch(`https://api.themoviedb.org/3/discover/${t}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=popularity.desc&with_genres=${i.join(",")}&page=1`),a=await e.json();return a.results?.slice(0,r)||[]}catch(n){return[]}}async getContextualRecommendations(e,t="movie",a={}){const{limit:r=30,timeOfDay:s="evening",season:i="any"}=a;try{let e=[];if("morning"===s?e=await this.getMoodBasedRecommendations("uplifting",t,{limit:Math.ceil(r/2)}):"afternoon"===s?e=await this.getMoodBasedRecommendations("adventurous",t,{limit:Math.ceil(r/2)}):"evening"===s?e=await this.getMoodBasedRecommendations("romantic",t,{limit:Math.ceil(r/2)}):"night"===s&&(e=await this.getMoodBasedRecommendations("dark",t,{limit:Math.ceil(r/2)})),"any"!==i){const a=await this.getSeasonalRecommendations(i,t,{limit:Math.ceil(r/2)});e=[...e,...a]}return this.removeDuplicates(e).slice(0,r)}catch(n){return[]}}async getSeasonalRecommendations(e,t="movie",a={}){const{limit:r=20}=a,s={spring:[10749,35,16],summer:[12,28,10751],autumn:[18,9648,99],winter:[14,878,37],christmas:[10751,35,16],halloween:[27,53,9648]}[e]||[28,12,35],i=[];for(const n of s){const e=await this.fetchContentByGenre(n,t,1);i.push(...e)}return this.removeDuplicates(i).slice(0,r)}async getDiverseRecommendations(e="movie",t={}){const{limit:a=30,includeInternational:r=!0,includeIndie:s=!0,includeClassics:i=!0}=t;try{const t=[];if(r){const r=await this.fetchInternationalContent(e,Math.ceil(a/3));t.push(...r)}if(s){const r=await this.fetchIndieContent(e,Math.ceil(a/3));t.push(...r)}if(i){const r=await this.fetchClassicContent(e,Math.ceil(a/3));t.push(...r)}return this.removeDuplicates(t).slice(0,a)}catch(n){return[]}}async fetchInternationalContent(e,t=10){try{const a=await fetch(`https://api.themoviedb.org/3/discover/${e}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=vote_average.desc&with_original_language=ko,ja,fr,de,es,it&vote_count.gte=50&page=1`);if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);const r=await a.json();return r.results?.slice(0,t)||[]}catch(a){return[]}}async getLanguageSpecificRecommendations(e,t="movie",a={}){const{limit:r=30,quality:s="high"}=a;try{const a={english:"en",spanish:"es",french:"fr",german:"de",italian:"it",portuguese:"pt",russian:"ru",chinese:"zh",japanese:"ja",korean:"ko",hindi:"hi",arabic:"ar",turkish:"tr",dutch:"nl",swedish:"sv",norwegian:"no",danish:"da",finnish:"fi",polish:"pl",czech:"cs",hungarian:"hu",romanian:"ro",bulgarian:"bg",greek:"el",hebrew:"he",thai:"th",vietnamese:"vi",indonesian:"id",malay:"ms",filipino:"tl"}[e.toLowerCase()]||e;let i=new URLSearchParams({api_key:"92b98feaab02d1088661e456c19edb89",language:"en-US",sort_by:"vote_average.desc",with_original_language:a,page:"1"});"high"===s?(i.append("vote_count.gte","100"),i.append("vote_average.gte","7.0")):"medium"===s&&(i.append("vote_count.gte","50"),i.append("vote_average.gte","6.0"));const n=await fetch(`https://api.themoviedb.org/3/discover/${t}?api_key=92b98feaab02d1088661e456c19edb89&${i.toString()}`);if(!n.ok)throw Error(`HTTP ${n.status}: ${n.statusText}`);const o=await n.json();return o.results?.slice(0,r)||[]}catch(i){return[]}}async getRegionSpecificRecommendations(e,t="movie",a={}){const{limit:r=30}=a;try{const a={"north-america":["US","CA","MX"],europe:["GB","FR","DE","IT","ES","NL","SE","NO","DK","FI","PL","CZ","HU","RO","BG","GR"],asia:["JP","KR","CN","IN","TH","VN","ID","MY","PH","SG","TW","HK"],"latin-america":["BR","AR","CL","CO","PE","VE","MX"],"middle-east":["TR","IL","AE","SA","EG","IR"],africa:["ZA","NG","EG","KE","GH"],oceania:["AU","NZ"],"eastern-europe":["RU","UA","BY","MD","GE","AM","AZ"],scandinavia:["SE","NO","DK","FI","IS"],balkans:["RS","HR","SI","BA","ME","MK","AL"],baltic:["EE","LV","LT"],benelux:["BE","NL","LU"],iberia:["ES","PT"],"central-europe":["DE","AT","CH","LI"],mediterranean:["IT","GR","CY","MT"]}[e.toLowerCase()]||[e],i=[];for(const e of a.slice(0,3))try{const a=await fetch(`https://api.themoviedb.org/3/discover/${t}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=vote_average.desc&with_origin_country=${e}&vote_count.gte=20&page=1`);if(a.ok){const e=await a.json();i.push(...e.results||[])}}catch(s){}return this.removeDuplicates(i).slice(0,r)}catch(s){return[]}}async getCulturalRecommendations(e,t="movie",a={}){const{limit:r=30,useRegionalVariants:s=!0}=a,i={bollywood:{language:"hi",region:"asia",genres:[10749,35,18],countries:["IN"],variants:["indian-cinema","hindi-films"]},"korean-wave":{language:"ko",region:"asia",genres:[18,10749,35],countries:["KR"],variants:["k-drama","korean-cinema"]},anime:{language:"ja",region:"asia",genres:[16,878,14],countries:["JP"],variants:["japanese-animation","manga-adaptation"]},"chinese-cinema":{language:"zh",region:"asia",genres:[28,18,14],countries:["CN","HK","TW"],variants:["wuxia","chinese-drama"]},"japanese-cinema":{language:"ja",region:"asia",genres:[18,53,27],countries:["JP"],variants:["japanese-drama","samurai-films"]},"thai-cinema":{language:"th",region:"asia",genres:[35,18,10749],countries:["TH"],variants:["thai-drama","thai-comedy"]},"vietnamese-cinema":{language:"vi",region:"asia",genres:[18,10749,35],countries:["VN"],variants:["vietnamese-drama"]},"european-arthouse":{language:"fr",region:"europe",genres:[18,9648,99],countries:["FR","DE","IT"],variants:["art-house","experimental"]},"scandinavian-noir":{language:"sv",region:"scandinavia",genres:[53,9648,18],countries:["SE","NO","DK"],variants:["nordic-noir","scandinavian-crime"]},"french-new-wave":{language:"fr",region:"europe",genres:[18,9648,35],countries:["FR"],variants:["nouvelle-vague","french-cinema"]},"italian-neorealism":{language:"it",region:"europe",genres:[18,36,99],countries:["IT"],variants:["neorealismo","italian-cinema"]},"german-expressionism":{language:"de",region:"europe",genres:[27,53,18],countries:["DE"],variants:["expressionist","german-cinema"]},"british-cinema":{language:"en",region:"europe",genres:[18,35,36],countries:["GB"],variants:["british-drama","british-comedy"]},"spanish-cinema":{language:"es",region:"europe",genres:[18,35,10749],countries:["ES"],variants:["spanish-drama","spanish-comedy"]},telenovelas:{language:"es",region:"latin-america",genres:[10749,18,35],countries:["MX","BR","AR"],variants:["soap-opera","latin-drama"]},"brazilian-cinema":{language:"pt",region:"latin-america",genres:[18,35,10749],countries:["BR"],variants:["brazilian-drama","brazilian-comedy"]},"mexican-cinema":{language:"es",region:"latin-america",genres:[18,35,27],countries:["MX"],variants:["mexican-drama","mexican-horror"]},"argentine-cinema":{language:"es",region:"latin-america",genres:[18,9648,35],countries:["AR"],variants:["argentine-drama","argentine-comedy"]},"turkish-drama":{language:"tr",region:"middle-east",genres:[18,10749,35],countries:["TR"],variants:["turkish-soap","turkish-drama"]},"iranian-cinema":{language:"fa",region:"middle-east",genres:[18,9648,99],countries:["IR"],variants:["iranian-drama","iranian-art-house"]},"israeli-cinema":{language:"he",region:"middle-east",genres:[18,35,53],countries:["IL"],variants:["israeli-drama","israeli-comedy"]},nollywood:{language:"en",region:"africa",genres:[18,35,10749],countries:["NG"],variants:["nigerian-cinema","african-drama"]},"south-african-cinema":{language:"en",region:"africa",genres:[18,35,53],countries:["ZA"],variants:["south-african-drama"]},"egyptian-cinema":{language:"ar",region:"africa",genres:[18,35,10749],countries:["EG"],variants:["egyptian-drama","egyptian-comedy"]},"american-indie":{language:"en",region:"north-america",genres:[18,35,9648],countries:["US"],variants:["independent-film","indie-drama"]},"canadian-cinema":{language:"en",region:"north-america",genres:[18,35,99],countries:["CA"],variants:["canadian-drama","canadian-comedy"]},"australian-cinema":{language:"en",region:"oceania",genres:[18,35,53],countries:["AU"],variants:["australian-drama","australian-comedy"]},"new-zealand-cinema":{language:"en",region:"oceania",genres:[18,35,12],countries:["NZ"],variants:["new-zealand-drama"]}}[e.toLowerCase()];if(!i)return[];try{const e=[],a=await this.getLanguageSpecificRecommendations(i.language,t,{limit:Math.ceil(r/2),quality:"high",includeSubtitles:!0});e.push(...a);const o=await this.getRegionSpecificRecommendations(i.region,t,{limit:Math.ceil(r/2),includeLocalProductions:!0,includeCoProductions:!0});if(e.push(...o),i.countries&&i.countries.length>0)for(const s of i.countries.slice(0,2))try{const a=await this.fetchContentByCountry(s,t,Math.ceil(r/4));e.push(...a)}catch(n){}if(i.genres&&i.genres.length>0)for(const r of i.genres.slice(0,2))try{const a=await this.fetchContentByGenre(r,t,1);e.push(...a)}catch(n){}if(s&&i.variants)for(const s of i.variants.slice(0,2))try{const a=await this.getCulturalVariantRecommendations(s,t,Math.ceil(r/6));e.push(...a)}catch(n){}return this.removeDuplicates(e).slice(0,r)}catch(n){return[]}}async fetchIndieContent(e,t=10){try{const a=await fetch(`https://api.themoviedb.org/3/discover/${e}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=vote_average.desc&vote_count.gte=10&vote_count.lte=1000&page=1`);if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);const r=await a.json();return r.results?.slice(0,t)||[]}catch(a){return[]}}async fetchClassicContent(e,t=10){try{const a=await fetch(`https://api.themoviedb.org/3/discover/${e}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=vote_average.desc&primary_release_date.gte=1950-01-01&primary_release_date.lte=1990-12-31&vote_count.gte=100&page=1`);if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);const r=await a.json();return r.results?.slice(0,t)||[]}catch(a){return[]}}async getCharacteristicBasedRecommendations(e,t="movie",a={}){const{limit:r=50,minRating:s=0,maxYear:i=(new Date).getFullYear(),minYear:n=1900}=a,o=new URLSearchParams({api_key:"92b98feaab02d1088661e456c19edb89",language:"en-US",sort_by:"popularity.desc","vote_average.gte":s,"primary_release_date.gte":n+"-01-01","primary_release_date.lte":i+"-12-31",page:"1"});e.genres&&e.genres.length>0&&o.append("with_genres",e.genres.join(",")),e.cast&&e.cast.length>0&&o.append("with_cast",e.cast.join(",")),e.crew&&e.crew.length>0&&o.append("with_crew",e.crew.join(","));try{const e=await fetch(`https://api.themoviedb.org/3/discover/${t}?api_key=92b98feaab02d1088661e456c19edb89&${o.toString()}`),a=await e.json();return a.results?.slice(0,r)||[]}catch(c){return[]}}async getFranchiseBasedRecommendations(e,t="movie",a={}){const{limit:r=30,includeRelatedFranchises:s=!0}=a;try{const a=await fetch(`https://api.themoviedb.org/3/collection/${e}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);const i=await a.json();let n=[...i.parts||[]];if(s){const e=await this.getRelatedFranchises(i.name,t,r);n=[...n,...e]}return this.removeDuplicates(n).slice(0,r)}catch(i){return[]}}async getRelatedFranchises(e,t="movie",a=20){try{const t=await fetch(`https://api.themoviedb.org/3/search/collection?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&query=${encodeURIComponent(e)}&page=1`);if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`);const s=(await t.json()).results||[],i=[];for(const e of s.slice(0,3))try{const t=await fetch(`https://api.themoviedb.org/3/collection/${e.id}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(t.ok){const e=await t.json();i.push(...e.parts||[])}}catch(r){}return i.slice(0,a)}catch(r){return[]}}async getActorBasedRecommendations(e,t="movie",a={}){const{limit:r=30,includeCoStars:s=!0,includeSimilarActors:i=!0}=a;try{const a=await fetch(`https://api.themoviedb.org/3/person/${e}/combined_credits?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);let n=[...(await a.json()).cast||[]];if(s){const a=await this.getCoStarRecommendations(e,t,r);n=[...n,...a]}if(i){const a=await this.getSimilarActorRecommendations(e,t,r);n=[...n,...a]}return this.removeDuplicates(n).slice(0,r)}catch(n){return[]}}async getCoStarRecommendations(e,t="movie",a=15){try{const s=await fetch(`https://api.themoviedb.org/3/person/${e}/combined_credits?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(!s.ok)throw Error(`HTTP ${s.status}: ${s.statusText}`);const i=(await s.json()).cast||[],n=new Set;for(const a of i.slice(0,5))try{const r=await fetch(`https://api.themoviedb.org/3/${t}/${a.id}/credits?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(r.ok){((await r.json()).cast||[]).forEach((t=>{t.id!==e&&n.add(t.id)}))}}catch(r){}const o=[];for(const e of Array.from(n).slice(0,3))try{const t=await fetch(`https://api.themoviedb.org/3/person/${e}/combined_credits?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(t.ok){const e=await t.json();o.push(...e.cast||[])}}catch(r){}return o.slice(0,a)}catch(r){return[]}}async getSimilarActorRecommendations(e,t="movie",a=15){try{const t=await fetch(`https://api.themoviedb.org/3/person/${e}/similar?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=1`);if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`);const s=(await t.json()).results||[],i=[];for(const e of s.slice(0,3))try{const t=await fetch(`https://api.themoviedb.org/3/person/${e.id}/combined_credits?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(t.ok){const e=await t.json();i.push(...e.cast||[])}}catch(r){}return i.slice(0,a)}catch(r){return[]}}async getDirectorBasedRecommendations(e,t="movie",a={}){const{limit:r=30,includeSimilarDirectors:s=!0}=a;try{const a=await fetch(`https://api.themoviedb.org/3/person/${e}/combined_credits?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);const i=await a.json();let n=[...i.crew?.filter((e=>"Director"===e.job))||[]];if(s){const a=await this.getSimilarDirectorRecommendations(e,t,r);n=[...n,...a]}return this.removeDuplicates(n).slice(0,r)}catch(i){return[]}}async getSimilarDirectorRecommendations(e,t="movie",a=15){try{const t=await fetch(`https://api.themoviedb.org/3/person/${e}/similar?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&page=1`);if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`);const s=(await t.json()).results||[],i=[];for(const e of s.slice(0,3))try{const t=await fetch(`https://api.themoviedb.org/3/person/${e.id}/combined_credits?api_key=92b98feaab02d1088661e456c19edb89&language=en-US`);if(t.ok){const e=await t.json(),a=e.crew?.filter((e=>"Director"===e.job))||[];i.push(...a)}}catch(r){}return i.slice(0,a)}catch(r){return[]}}clearCache(e,t="movie"){const a=`enhanced_similar_${t}_${e}`;this.cache.delete(a);for(let r=1;5>=r;r++){const a=`enhanced_similar_${t}_${e}_${r}`;this.cache.delete(a)}}clearAllSimilarContentCache(){this.cache.getKeys().forEach((e=>{e.includes("enhanced_similar_")&&this.cache.delete(e)}))}performMemoryCleanup(){const e=Date.now();if(e-this.lastCleanup>=this.cleanupInterval){if(this.lastCleanup=e,this.cache&&this.cache.getKeys){const e=this.cache.getKeys();e.length>this.maxCacheSize&&e.slice(0,e.length-this.maxCacheSize).forEach((e=>this.cache.delete(e)))}this.userProfiles.size>500&&this.userProfiles.clear(),this.contentProfiles.size>1e3&&this.contentProfiles.clear(),this.interactionMatrix.size>500&&this.interactionMatrix.clear(),this.userCulturalPreferences.size>200&&this.userCulturalPreferences.clear(),this.regionalContentBoost.size>100&&this.regionalContentBoost.clear(),this.languageContentBoost.size>100&&this.languageContentBoost.clear(),window.gc&&window.gc()}}getCacheStats(){return this.cache.getStats()}getRegionalLanguageBoost(e,t){return({"north-america":{en:.3,es:.2,fr:.1},europe:{en:.2,fr:.3,de:.25,es:.2,it:.2},asia:{ja:.4,ko:.35,zh:.3,hi:.25,th:.2},"latin-america":{es:.4,pt:.3,en:.15},"middle-east":{ar:.4,tr:.3,he:.25,en:.15},africa:{en:.3,fr:.25,ar:.2},oceania:{en:.4,ma:.2}}[t]||{})[e]||0}isContentFromRegion(e,t){if(!e.production_countries)return!1;const a={"north-america":["US","CA","MX"],europe:["GB","FR","DE","IT","ES","NL","SE","NO","DK","FI","PL","CZ","HU","RO","BG","GR"],asia:["JP","KR","CN","IN","TH","VN","ID","MY","PH","SG","TW","HK"],"latin-america":["BR","AR","CL","CO","PE","VE","MX"],"middle-east":["TR","IL","AE","SA","EG","IR"],africa:["ZA","NG","EG","KE","GH"],oceania:["AU","NZ"]}[t]||[];return e.production_countries.some((e=>a.includes("object"==typeof e?e.iso_3166_1:e)))}calculateCulturalAffinity(e,t,a){const r={"north-america":{action:.3,comedy:.25,drama:.2,family:.2,western:.15,"sci-fi":.2,horror:.15},europe:{drama:.3,comedy:.25,romance:.2,thriller:.2,historical:.25,"art-house":.3,documentary:.25},asia:{action:.3,drama:.3,romance:.25,horror:.2,"martial-arts":.35,anime:.4,thriller:.25},"latin-america":{drama:.3,romance:.3,comedy:.25,thriller:.2,telenovela:.4,family:.2},"middle-east":{drama:.35,thriller:.25,romance:.2,historical:.25,religious:.3,family:.2},africa:{drama:.35,comedy:.25,family:.2,documentary:.25,historical:.25,romance:.2},oceania:{drama:.25,comedy:.3,adventure:.25,family:.2,documentary:.25,thriller:.2}}[a]||{};let s=0;if(e.genres)for(const i of e.genres)s+=r[("object"==typeof i?i.name:i).toLowerCase()]||0;if(t.genres)for(const i of t.genres)s+=r[("object"==typeof i?i.name:i).toLowerCase()]||0;return Math.min(.5,s/2)}calculateCulturalContentSimilarity(e,t,a){const r={bollywood:["musical","romance","family","drama"],"korean-wave":["drama","romance","thriller","comedy"],anime:["animation","fantasy","sci-fi","adventure"],nollywood:["drama","comedy","family","romance"],telenovelas:["romance","drama","family","soap"],"european-arthouse":["drama","art-house","experimental","documentary"],"scandinavian-noir":["thriller","crime","drama","mystery"],"chinese-wuxia":["action","fantasy","martial-arts","historical"],"japanese-samurai":["action","historical","drama","martial-arts"],"korean-thrillers":["thriller","crime","drama","mystery"]},s=e=>{if(!e.genres)return"general";const t=e.genres.map((e=>"object"==typeof e?e.name.toLowerCase():e.toLowerCase()));for(const[a,s]of Object.entries(r))if(s.some((e=>t.some((t=>t.includes(e))))))return a;return"general"},i=s(e);return i===s(t)&&"general"!==i?.3:0}async detectUserCulturalPreferences(e){const t=await this.getUserInteractionHistory(e),a={preferredLanguages:new Map,preferredRegions:new Map,culturalContentTypes:new Map};for(const r of t){const e=await this.getItemDetails(r.itemId);if(e.original_language){const t=a.preferredLanguages.get(e.original_language)||0;a.preferredLanguages.set(e.original_language,t+r.rating)}if(e.production_countries)for(const s of e.production_countries){const e="object"==typeof s?s.iso_3166_1:s,t=this.getRegionFromCountry(e);if(t){const e=a.preferredRegions.get(t)||0;a.preferredRegions.set(t,e+r.rating)}}const t=this.getCulturalContentType(e);if(t){const e=a.culturalContentTypes.get(t)||0;a.culturalContentTypes.set(t,e+r.rating)}}return this.userCulturalPreferences.set(e,a),a}getRegionFromCountry(e){return{US:"north-america",CA:"north-america",MX:"north-america",GB:"europe",FR:"europe",DE:"europe",IT:"europe",ES:"europe",JP:"asia",KR:"asia",CN:"asia",IN:"asia",TH:"asia",BR:"latin-america",AR:"latin-america",CL:"latin-america",TR:"middle-east",IL:"middle-east",AE:"middle-east",ZA:"africa",NG:"africa",EG:"africa",AU:"oceania",NZ:"oceania"}[e]||null}getCulturalContentType(e){if(!e.genres)return null;const t=e.genres.map((e=>"object"==typeof e?e.name.toLowerCase():e.toLowerCase()));return t.some((e=>e.includes("musical")))&&"hi"===e.original_language?"bollywood":t.some((e=>e.includes("drama")))&&"ko"===e.original_language?"korean-wave":t.some((e=>e.includes("animation")))&&"ja"===e.original_language?"anime":t.some((e=>e.includes("drama")))&&"es"===e.original_language?"telenovelas":null}async culturalRecommendation(e,t="movie",a={}){const{limit:r=50,useUserPreferences:s=!0,includeRegionalContent:i=!0,includeLanguageSpecific:n=!0}=a;try{const a=s?await this.detectUserCulturalPreferences(e):null,o=[];if(n&&a){const e=Array.from(a.preferredLanguages.entries()).sort(((e,t)=>t[1]-e[1])).slice(0,3).map((([e])=>e));for(const a of e){const e=await this.getLanguageSpecificRecommendations(a,t,{limit:Math.ceil(r/3)});o.push(...e)}}if(i&&a){const e=Array.from(a.preferredRegions.entries()).sort(((e,t)=>t[1]-e[1])).slice(0,3).map((([e])=>e));for(const a of e){const e=await this.getRegionSpecificRecommendations(a,t,{limit:Math.ceil(r/3)});o.push(...e)}}if(a){const e=Array.from(a.culturalContentTypes.entries()).sort(((e,t)=>t[1]-e[1])).slice(0,2).map((([e])=>e));for(const t of e){const e=await this.getCulturalRecommendations(t,t,{limit:Math.ceil(r/4)});o.push(...e)}}return this.removeDuplicates(o).slice(0,r)}catch(o){return this.getFallbackRecommendations(t,r)}}applyCulturalDiversityBoost(e,t){const a=[],r=new Set,s=new Set,i=new Set;for(const n of e){let e=n.similarityScore||n.score||0;if(n.original_language&&!r.has(n.original_language)&&(e+=t.preferences.preferredLanguages.has(n.original_language)?.1:.05,r.add(n.original_language)),n.production_countries&&n.production_countries.length>0){const a="object"==typeof n.production_countries[0]?n.production_countries[0].iso_3166_1:n.production_countries[0],r=this.getRegionFromCountry(a);r&&!s.has(r)&&(e+=t.preferences.preferredRegions.has(r)?.08:.03,s.add(r))}if(n.genres){const t=n.genres.filter((e=>{const t="object"==typeof e?e.name:e;return!i.has(t)}));t.length>0&&(e+=.03*t.length,t.forEach((e=>{const t="object"==typeof e?e.name:e;i.add(t)})))}a.push({...n,similarityScore:e})}return a.sort(((e,t)=>(t.similarityScore||t.score)-(e.similarityScore||e.score)))}async fetchContentByCountry(e,t,a=10){try{const r=await fetch(`https://api.themoviedb.org/3/discover/${t}?api_key=92b98feaab02d1088661e456c19edb89&language=en-US&sort_by=vote_average.desc&with_origin_country=${e}&vote_count.gte=20&page=1`);if(!r.ok)throw Error(`HTTP ${r.status}: ${r.statusText}`);const s=await r.json();return s.results?.slice(0,a)||[]}catch(r){return[]}}async getCulturalVariantRecommendations(e,t,a=10){return[]}},Zt={getSimilarContent:(e,t,a)=>Kt.getEnhancedSimilarContent(e,t,a),getPersonalizedRecommendations:(e,t,a)=>Kt.getPersonalizedRecommendations(e,t,a),getHybridRecommendations:(e,t,a)=>Kt.hybridRecommendation(e,t,a),getCollaborativeRecommendations:(e,t,a)=>Kt.collaborativeFiltering(e,t,a),getContentBasedRecommendations:(e,t,a)=>Kt.contentBasedFiltering(e,t,a),getDeepLearningRecommendations:(e,t,a)=>Kt.deepLearningRecommendation(e,t,a),getReinforcementLearningRecommendations:(e,t,a)=>Kt.reinforcementLearningRecommendation(e,t,a),getContextualRecommendations:(e,t,a)=>Kt.contextualRecommendation(e,t,a),getTrendingSimilar:(e,t,a)=>Kt.getTrendingSimilarContent(e,t,a),getMoodBasedRecommendations:(e,t,a)=>Kt.getMoodBasedRecommendations(e,t,a),getContextualRecommendations:(e,t,a)=>Kt.getContextualRecommendations(e,t,a),getSeasonalRecommendations:(e,t,a)=>Kt.getSeasonalRecommendations(e,t,a),getDiverseRecommendations:(e,t)=>Kt.getDiverseRecommendations(e,t),getLanguageSpecificRecommendations:(e,t,a)=>Kt.getLanguageSpecificRecommendations(e,t,a),getRegionSpecificRecommendations:(e,t,a)=>Kt.getRegionSpecificRecommendations(e,t,a),getCulturalRecommendations:(e,t,a)=>Kt.getCulturalRecommendations(e,t,a),getCharacteristicBasedRecommendations:(e,t,a)=>Kt.getCharacteristicBasedRecommendations(e,t,a),getFranchiseBasedRecommendations:(e,t,a)=>Kt.getFranchiseBasedRecommendations(e,t,a),getActorBasedRecommendations:(e,t,a)=>Kt.getActorBasedRecommendations(e,t,a),getDirectorBasedRecommendations:(e,t,a)=>Kt.getDirectorBasedRecommendations(e,t,a),getUserPreferences:e=>Kt.getUserPreferences(e),clearCache:(e,t)=>Kt.clearCache(e,t),clearAllSimilarContentCache:()=>Kt.clearAllSimilarContentCache(),getCacheStats:()=>Kt.getCacheStats(),removeDuplicates:(e,t)=>Kt.removeDuplicates(e,t),removeDuplicatesById:(e,t)=>Kt.removeDuplicatesById(e,t),removeDuplicatesByTitle:(e,t)=>Kt.removeDuplicatesByTitle(e,t),removeDuplicatesStrict:(e,t)=>Kt.removeDuplicatesStrict(e,t),removeDuplicatesSmart:(e,t)=>Kt.removeDuplicatesSmart(e,t)};export{ae as $,Je as A,h as B,p as C,Ke as D,m as E,st as F,Jt as G,Zt as H,Ee as I,dt as J,ze as K,pt as L,pe as M,de as N,ge as O,le as P,ce as Q,oe as R,ne as S,te as T,ee as U,K as V,G as W,Q as X,ie as Y,se as Z,re as _,Fe as a,J as a0,fe as a1,Pe as a2,me as a3,ct as a4,ue as a5,Z as a6,we as a7,O as a8,L as a9,H as aa,Le as ab,$t as ac,Nt as ad,Ve as ae,Re as af,Ue as b,ke as c,He as d,Se as e,V as f,We as g,B as h,q as i,W as j,at as k,ve as l,tt as m,rt as n,_e as o,it as p,y as q,he as r,Ne as s,ye as t,je as u,Ce as v,lt as w,kt as x,Mt as y,Ht as z};
